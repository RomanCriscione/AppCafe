{# templates/reviews/includes/mapa_cafe_list.html #}

<!-- Mapa + chips -->
<div class="relative mb-6">
  <!-- Chips -->
  <div class="absolute top-3 left-3 right-3 z-10 flex gap-2 overflow-x-auto no-scrollbar">
    <button type="button" class="chip" data-filter="nearby" aria-pressed="false">üìç Cerca m√≠o</button>
    <button type="button" class="chip" data-filter="has_wifi" aria-pressed="false">Wi-Fi</button>
    <button type="button" class="chip" data-filter="is_pet_friendly" aria-pressed="false">Pet-friendly</button>
    <button type="button" class="chip" data-filter="has_outdoor_seating" aria-pressed="false">Exterior</button>
  </div>

  <!-- Mapa -->
  <div id="cafes-map" class="map-container h-72"></div>
</div>

<!-- Formulario de b√∫squeda por direcci√≥n -->
<form id="direccion-form" method="get" class="mb-4 flex gap-2 max-w-md">
  <input type="text" id="direccion" name="direccion" placeholder="Buscar caf√©s cerca de una direcci√≥n"
         class="flex-1 px-3 py-2 border rounded w-full text-sm" required>
  <button type="submit" class="btn btn-primary text-sm">Buscar</button>
</form>
<div id="error-direccion" class="text-red-600 text-sm mb-4 hidden">‚ùó Direcci√≥n no encontrada</div>

<!-- Lista de caf√©s -->
{% if cafes %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for cafe in cafes %}
      {% include "reviews/_cafe_card.html" %}
    {% endfor %}
  </div>
{% else %}
  <div class="text-center text-lg text-gray-600 mt-8 space-y-4">
    <p class="text-gray-600 text-center mt-4">
      ‚òï {{ ui_messages.search_no_results }}
    </p>
    <a href="{% url 'cafe_list' %}" class="btn btn-secondary">Limpiar filtros</a>
  </div>
{% endif %}

<script>
(function () {
  if (window.__cafesMapInited) return;
  window.__cafesMapInited = true;

  function waitForLeaflet(cb, tries = 0) {
    if (window.L && typeof L.map === "function") return cb();
    if (tries > 200) return;
    setTimeout(() => waitForLeaflet(cb, tries + 1), 50);
  }

  document.addEventListener("DOMContentLoaded", function () {
    // ==== Chips ====
    (function () {
      const params = new URLSearchParams(location.search);

      document.querySelectorAll('[data-filter]').forEach(chip => {
        const key = chip.getAttribute('data-filter');

        if (key === 'nearby') {
          const hasCoords = params.has('lat') && params.has('lon');
          if (hasCoords) { chip.classList.add('active'); chip.setAttribute('aria-pressed', 'true'); }
          chip.addEventListener('click', function (e) {
            e.preventDefault();
            if (!navigator.geolocation) {
              const u = new URL(location.href);
              u.searchParams.delete('lat'); u.searchParams.delete('lon'); u.searchParams.delete('page');
              location.href = u.toString(); return;
            }
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                const u = new URL(location.href);
                u.searchParams.set('lat', pos.coords.latitude.toFixed(6));
                u.searchParams.set('lon', pos.coords.longitude.toFixed(6));
                if (!u.searchParams.get('orden')) u.searchParams.set('orden', 'algoritmo');
                u.searchParams.delete('page'); location.href = u.toString();
              },
              () => {
                const u = new URL(location.href);
                u.searchParams.delete('lat'); u.searchParams.delete('lon'); u.searchParams.delete('page');
                location.href = u.toString();
              },
              { timeout: 5000, maximumAge: 60000 }
            );
          });
          return;
        }

        const isOn = params.has(key) && params.get(key) !== '0';
        if (isOn) { chip.classList.add('active'); chip.setAttribute('aria-pressed', 'true'); }
        chip.addEventListener('click', () => {
          const u = new URL(location.href);
          if (u.searchParams.has(key)) { u.searchParams.delete(key); } else { u.searchParams.set(key, '1'); }
          u.searchParams.delete('page'); location.href = u.toString();
        });
      });
    })();

    // ==== Leaflet map ====
    waitForLeaflet(() => {
      const mapEl = document.getElementById('cafes-map');
      if (!mapEl) return;

      const map = L.map('cafes-map').setView([-34.6037, -58.3816], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      setTimeout(() => map.invalidateSize(), 0);
      window.addEventListener('resize', () => map.invalidateSize());

      {% if cafes_json %}
        const cafes = JSON.parse(`{{ cafes_json|escapejs }}`);
      {% else %}
        const cafes = [
          {% for cafe in cafes %}
            { id: {{ cafe.id }}, name: "{{ cafe.name|escapejs }}", latitude: {{ cafe.latitude|default:"null" }}, longitude: {{ cafe.longitude|default:"null" }}, url: "{% url 'cafe_detail' cafe.id %}" }
            {% if not forloop.last %},{% endif %}
          {% endfor %}
        ];
      {% endif %}

      cafes.forEach(cafe => {
        if (cafe.latitude != null && cafe.longitude != null) {
          const marker = L.marker([cafe.latitude, cafe.longitude]).addTo(map);
          marker.bindPopup(`<strong>${cafe.name}</strong><br><a href="${cafe.url}">Ver detalle</a>`);
        }
      });

      const urlParams = new URLSearchParams(location.search);
      const lat = urlParams.get("lat");
      const lon = urlParams.get("lon");

      if (lat && lon) {
        const userLat = parseFloat(lat);
        const userLon = parseFloat(lon);

        const cafesCercanos = cafes.filter(cafe =>
          cafe.latitude != null && cafe.longitude != null &&
          Math.sqrt(
            Math.pow((cafe.latitude - userLat) * 111, 2) +
            Math.pow((cafe.longitude - userLon) * 85, 2)
          ) <= 3
        );

        L.circle([userLat, userLon], {
          radius: 3000,
          color: cafesCercanos.length > 10 ? "#e76f51" : "#2a9d8f",
          fillColor: cafesCercanos.length > 10 ? "#f4a261" : "#a8dadc",
          fillOpacity: 0.3
        }).addTo(map);

        map.setView([userLat, userLon], 13);
      }

      const dirForm = document.getElementById("direccion-form");
      if (dirForm) {
        dirForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          const direccion = document.getElementById("direccion").value;
          const errorDiv = document.getElementById("error-direccion");
          errorDiv.classList.add("hidden");

          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}`;
          try {
            const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
            const data = await response.json();
            if (Array.isArray(data) && data.length > 0) {
              const lat = data[0].lat;
              const lon = data[0].lon;

              const form = document.createElement("form");
              form.method = "GET";
              form.action = window.location.pathname;

              const latInput = document.createElement("input");
              latInput.type = "hidden"; latInput.name = "lat"; latInput.value = lat; form.appendChild(latInput);

              const lonInput = document.createElement("input");
              lonInput.type = "hidden"; lonInput.name = "lon"; lonInput.value = lon; form.appendChild(lonInput);

              document.body.appendChild(form);
              form.submit();
            } else {
              errorDiv.classList.remove("hidden");
            }
          } catch (error) {
            console.error("Error al buscar la direcci√≥n:", error);
            document.getElementById("error-direccion").classList.remove("hidden");
          }
        });
      }

      const ubicacionForm = document.getElementById("ubicacion-form");
      if (ubicacionForm) {
        ubicacionForm.addEventListener("submit", function (event) {
          event.preventDefault();
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
              document.getElementById("lat").value = position.coords.latitude;
              document.getElementById("lon").value = position.coords.longitude;
              ubicacionForm.submit();
            }, function () {
              alert("No se pudo obtener tu ubicaci√≥n. Habilit√° la geolocalizaci√≥n.");
            });
          } else {
            alert("Tu navegador no soporta geolocalizaci√≥n.");
          }
        });
      }
    });
  });
})();
</script>
