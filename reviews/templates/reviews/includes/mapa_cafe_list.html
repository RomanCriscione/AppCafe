<!-- Mapa -->
<div id="cafes-map" class="h-72 min-h-[300px] rounded mb-6"></div>

<!-- Formulario de b√∫squeda por direcci√≥n -->
<form id="direccion-form" method="get" class="mb-4 flex gap-2 max-w-md">
  <input type="text" id="direccion" name="direccion" placeholder="Buscar caf√©s cerca de una direcci√≥n"
         class="flex-1 px-3 py-2 border rounded w-full text-sm" required>
  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition">
    Buscar
  </button>
</form>
<div id="error-direccion" class="text-red-600 text-sm mb-4 hidden">‚ùó Direcci√≥n no encontrada</div>

<!-- Lista de caf√©s -->
{% if cafes %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for cafe in cafes %}
      {% include "reviews/_cafe_card.html" %}
    {% endfor %}
  </div>
{% else %}
  <div class="text-center text-lg text-gray-600 mt-8 space-y-4">
    <p class="text-gray-600 text-center mt-4">
      ‚òï {{ ui_messages.search_no_results }}
    </p>
    <a href="{% url 'cafe_list' %}" class="inline-block bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400 transition-colors">
      Limpiar filtros
    </a>
  </div>
{% endif %}

<script>
(function () {
  // Evita doble init
  if (window.__cafesMapInited) return;
  window.__cafesMapInited = true;

  function waitForLeaflet(cb, tries = 0) {
    if (window.L && typeof L.map === "function") return cb();
    if (tries > 200) return; // 10s guard
    setTimeout(() => waitForLeaflet(cb, tries + 1), 50);
  }

  document.addEventListener("DOMContentLoaded", function () {
    waitForLeaflet(() => {
      const mapEl = document.getElementById('cafes-map');
      if (!mapEl) return;

      const map = L.map('cafes-map').setView([-34.6037, -58.3816], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // üëá fuerza recalcular tama√±o al terminar el frame y en resize
      setTimeout(() => map.invalidateSize(), 0);
      window.addEventListener('resize', () => map.invalidateSize());

      // ---- Datos de caf√©s ----
      {% if cafes_json %}
        const cafes = JSON.parse(`{{ cafes_json|escapejs }}`);
      {% else %}
        const cafes = [
          {% for cafe in cafes %}
            {
              id: {{ cafe.id }},
              name: "{{ cafe.name|escapejs }}",
              latitude: {{ cafe.latitude|default:"null" }},
              longitude: {{ cafe.longitude|default:"null" }},
              url: "{% url 'cafe_detail' cafe.id %}"
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ];
      {% endif %}

      cafes.forEach(cafe => {
        if (cafe.latitude != null && cafe.longitude != null) {
          const marker = L.marker([cafe.latitude, cafe.longitude]).addTo(map);
          marker.bindPopup(`<strong>${cafe.name}</strong><br><a href="${cafe.url}">Ver detalle</a>`);
        }
      });

      // ---- Ubicaci√≥n pasada por querystring (lat/lon) ----
      const urlParams = new URLSearchParams(window.location.search);
      const lat = urlParams.get("lat");
      const lon = urlParams.get("lon");

      if (lat && lon) {
        const userLat = parseFloat(lat);
        const userLon = parseFloat(lon);

        const cafesCercanos = cafes.filter(cafe =>
          cafe.latitude != null && cafe.longitude != null &&
          Math.sqrt(
            Math.pow((cafe.latitude - userLat) * 111, 2) +
            Math.pow((cafe.longitude - userLon) * 85, 2)
          ) <= 3
        );

        L.circle([userLat, userLon], {
          radius: 3000,
          color: cafesCercanos.length > 10 ? "#e76f51" : "#2a9d8f",
          fillColor: cafesCercanos.length > 10 ? "#f4a261" : "#a8dadc",
          fillOpacity: 0.3
        }).addTo(map);

        map.setView([userLat, userLon], 13);
      }

      // ---- Buscar por direcci√≥n (Nominatim) ----
      const dirForm = document.getElementById("direccion-form");
      dirForm?.addEventListener("submit", async function (e) {
        e.preventDefault();
        const direccion = document.getElementById("direccion").value;
        const errorDiv = document.getElementById("error-direccion");
        errorDiv.classList.add("hidden");

        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}`;
        try {
          const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
          const data = await response.json();
          if (Array.isArray(data) && data.length > 0) {
            const lat = data[0].lat;
            const lon = data[0].lon;

            const form = document.createElement("form");
            form.method = "GET";
            form.action = window.location.pathname;

            const latInput = document.createElement("input");
            latInput.type = "hidden"; latInput.name = "lat"; latInput.value = lat;
            form.appendChild(latInput);

            const lonInput = document.createElement("input");
            lonInput.type = "hidden"; lonInput.name = "lon"; lonInput.value = lon;
            form.appendChild(lonInput);

            document.body.appendChild(form);
            form.submit();
          } else {
            errorDiv.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error al buscar la direcci√≥n:", error);
          document.getElementById("error-direccion").classList.remove("hidden");
        }
      });

      // ---- Bot√≥n "üìç Caf√©s cerca m√≠o" ----
      const ubicacionForm = document.getElementById("ubicacion-form");
      if (ubicacionForm) {
        ubicacionForm.addEventListener("submit", function (event) {
          event.preventDefault();
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
              document.getElementById("lat").value = position.coords.latitude;
              document.getElementById("lon").value = position.coords.longitude;
              ubicacionForm.submit();
            }, function () {
              alert("No se pudo obtener tu ubicaci√≥n. Habilit√° la geolocalizaci√≥n.");
            });
          } else {
            alert("Tu navegador no soporta geolocalizaci√≥n.");
          }
        });
      }
    });
  });
})();
</script>

