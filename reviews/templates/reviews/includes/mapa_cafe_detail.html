{% if cafe.latitude and cafe.longitude %}
  <h3 class="text-xl font-semibold mt-10 mb-2">游늸 Ubicaci칩n</h3>

  <!-- Bot칩n para mostrar mapa -->
  <button onclick="toggleMap(this)" class="mb-4 text-sm text-blue-600 hover:underline focus:outline-none">
    Mostrar mapa
  </button>

  <!-- Filtros visuales -->
  <div class="flex flex-wrap gap-2 mb-4">
    <span class="bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200 text-sm flex items-center gap-2">
      <i class="fa-solid fa-wifi text-blue-500"></i> Wi-Fi
    </span>
    <span class="bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200 text-sm flex items-center gap-2">
      <i class="fa-solid fa-paw text-pink-500"></i> Pet friendly
    </span>
    <span class="bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200 text-sm flex items-center gap-2">
      <i class="fa-solid fa-leaf text-green-500"></i> Vegano
    </span>
    <span class="bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200 text-sm flex items-center gap-2">
      <i class="fa-solid fa-chair text-yellow-500"></i> Exterior
    </span>
  </div>

  <!-- Mapa oculto -->
  <div id="map-container" class="hidden">
    <div id="map" class="relative w-full h-[250px] sm:h-[350px] md:h-[450px] lg:h-[550px] rounded-xl overflow-hidden shadow-lg mb-10"></div>
  </div>

  <script>
    function toggleMap(btn) {
      const mapContainer = document.getElementById("map-container");
      const mapDiv = document.getElementById("map");
      if (!mapContainer || !mapDiv) return;

      const isHidden = mapContainer.classList.contains("hidden");

      if (isHidden) {
        mapContainer.classList.remove("hidden");
        btn.textContent = "Ocultar mapa";

        // esperamos un tick para que el div tenga tama침o
        setTimeout(() => {
          if (typeof L === "undefined") return;

          if (!mapContainer.dataset.mapLoaded) {
            const lat = parseFloat("{{ cafe.latitude|escapejs }}");
            const lon = parseFloat("{{ cafe.longitude|escapejs }}");

            window._cafeMap = L.map('map').setView([lat, lon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
            }).addTo(window._cafeMap);

            L.marker([lat, lon]).addTo(window._cafeMap)
              .bindPopup(`<strong>{{ cafe.name|escapejs }}</strong><br>{{ cafe.address|escapejs }}`).openPopup();

            mapContainer.dataset.mapLoaded = "1";
          } else {
            // si ya existe, re-calcular tama침o por si estaba oculto
            if (window._cafeMap && typeof window._cafeMap.invalidateSize === 'function') {
              window._cafeMap.invalidateSize();
            }
          }
        }, 50);
      } else {
        mapContainer.classList.add("hidden");
        btn.textContent = "Mostrar mapa";
      }
    }
  </script>
{% endif %}
