{% load static %}

<h3 class="text-xl font-semibold mb-4 text-gray-900">üì∏ Fotos del lugar</h3>

{# ahora vamos a usar la lista "photos" que le va a mandar la vista #}
{% if photos %}
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mb-8 min-w-0"
       data-gallery="cafe-{{ cafe.id }}">

    {% for photo in photos %}
      <button type="button"
              class="photo-thumb group cursor-pointer rounded-xl shadow-md overflow-hidden bg-slate-100"
              data-src="{{ photo.url }}"
              data-alt="{{ photo.title }}"
              data-caption="{{ photo.title }}">
        <div class="cafe-photo-box">
          <img
            src="{{ photo.url }}"
            alt="{{ photo.title }}"
            loading="lazy"
            decoding="async"
            fetchpriority="low"
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
        </div>
        <span class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition duration-300"
              aria-hidden="true"></span>
      </button>
    {% endfor %}
  </div>
{% else %}
  <p class="text-sm text-slate-500">Este caf√© todav√≠a no tiene fotos.</p>
{% endif %}

{# modal/lightbox #}
<div id="cafe-{{ cafe.id }}-modal"
     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm p-4">
  <button type="button"
          class="absolute top-4 right-4 text-white text-3xl leading-none"
          data-close="true"
          aria-label="Cerrar">√ó</button>
  <div class="flex flex-col items-center px-4">
    <img id="lightbox-image-{{ cafe.id }}" src="" alt=""
         class="max-h-[80vh] max-w-[92vw] rounded-lg shadow-2xl object-contain">
    <p id="lightbox-caption-{{ cafe.id }}"
       class="text-white mt-4 text-lg text-center opacity-90"></p>
    <div class="flex gap-4 mt-4">
      <button type="button" id="lightbox-prev-{{ cafe.id }}"
              class="bg-white/20 text-white px-4 py-2 rounded hover:bg-white/30"
              aria-label="Imagen anterior">‚Üê Anterior</button>
      <button type="button" id="lightbox-next-{{ cafe.id }}"
              class="bg-white/20 text-white px-4 py-2 rounded hover:bg-white/30"
              aria-label="Siguiente imagen">Siguiente ‚Üí</button>
    </div>
  </div>
</div>

<style>
  /* forzamos el ratio sin depender de Tailwind JIT */
  .cafe-photo-box {
    position: relative;
    width: 100%;
    padding-top: 75%; /* 4:3 */
  }
  .cafe-photo-box img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  @media (min-width: 768px) {
    .cafe-photo-box {
      padding-top: 66%; /* un poco m√°s apaisado en pantallas m√°s grandes */
    }
  }
</style>

<script>
(function() {
  const gallery = document.querySelector('[data-gallery="cafe-{{ cafe.id }}"]');
  const modal   = document.getElementById('cafe-{{ cafe.id }}-modal');
  if (!gallery || !modal) return;

  const slides  = Array.from(gallery.querySelectorAll('.photo-thumb'));
  const imgEl   = document.getElementById('lightbox-image-{{ cafe.id }}');
  const capEl   = document.getElementById('lightbox-caption-{{ cafe.id }}');
  const prevBtn = document.getElementById('lightbox-prev-{{ cafe.id }}');
  const nextBtn = document.getElementById('lightbox-next-{{ cafe.id }}');
  const closeBtn= modal.querySelector('[data-close="true"]');
  let current   = 0;

  function show(idx) {
    const slide = slides[idx];
    if (!slide) return;
    imgEl.src = slide.dataset.src;
    imgEl.alt = slide.dataset.alt;
    capEl.textContent = slide.dataset.caption || '';
    current = idx;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
  function hide() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
  function prev() { show((current - 1 + slides.length) % slides.length); }
  function next() { show((current + 1) % slides.length); }

  slides.forEach((btn, idx) => {
    btn.addEventListener('click', () => show(idx));
  });
  closeBtn.addEventListener('click', hide);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) hide();
  });
  prevBtn.addEventListener('click', prev);
  nextBtn.addEventListener('click', next);
  document.addEventListener('keydown', (e) => {
    if (modal.classList.contains('hidden')) return;
    if (e.key === 'Escape') hide();
    if (e.key === 'ArrowRight') next();
    if (e.key === 'ArrowLeft') prev();
  });
})();
</script>
