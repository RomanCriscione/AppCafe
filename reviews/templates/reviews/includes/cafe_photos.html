{# reviews/templates/reviews/includes/cafe_photos.html #}
<h3 class="text-xl font-semibold mb-4 text-gray-900">üì∏ Fotos del lugar</h3>

<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mb-8 min-w-0"
     data-gallery="cafe-{{ cafe.id }}">
  {% for i in "123" %}
    {% with p=:"photo"|add:i t=:"photo"|add:i|add:"_title" %}
      {% if cafe|attr:p and cafe|attr:p.url %}
        <button type="button"
                class="photo-thumb relative w-full aspect-[4/3] overflow-hidden rounded-xl shadow-md group cursor-pointer"
                data-src="{{ cafe|attr:p.url }}"
                data-alt="{{ cafe|attr:t|default:cafe.name }}"
                data-caption="{{ cafe|attr:t|default:cafe.name }}">
          <img
            src="{{ cafe|attr:p.url }}"
            alt="{{ cafe|attr:t|default:cafe.name }}"
            loading="lazy"
            decoding="async"
            fetchpriority="low"
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
          <span class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent opacity-0 group-hover:opacity-100 transition duration-300"
                aria-hidden="true"></span>
        </button>
      {% endif %}
    {% endwith %}
  {% endfor %}
</div>

{# Lightbox Modal #}
<div id="lightbox-modal-{{ cafe.id }}"
     class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50"
     role="dialog" aria-modal="true" aria-label="Galer√≠a de fotos de {{ cafe.name }}">
  <button type="button"
          id="lightbox-close-{{ cafe.id }}"
          class="absolute top-4 right-6 text-white text-4xl cursor-pointer hover:text-gray-300"
          aria-label="Cerrar">&times;</button>
  <div class="flex flex-col items-center px-4">
    <img id="lightbox-image-{{ cafe.id }}" src="" alt=""
         class="max-h-[80vh] max-w-[92vw] rounded-lg shadow-2xl object-contain">
    <p id="lightbox-caption-{{ cafe.id }}"
       class="text-white mt-4 text-lg text-center opacity-90"></p>
    <div class="flex gap-4 mt-4">
      <button type="button" id="lightbox-prev-{{ cafe.id }}"
              class="bg-white/20 text-white px-4 py-2 rounded hover:bg-white/30"
              aria-label="Imagen anterior">‚Üê Anterior</button>
      <button type="button" id="lightbox-next-{{ cafe.id }}"
              class="bg-white/20 text-white px-4 py-2 rounded hover:bg-white/30"
              aria-label="Siguiente imagen">Siguiente ‚Üí</button>
    </div>
  </div>
</div>

<script>
(function () {
  const gallerySel = `[data-gallery="cafe-{{ cafe.id }}"]`;
  const thumbs = Array.from(document.querySelectorAll(`${gallerySel} .photo-thumb`));
  if (!thumbs.length) return;

  const modal   = document.getElementById('lightbox-modal-{{ cafe.id }}');
  const imgEl   = document.getElementById('lightbox-image-{{ cafe.id }}');
  const capEl   = document.getElementById('lightbox-caption-{{ cafe.id }}');
  const btnPrev = document.getElementById('lightbox-prev-{{ cafe.id }}');
  const btnNext = document.getElementById('lightbox-next-{{ cafe.id }}');
  const btnClose= document.getElementById('lightbox-close-{{ cafe.id }}');

  let current = 0;
  let lastFocused = null;

  const preload = (idx) => {
    const n = thumbs.length;
    [ (idx+1)%n, (idx-1+n)%n ].forEach(i => { const im = new Image(); im.src = thumbs[i].dataset.src; });
  };

  function show(index) {
    current = (index + thumbs.length) % thumbs.length;
    const t = thumbs[current];
    imgEl.src = t.dataset.src;
    imgEl.alt = t.dataset.alt || '';
    capEl.textContent = t.dataset.caption || '';
    preload(current);
  }

  function open(index) {
    lastFocused = document.activeElement;
    show(index);
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.style.overflow = 'hidden';
    btnClose.focus();
  }
  function close() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.style.overflow = '';
    if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
  }
  const next = () => show(current + 1);
  const prev = () => show(current - 1);

  thumbs.forEach((btn, i) => btn.addEventListener('click', () => open(i)));
  btnNext.addEventListener('click', next);
  btnPrev.addEventListener('click', prev);
  btnClose.addEventListener('click', close);

  modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
  document.addEventListener('keydown', (e) => {
    if (modal.classList.contains('hidden')) return;
    if (e.key === 'Escape') close();
    if (e.key === 'ArrowRight') next();
    if (e.key === 'ArrowLeft')  prev();
  });

  let sx = 0, sy = 0;
  modal.addEventListener('touchstart', (e) => {
    if (!e.touches[0]) return;
    sx = e.touches[0].clientX; sy = e.touches[0].clientY;
  }, {passive:true});
  modal.addEventListener('touchend', (e) => {
    const dx = (e.changedTouches[0]?.clientX || sx) - sx;
    const dy = (e.changedTouches[0]?.clientY || sy) - sy;
    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 30) (dx < 0 ? next() : prev());
  });
})();
</script>
