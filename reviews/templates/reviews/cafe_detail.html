{% extends "base.html" %}
{% load static %}

{% block meta %}
  <!-- Open Graph y Twitter -->
  <meta property="og:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta property="og:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta property="og:image" content="{{ full_image_url }}" />
  {% endif %}
  <meta property="og:url" content="{{ full_page_url }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta name="twitter:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta name="twitter:image" content="{{ full_image_url }}" />
  {% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4">
  <h1 class="text-3xl font-bold mb-4">{{ cafe.name }}</h1>

  <div class="mb-4 text-gray-700 space-y-1">
    <p>üìç <strong>Direcci√≥n:</strong> {{ cafe.address }}, {{ cafe.location }}</p>
    <p>‚òé <strong>Tel√©fono:</strong> {{ cafe.phone }}</p>
    <a href="https://www.google.com/maps/search/?api=1&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}" target="_blank" class="text-blue-600 hover:underline">üìç Ver en Google Maps</a>
  </div>

  <p class="mb-4">
    üåü <strong>Plan actual:</strong>
    {% if cafe.visibility_level == 2 %}
      <span class="text-yellow-600 font-bold">‚òï‚òï Plan Maestro</span>
    {% elif cafe.visibility_level == 1 %}
      <span class="text-blue-500 font-bold">‚òï Plan Barista</span>
    {% else %}
      <span class="text-gray-500 font-bold">‚òï Gratuito</span>
    {% endif %}
  </p>

<h3 class="text-xl font-semibold mb-2">üß© Caracter√≠sticas</h3>
<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-6 text-sm text-gray-800">
  {% if cafe.has_wifi %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-wifi text-blue-500"></i> Wi-Fi
    </div>
  {% endif %}
  {% if cafe.is_pet_friendly %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-paw text-pink-500"></i> Pet friendly
    </div>
  {% endif %}
  {% if cafe.is_vegan_friendly %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-leaf text-green-500"></i> Opciones veganas
    </div>
  {% endif %}
  {% if cafe.has_outdoor_seating %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-chair text-yellow-500"></i> Mesas afuera
    </div>
  {% endif %}
  {% if cafe.has_parking %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-square-parking text-gray-600"></i> Estacionamiento
    </div>
  {% endif %}
  {% if cafe.is_accessible %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-wheelchair text-indigo-500"></i> Accesible
    </div>
  {% endif %}
  {% if cafe.has_vegetarian_options %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-carrot text-orange-500"></i> Vegetariano
    </div>
  {% endif %}
  {% if cafe.serves_breakfast %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-mug-saucer text-yellow-600"></i> Desayuno
    </div>
  {% endif %}
  {% if cafe.serves_alcohol %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-wine-glass text-purple-500"></i> Bebidas alcoh√≥licas
    </div>
  {% endif %}
  {% if cafe.has_books_or_games %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-book text-amber-700"></i> Libros o juegos
    </div>
  {% endif %}
  {% if cafe.has_air_conditioning %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-snowflake text-cyan-500"></i> Aire acondicionado
    </div>
  {% endif %}
</div>

{% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
  <h3 class="text-xl font-semibold mb-2">üì∏ Fotos del lugar</h3>
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
    {% if cafe.photo1 %}
      <div class="aspect-w-4 aspect-h-3">
        <img src="{{ cafe.photo1.url }}" alt="{{ cafe.photo1_title }}" class="object-cover w-full h-full rounded shadow">
      </div>
    {% endif %}
    {% if cafe.photo2 %}
      <div class="aspect-w-4 aspect-h-3">
        <img src="{{ cafe.photo2.url }}" alt="{{ cafe.photo2_title }}" class="object-cover w-full h-full rounded shadow">
      </div>
    {% endif %}
    {% if cafe.photo3 %}
      <div class="aspect-w-4 aspect-h-3">
        <img src="{{ cafe.photo3.url }}" alt="{{ cafe.photo3_title }}" class="object-cover w-full h-full rounded shadow">
      </div>
    {% endif %}
  </div>
{% endif %}

{% if average_rating %}
  <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> ‚òï {{ average_rating|floatformat:1 }}</p>
  {% if best_review %}
    <div class="bg-yellow-100 p-4 rounded border-l-4 border-yellow-500 mb-6 animate-fade-in">
      <p class="font-semibold">‚òï‚ú® Rese√±a destacada</p>
      <p class="text-sm text-gray-600">{{ best_review.user.username }} ({{ best_review.created_at|date:"d M Y" }}) ‚Äî ‚òï {{ best_review.rating|floatformat:1 }}</p>
      <p>‚Äú{{ best_review.comment }}‚Äù</p>
    </div>
  {% endif %}
{% else %}
  <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> Sin rese√±as todav√≠a.</p>
{% endif %}

{% if user.is_authenticated %}
  <form method="post" action="{% url 'toggle_favorite' cafe.id %}" class="mb-4">{% csrf_token %}
    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-all">
      {% if user in cafe.favorites.all %}
        üíî Quitar de favoritos
      {% else %}
        ‚ù§Ô∏è Agregar a favoritos
      {% endif %}
    </button>
  </form>
{% endif %}

<h3 class="text-xl font-semibold mt-6 mb-4">Rese√±as:</h3>
<div class="space-y-4 divide-y divide-gray-100">
  {% for review in reviews %}
    {% include "reviews/_review_card.html" %}
  {% empty %}
    <p class="text-gray-500">No hay rese√±as a√∫n.</p>
  {% endfor %}
</div>

{% if user.is_authenticated %}
  <button onclick="document.getElementById('modal-review').style.display='flex'" class="mt-6 bg-secondary text-white px-4 py-2 rounded">Dej√° tu rese√±a</button>
{% else %}
  <p class="mt-4">Para dejar una rese√±a necesit√°s <a href="{% url 'account_login' %}?next={{ request.path }}" class="text-blue-600 hover:underline">iniciar sesi√≥n</a>.</p>
{% endif %}

<!-- Modal -->
<div id="modal-review" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white w-full max-w-md rounded-2xl shadow-xl p-6 relative animate-fade-in">
    <button onclick="document.getElementById('modal-review').style.display='none'" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 text-xl">&times;</button>

    <h3 class="text-2xl font-bold text-center mb-4 text-brown-800">Dej√° tu rese√±a</h3>

    <form method="post" class="space-y-4">{% csrf_token %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="comment">Tu comentario</label>
        {{ form.comment }}
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">‚òï Calificaci√≥n</label>
        <div class="flex flex-row-reverse justify-end gap-1" id="rating-stars">
          {% for i in "54321" %}
            <input type="radio" name="rating" id="star{{ i }}" value="{{ i }}" class="sr-only">
            <label for="star{{ i }}" class="text-2xl cursor-pointer text-gray-300 hover:text-yellow-400 transition-all duration-150" data-value="{{ i }}">‚òï</label>
          {% endfor %}
        </div>
        <p id="rating-label" class="text-sm text-center mt-1 text-gray-600"></p>
      </div>

      <div class="text-center pt-2">
        <button type="submit" class="bg-primary hover:bg-brown-700 text-white font-semibold px-5 py-2 rounded-lg transition-all duration-150">Enviar</button>
      </div>
    </form>
  </div>
</div>

{% if cafe.latitude and cafe.longitude %}
  <h3 class="text-xl font-semibold mt-10 mb-2">üìç Ubicaci√≥n</h3>
  <button onclick="toggleMap()" class="mb-4 text-sm text-blue-600 hover:underline focus:outline-none">Mostrar mapa</button>
  <div id="map-container" class="hidden">
    <div class="relative w-full h-[250px] sm:h-[350px] md:h-[450px] lg:h-[550px] rounded-xl overflow-hidden shadow-lg mb-10" id="map"></div>
  </div>
  <script>
    function toggleMap() {
      const mapContainer = document.getElementById("map-container");
      const button = event.target;
      const isHidden = mapContainer.classList.contains("hidden");
      if (isHidden) {
        mapContainer.classList.remove("hidden");
        button.textContent = "Ocultar mapa";
        if (!mapContainer.dataset.mapLoaded) {
          const lat = parseFloat("{{ cafe.latitude|escapejs }}");
          const lon = parseFloat("{{ cafe.longitude|escapejs }}");
          const map = L.map('map').setView([lat, lon], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
          }).addTo(map);
          L.marker([lat, lon]).addTo(map)
            .bindPopup("<strong>{{ cafe.name|escapejs }}</strong><br>{{ cafe.address|escapejs }}").openPopup();
          mapContainer.dataset.mapLoaded = true;
        }
      } else {
        mapContainer.classList.add("hidden");
        button.textContent = "Mostrar mapa";
      }
    }
  </script>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ‚≠ê Script para pintar las tazas y mostrar texto de calificaci√≥n
    const starsContainer = document.getElementById("rating-stars");
    if (!starsContainer) return;

    const stars = starsContainer.querySelectorAll("label");
    const radios = starsContainer.querySelectorAll("input[type='radio']");
    
    // Crear contenedor de texto si no existe
    let textLabel = document.getElementById("rating-label");
    if (!textLabel) {
      textLabel = document.createElement("p");
      textLabel.id = "rating-label";
      textLabel.className = "mt-2 text-sm font-medium text-center text-gray-700";
      starsContainer.parentNode.insertBefore(textLabel, starsContainer.nextSibling);
    }

    const labels = {
      5: "Excelente",
      4: "Muy bueno",
      3: "Bueno",
      2: "Regular",
      1: "Malo"
    };

    function updateStars(selected) {
      stars.forEach(label => {
        const value = parseInt(label.getAttribute("for").replace("star", ""));
        if (value <= selected) {
          label.classList.remove("text-gray-300");
          label.classList.add("text-yellow-500");
        } else {
          label.classList.remove("text-yellow-500");
          label.classList.add("text-gray-300");
        }
      });
      textLabel.textContent = selected > 0 ? labels[selected] : "";
    }

    // Manejo de clics
    radios.forEach(radio => {
      radio.addEventListener("change", () => {
        updateStars(parseInt(radio.value));
      });
    });

    // Hover visual
    stars.forEach(label => {
      label.addEventListener("mouseenter", () => {
        const hovered = parseInt(label.getAttribute("for").replace("star", ""));
        updateStars(hovered);
      });
      label.addEventListener("mouseleave", () => {
        const selected = starsContainer.querySelector("input:checked");
        updateStars(selected ? parseInt(selected.value) : 0);
      });
    });

    // Mostrar la selecci√≥n al cargar
    const checked = starsContainer.querySelector("input:checked");
    if (checked) {
      updateStars(parseInt(checked.value));
    }
  });

  // üß≠ Script para caf√©s vistos recientemente (Swiper)
  document.addEventListener("DOMContentLoaded", function () {
    const visitedCafe = {
      id: {{ cafe.id }},
      name: "{{ cafe.name|escapejs }}",
      url: "{% url 'cafe_detail' cafe.id %}",
      photo1: {% if cafe.photo1 %}"{{ cafe.photo1.url }}"{% else %}null{% endif %},
      location: "{{ cafe.location|escapejs }}",
      address: "{{ cafe.address|escapejs }}"
    };

    let history = JSON.parse(localStorage.getItem("recently_viewed_cafes") || "[]");
    history = history.filter(c => c.id !== visitedCafe.id);
    history.unshift(visitedCafe);
    history = history.slice(0, 5);
    localStorage.setItem("recently_viewed_cafes", JSON.stringify(history));

    const container = document.getElementById("recently-viewed-list");
    if (!container) return;
    history.forEach(cafe => {
      const card = document.createElement("div");
      card.className = "swiper-slide w-[300px] bg-white rounded-lg shadow-md p-4 box-border";
      card.innerHTML = `
        <div class="flex gap-4 items-start">
          ${cafe.photo1 ? `<img src="${cafe.photo1}" alt="${cafe.name}" class="w-20 h-20 object-cover rounded-md" loading="lazy">` : ""}
          <div class="flex flex-col justify-between">
            <p class="font-semibold leading-snug">
              <a href="${cafe.url}" class="text-blue-600 hover:underline">${cafe.name}</a>
            </p>
            <p class="text-sm text-gray-700">${cafe.location}</p>
            <p class="text-xs text-gray-500">${cafe.address}</p>
          </div>
        </div>`;
      container.appendChild(card);
    });

    new Swiper("#recently-viewed-container", {
      slidesPerView: 'auto',
      spaceBetween: 16,
      navigation: {
        nextEl: ".swiper-button-next",
        prevEl: ".swiper-button-prev",
      },
      pagination: {
        el: ".swiper-pagination",
        clickable: true,
      },
    });
  });
</script>

{% endblock %}
