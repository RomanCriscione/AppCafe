{% extends "base.html" %}
{% load static %}

{% block meta %}
  <!-- Open Graph y Twitter -->
  <meta property="og:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta property="og:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta property="og:image" content="{{ full_image_url }}" />
  {% endif %}
  <meta property="og:url" content="{{ full_page_url }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta name="twitter:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta name="twitter:image" content="{{ full_image_url }}" />
  {% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4">
  <h1 class="text-3xl font-bold mb-4">{{ cafe.name }}</h1>

  <div class="mb-4 text-gray-700 space-y-1">
    <p>üìç <strong>Direcci√≥n:</strong> {{ cafe.address }}, {{ cafe.location }}</p>
    <p>‚òé <strong>Tel√©fono:</strong> {{ cafe.phone }}</p>
    <a href="https://www.google.com/maps/search/?api=1&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}" target="_blank" class="text-blue-600 hover:underline">üìç Ver en Google Maps</a>
  </div>

  <p class="mb-4">
    üåü <strong>Plan actual:</strong>
    {% if cafe.visibility_level == 2 %}
      <span class="text-yellow-600 font-bold">‚òï‚òï Plan Maestro</span>
    {% elif cafe.visibility_level == 1 %}
      <span class="text-blue-500 font-bold">‚òï Plan Barista</span>
    {% else %}
      <span class="text-gray-500 font-bold">‚òï Gratuito</span>
    {% endif %}
  </p>

{% if cafe.tags.exists %}
  <div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">üè∑Ô∏è Etiquetas destacadas del lugar:</h2>
    <div class="flex flex-wrap gap-2">
      {% for tag in cafe.tags.all %}
        <span class="bg-gray-200 text-gray-800 text-sm px-3 py-1 rounded-full">{{ tag.name }}</span>
      {% endfor %}
    </div>
  </div>
{% endif %}

{% if user.is_authenticated %}
  <div class="text-right mb-4">
    <a href="{% url 'create_review' cafe.id %}" class="bg-primary text-white px-4 py-2 rounded hover:bg-secondary transition">
      üìù Dej√° tu rese√±a
    </a>
  </div>
{% else %}
  <p class="text-sm text-gray-600 mt-4">Inici√° sesi√≥n para dejar una rese√±a.</p>
{% endif %}


{% if sensory_tags %}
  <div class="mt-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">üß† Lo que otros destacan (etiquetas sensoriales)</h2>
    <div class="flex flex-wrap gap-2">
      {% for tag in sensory_tags %}
        <span class="bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full">{{ tag.name }}</span>
      {% endfor %}
    </div>
  </div>
{% endif %}

  {% if cafe.is_pet_friendly %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-paw text-pink-500"></i> Pet friendly
    </div>
  {% endif %}
  {% if cafe.is_vegan_friendly %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-leaf text-green-500"></i> Opciones veganas
    </div>
  {% endif %}
  {% if cafe.has_outdoor_seating %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-chair text-yellow-500"></i> Mesas afuera
    </div>
  {% endif %}
  {% if cafe.has_parking %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-square-parking text-gray-600"></i> Estacionamiento
    </div>
  {% endif %}
  {% if cafe.is_accessible %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-wheelchair text-indigo-500"></i> Accesible
    </div>
  {% endif %}
  {% if cafe.has_vegetarian_options %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-carrot text-orange-500"></i> Vegetariano
    </div>
  {% endif %}
  {% if cafe.serves_breakfast %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-mug-saucer text-yellow-600"></i> Desayuno
    </div>
  {% endif %}
  {% if cafe.serves_alcohol %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-wine-glass text-purple-500"></i> Bebidas alcoh√≥licas
    </div>
  {% endif %}
  {% if cafe.has_books_or_games %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-book text-amber-700"></i> Libros o juegos
    </div>
  {% endif %}
  {% if cafe.has_air_conditioning %}
    <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded shadow-sm border border-gray-200">
      <i class="fa-solid fa-snowflake text-cyan-500"></i> Aire acondicionado
    </div>
  {% endif %}
</div>

{% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
  <h3 class="text-xl font-semibold mb-2">üì∏ Fotos del lugar</h3>
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
    {% if cafe.photo1 %}
      <div class="w-full h-64 sm:h-52 md:h-60 lg:h-72 overflow-hidden rounded-lg shadow">
        <img src="{{ cafe.photo1.url }}" alt="{{ cafe.photo1_title }}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">
      </div>
    {% endif %}
    {% if cafe.photo2 %}
      <div class="w-full h-64 sm:h-52 md:h-60 lg:h-72 overflow-hidden rounded-lg shadow">
        <img src="{{ cafe.photo2.url }}" alt="{{ cafe.photo2_title }}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">
      </div>
    {% endif %}
    {% if cafe.photo3 %}
      <div class="w-full h-64 sm:h-52 md:h-60 lg:h-72 overflow-hidden rounded-lg shadow">
        <img src="{{ cafe.photo3.url }}" alt="{{ cafe.photo3_title }}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">
      </div>
    {% endif %}
  </div>
{% endif %}

{% if average_rating %}
  <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> ‚òï {{ average_rating|floatformat:1 }}</p>
  {% if best_review %}
    <div class="bg-yellow-100 p-4 rounded border-l-4 border-yellow-500 mb-6 animate-fade-in">
      <p class="font-semibold">‚òï‚ú® Rese√±a destacada</p>
      <p class="text-sm text-gray-600">{{ best_review.user.username }} ({{ best_review.created_at|date:"d M Y" }}) ‚Äî ‚òï {{ best_review.rating|floatformat:1 }}</p>
      <p>‚Äú{{ best_review.comment }}‚Äù</p>
    </div>
  {% endif %}
{% else %}
  <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> Sin rese√±as todav√≠a.</p>
{% endif %}

{% if recommended_cafes %}
  <div class="mt-10">
    <h2 class="text-xl font-semibold mb-4">‚òï Caf√©s recomendados</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
      {% for cafe in recommended_cafes %}
        <a href="{% url 'cafe_detail' cafe.id %}" class="block bg-white rounded-lg shadow hover:shadow-md transition duration-200 overflow-hidden">
          {% if cafe.photo1 %}
            <img src="{{ cafe.photo1.url }}" alt="{{ cafe.name }}" class="w-full h-40 object-cover">
          {% else %}
            <div class="w-full h-40 bg-gray-200 flex items-center justify-center text-gray-500">Sin foto</div>
          {% endif %}
          <div class="p-3">
            <h3 class="font-semibold text-base text-gray-800">{{ cafe.name }}</h3>
            <p class="text-sm text-gray-600">{{ cafe.location }}</p>
            <p class="text-yellow-500 text-sm mt-1">‚òï {{ cafe.average_rating|floatformat:1 }}/5</p>
          </div>
        </a>
      {% endfor %}
    </div>
  </div>
{% endif %}

{% if user.is_authenticated %}
  <form method="post" action="{% url 'toggle_favorite' cafe.id %}" class="mb-4">{% csrf_token %}
    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-all">
      {% if user in cafe.favorites.all %}
        üíî Quitar de favoritos
      {% else %}
        ‚ù§Ô∏è Agregar a favoritos
      {% endif %}
    </button>
  </form>
{% endif %}

<h3 class="text-xl font-semibold mt-6 mb-4">Rese√±as:</h3>

<div id="review-container" class="space-y-4 divide-y divide-gray-100 transition-all duration-300 max-h-[1056px] overflow-hidden relative">
  {% for review in reviews %}
    <div class="mb-6 p-4 border rounded-md shadow-sm bg-white">
      <div class="flex justify-between items-center mb-2">
        <strong>{{ review.user.username }}</strong>
        <span class="text-yellow-600">‚òï {{ review.rating }}</span>
      </div>
      <p>{{ review.comment }}</p>

      {% if review.owner_reply %}
        <div class="bg-gray-100 rounded-md p-3 mt-2 text-sm border-l-4 border-primary">
          <strong class="text-primary">Respuesta del due√±o:</strong><br>
          {{ review.owner_reply }}
        </div>
      {% endif %}
    </div>
  {% empty %}
    <p class="text-gray-500">No hay rese√±as a√∫n.</p>
  {% endfor %}
  {% if reviews|length > 3 %}
    <div class="absolute bottom-0 left-0 w-full h-20 bg-gradient-to-t from-white to-transparent pointer-events-none" id="fade-reviews"></div>
  {% endif %}
</div>

{% if reviews|length > 3 %}
  <button onclick="toggleReviews()" class="text-sm text-blue-600 mt-1 hover:underline" id="btn-reviews">Ver todas</button>
{% endif %}


{% if user.is_authenticated %}
  <button onclick="document.getElementById('modal-review').style.display='flex'" class="mt-6 bg-secondary text-white px-4 py-2 rounded">Dej√° tu rese√±a</button>
{% else %}
  <p class="mt-4">Para dejar una rese√±a necesit√°s <a href="{% url 'account_login' %}?next={{ request.path }}" class="text-blue-600 hover:underline">iniciar sesi√≥n</a>.</p>
{% endif %}

<!-- Modal -->
<div id="modal-review" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white w-full max-w-md rounded-2xl shadow-xl p-6 relative animate-fade-in">
    <button onclick="document.getElementById('modal-review').style.display='none'" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 text-xl">&times;</button>

    <h3 class="text-2xl font-bold text-center mb-4 text-brown-800">Dej√° tu rese√±a</h3>

    <form method="post" class="space-y-4">
      {% csrf_token %}

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="comment">Tu comentario</label>
        {{ form.comment }}
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">‚òï Calificaci√≥n</label>
        <div class="flex flex-row-reverse justify-end gap-1" id="rating-stars">
          {% for i in "54321" %}
            <input type="radio" name="rating" id="star{{ i }}" value="{{ i }}" class="sr-only"
                  {% if form.rating.value|stringformat:"s" == i %}checked{% endif %}>
            <label for="star{{ i }}" class="text-2xl cursor-pointer text-gray-300 hover:text-yellow-400 transition-all duration-150" data-value="{{ i }}">‚òï</label>
          {% endfor %}
        </div>
        <p id="rating-label" class="text-sm text-center mt-1 text-gray-600"></p>
      </div>

      {% if tag_groups %}
        <div class="space-y-4">
          {% for category, tags in tag_groups.items %}
            <div>
              <p class="text-sm font-semibold text-gray-800 mb-1">{{ category|capfirst }}</p>
              <div class="flex flex-wrap gap-2">
                {% for tag in tags %}
                  <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" name="tags" value="{{ tag.id }}"
                          {% if tag.id|stringformat:"s" in form.tags.value %}checked{% endif %}
                          class="rounded border-gray-300 text-primary focus:ring-primary">
                    {{ tag.name }}
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="text-center pt-2">
        <button type="submit" class="bg-primary hover:bg-brown-700 text-white font-semibold px-5 py-2 rounded-lg transition-all duration-150">Enviar</button>
      </div>
    </form>
  </div>
</div>

{% include "reviews/includes/mapa_cafe_detail.html" %}

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ‚≠ê Script para pintar las tazas y mostrar texto de calificaci√≥n
    const starsContainer = document.getElementById("rating-stars");
    if (!starsContainer) return;

    const stars = starsContainer.querySelectorAll("label");
    const radios = starsContainer.querySelectorAll("input[type='radio']");
    
    // Crear contenedor de texto si no existe
    let textLabel = document.getElementById("rating-label");
    if (!textLabel) {
      textLabel = document.createElement("p");
      textLabel.id = "rating-label";
      textLabel.className = "mt-2 text-sm font-medium text-center text-gray-700";
      starsContainer.parentNode.insertBefore(textLabel, starsContainer.nextSibling);
    }

    const labels = {
      5: "Excelente",
      4: "Muy bueno",
      3: "Bueno",
      2: "Regular",
      1: "Malo"
    };

    function updateStars(selected) {
      stars.forEach(label => {
        const value = parseInt(label.getAttribute("for").replace("star", ""));
        if (value <= selected) {
          label.classList.remove("text-gray-300");
          label.classList.add("text-yellow-500");
        } else {
          label.classList.remove("text-yellow-500");
          label.classList.add("text-gray-300");
        }
      });
      textLabel.textContent = selected > 0 ? labels[selected] : "";
    }

    // Manejo de clics
    radios.forEach(radio => {
      radio.addEventListener("change", () => {
        updateStars(parseInt(radio.value));
      });
    });

    // Hover visual
    stars.forEach(label => {
      label.addEventListener("mouseenter", () => {
        const hovered = parseInt(label.getAttribute("for").replace("star", ""));
        updateStars(hovered);
      });
      label.addEventListener("mouseleave", () => {
        const selected = starsContainer.querySelector("input:checked");
        updateStars(selected ? parseInt(selected.value) : 0);
      });
    });

    // Mostrar la selecci√≥n al cargar
    const checked = starsContainer.querySelector("input:checked");
    if (checked) {
      updateStars(parseInt(checked.value));
    }
  });

  // üß≠ Script para caf√©s vistos recientemente (Swiper)
  document.addEventListener("DOMContentLoaded", function () {
    const visitedCafe = {
      id: {{ cafe.id }},
      name: "{{ cafe.name|escapejs }}",
      url: "{% url 'cafe_detail' cafe.id %}",
      photo1: {% if cafe.photo1 %}"{{ cafe.photo1.url }}"{% else %}null{% endif %},
      location: "{{ cafe.location|escapejs }}",
      address: "{{ cafe.address|escapejs }}"
    };

    let history = JSON.parse(localStorage.getItem("recently_viewed_cafes") || "[]");
    history = history.filter(c => c.id !== visitedCafe.id);
    history.unshift(visitedCafe);
    history = history.slice(0, 5);
    localStorage.setItem("recently_viewed_cafes", JSON.stringify(history));

    const container = document.getElementById("recently-viewed-list");
    if (!container) return;
    history.forEach(cafe => {
      const card = document.createElement("div");
      card.className = "swiper-slide w-[300px] bg-white rounded-lg shadow-md p-4 box-border";
      card.innerHTML = `
        <div class="flex gap-4 items-start">
          ${cafe.photo1 ? `<img src="${cafe.photo1}" alt="${cafe.name}" class="w-20 h-20 object-cover rounded-md" loading="lazy">` : ""}
          <div class="flex flex-col justify-between">
            <p class="font-semibold leading-snug">
              <a href="${cafe.url}" class="text-blue-600 hover:underline">${cafe.name}</a>
            </p>
            <p class="text-sm text-gray-700">${cafe.location}</p>
            <p class="text-xs text-gray-500">${cafe.address}</p>
          </div>
        </div>`;
      container.appendChild(card);
    });

    new Swiper("#recently-viewed-container", {
      slidesPerView: 'auto',
      spaceBetween: 16,
      navigation: {
        nextEl: ".swiper-button-next",
        prevEl: ".swiper-button-prev",
      },
      pagination: {
        el: ".swiper-pagination",
        clickable: true,
      },
    });
  });

function toggleTags(index) {
  const container = document.getElementById(`tag-container-${index}`);
  const button = document.getElementById(`btn-${index}`);
  const fade = document.getElementById(`fade-${index}`);

  // Verifica si est√° expandido
  const isCollapsed = container.classList.contains("max-h-[96px]");

  if (isCollapsed) {
    // Expandir
    container.classList.remove("max-h-[96px]", "overflow-hidden");
    if (fade) fade.style.display = "none";
    button.textContent = "Ver menos";
  } else {
    // Colapsar
    container.classList.add("max-h-[96px]", "overflow-hidden");
    if (fade) fade.style.display = "block";
    button.textContent = "Ver todas";
  }
}

</script>

{% endblock %}
