<!-- templates/reviews/cafe_detail.html -->
{% extends "base.html" %}
{% load static cache tag_icons %}

{% block head_title %}
  <title>{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}</title>
{% endblock %}

{% block meta %}
  <link rel="canonical" href="{{ full_page_url }}" />
  {% if page_obj and page_obj.has_previous %}
    <link rel="prev" href="?page={{ page_obj.previous_page_number }}#reviews" />
  {% endif %}
  {% if page_obj and page_obj.has_next %}
    <link rel="next" href="?page={{ page_obj.next_page_number }}#reviews" />
  {% endif %}

  <meta property="og:type" content="place" />
  <meta property="og:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta property="og:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}<meta property="og:image" content="{{ full_image_url }}" />{% endif %}
  <meta property="og:url" content="{{ full_page_url }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta name="twitter:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}<meta name="twitter:image" content="{{ full_image_url }}" />{% endif %}

  {% if cafe.description %}
    <meta name="description" content="{{ cafe.description|striptags|truncatechars:155 }}">
  {% elif best_review %}
    <meta name="description" content="{{ best_review.comment|striptags|truncatechars:155 }}">
  {% else %}
    <meta name="description" content="{{ cafe.name }} en {{ cafe.location }}: rese√±as, fotos y ubicaci√≥n.">
  {% endif %}

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CafeOrCoffeeShop",
    "@id": "{{ full_page_url }}#place",
    "name": "{{ cafe.name|escapejs }}",
    "url": "{{ full_page_url|escapejs }}",
    {% if full_image_url %}"image": "{{ full_image_url|escapejs }}",{% endif %}
    {% if cafe.address or cafe.location %}
    "address": {
      "@type": "PostalAddress",
      {% if cafe.address %}"streetAddress": "{{ cafe.address|escapejs }}",{% endif %}
      {% if cafe.location %}"addressLocality": "{{ cafe.location|escapejs }}",{% endif %}
      "addressCountry": "AR"
    },
    {% endif %}
    {% if cafe.latitude and cafe.longitude %}
    "geo": {
      "@type": "GeoCoordinates",
      "latitude": {{ cafe.latitude|floatformat:"3" }},
      "longitude": {{ cafe.longitude|floatformat:"3" }}
    },
    {% endif %}
    {% if cafe.phone %}"telephone": "{{ cafe.phone|escapejs }}",{% endif %}
    {% if average_rating and total_reviews %}
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "{{ average_rating|floatformat:1 }}",
      "reviewCount": "{{ total_reviews }}"
    },
    {% endif %}
    {% if schema_reviews %}
    "review": [
      {% for r in schema_reviews %}
      {
        "@type": "Review",
        "author": { "@type": "Person", "name": "{{ r.user.username|default:'Usuario'|escapejs }}" },
        "datePublished": "{{ r.created_at|date:'c' }}",
        "reviewBody": "{{ r.comment|striptags|truncatechars:400|escapejs }}",
        "reviewRating": {
          "@type": "Rating",
          "ratingValue": "{{ r.rating|floatformat:1 }}",
          "bestRating": "5",
          "worstRating": "1"
        }
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ],
    {% endif %}
    "sameAs": [{% if cafe.google_maps_url %}"{{ cafe.google_maps_url|escapejs }}"{% endif %}]
  }
  </script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Caf√©s", "item": "{{ cafe_list_abs }}" },
      { "@type": "ListItem", "position": 2, "name": "{{ cafe.name|escapejs }}", "item": "{{ full_page_url }}" }
    ]
  }
  </script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 space-y-8">
  <h1 class="text-3xl font-bold animate-fade-in-up">{{ cafe.name }}</h1>

  <div class="mt-3 flex flex-wrap items-center gap-3 animate-fade-in-up animate-delay-125">
    {% if user.is_authenticated %}
      <a href="{% url 'reviews:create_review' cafe.id %}" class="btn btn-primary rounded-xl">‚úçÔ∏è Dejar rese√±a</a>
    {% else %}
      <a href="{% url 'account_login' %}?next={% url 'reviews:create_review' cafe.id %}" class="btn btn-primary rounded-xl">‚úçÔ∏è Dejar rese√±a</a>
    {% endif %}
    <a href="#reviews" class="btn btn-outline rounded-xl">Ver rese√±as</a>
  </div>

  <section class="surface p-4 rounded-xl animate-fade-in-up animate-delay-100">
    <div class="grid gap-4 sm:grid-cols-2">
      <div class="flex items-start gap-2">
        <span aria-hidden="true">üìç</span>
        <div>
          <div class="font-semibold">Direcci√≥n</div>
          <div class="text-sm text-gray-600">{{ cafe.address }}{% if cafe.location %}, {{ cafe.location }}{% endif %}</div>
        </div>
      </div>
      <div class="flex items-start gap-2">
        <span aria-hidden="true">‚òé</span>
        <div>
          <div class="font-semibold">Tel√©fono</div>
          <div class="text-sm text-gray-600">{{ cafe.phone|default:"‚Äî" }}</div>
        </div>
      </div>
      <div class="sm:col-span-2 flex flex-wrap gap-3">
        <a href="https://www.google.com/maps/search/?api=1{% if cafe.latitude and cafe.longitude %}&query={{ cafe.latitude }},{{ cafe.longitude }}{% else %}&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}{% endif %}"
           target="_blank" rel="noopener" class="btn btn-primary rounded-xl">
          üìç Ver en Google Maps
        </a>
        {% if cafe.claim_status != 'VERIFIED' %}
          <a href="{% url 'reviews:claim_start' cafe.id %}" class="cta cta-indigo">üè∑Ô∏è ¬øSos el due√±o? Reclam√° este local</a>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="mt-4 animate-fade-in-up animate-delay-150">
    {% include "reviews/includes/cafe_features.html" with cafe=cafe %}
  </section>

  {% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
    <div class="animate-fade-in-up animate-delay-200">
      {% include "reviews/includes/cafe_photos.html" with cafe=cafe %}
    </div>
  {% endif %}

  {% if top_tags %}
    <section aria-labelledby="destacan" class="surface p-4 rounded-xl">
      <h2 id="destacan" class="text-lg font-semibold text-gray-800 mb-3">üß† Lo que otros destacan</h2>
      <ul class="flex flex-wrap gap-2">
        {% for t in top_tags %}
          <li><span class="px-3 py-1.5 rounded-full text-sm md:text-base font-medium bg-slate-50 text-slate-800 border border-slate-200">{{ t|tag_emoji }} {{ t.name }}</span></li>
        {% empty %}
          <li class="text-gray-500">A√∫n no hay etiquetas.</li>
        {% endfor %}
      </ul>
      {% if more_tags %}
        <details class="mt-3">
          <summary class="text-sm text-blue-600 cursor-pointer select-none">Ver m√°s</summary>
          <ul class="mt-2 flex flex-wrap gap-2">
            {% for t in more_tags %}
              <li><span class="px-3 py-1.5 rounded-full text-xs md:text-sm bg-slate-50 text-slate-700 border border-slate-200">{{ t|tag_emoji }} {{ t.name }}</span></li>
            {% endfor %}
          </ul>
        </details>
      {% endif %}
    </section>
  {% endif %}

  {% if radar_values and radar_labels %}
    <section class="surface p-4 rounded-xl animate-fade-in-up animate-delay-225">
      <div class="flex items-center gap-2 mb-2">
        <span>üìä</span>
        <h2 class="text-lg font-semibold">Perfil sensorial del lugar</h2>
      </div>
      <div class="h-48 sm:h-44 md:h-52">
        <canvas id="sensor-bars"></canvas>
      </div>
    </section>
  {% endif %}

  <div class="animate-fade-in-up animate-delay-300">
    {% if average_rating %}
      <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> ‚òï {{ average_rating|floatformat:1 }}</p>
      {% if best_review %}
        <div class="bg-[#f0fdfa] p-4 rounded border-l-4 border-accent mb-6 animate-fade-in">
          <p class="font-semibold text-accent">‚òï‚ú® Rese√±a destacada</p>
          <p class="text-sm text-gray-600">{{ best_review.user.username }} ({{ best_review.created_at|date:"d M Y" }}) ‚Äî ‚òï {{ best_review.rating|floatformat:1 }}</p>
          <p>‚Äú{{ best_review.comment }}‚Äù</p>
        </div>
      {% endif %}
    {% else %}
      <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> Sin rese√±as todav√≠a.</p>
    {% endif %}
  </div>

  <h3 id="reviews" class="text-xl font-semibold mt-6 mb-4 animate-fade-in-up animate-delay-400">Rese√±as:</h3>

  {% cache 600 cafe_reviews_list cafe.id user.id %}
    <div id="review-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 transition-all duration-300 max-h-[1056px] overflow-hidden relative animate-fade-in-up animate-delay-500">
      {% for review in reviews %}
        {% include "reviews/_review_card.html" with review=review %}
      {% empty %}
        <p class="text-gray-500 text-sm col-span-full">{{ ui_messages.no_reviews }}</p>
      {% endfor %}
      {% if reviews|length > 3 %}
        <div id="fade-reviews" class="absolute bottom-0 left-0 w-full h-20 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
      {% endif %}
    </div>
    {% if reviews|length > 3 %}
      <button onclick="toggleReviews()" id="btn-reviews" class="btn btn-outline btn-sm mt-2 animate-fade-in-up animate-delay-600">Ver todas</button>
    {% endif %}
  {% endcache %}

  {% include "reviews/includes/pagination.html" with page_obj=page_obj anchor="#reviews" %}

  {% if user.is_authenticated %}
    <!-- Favoritos: fallback POST + mejora con JS -->
    <form method="post"
          action="{% url 'reviews:toggle_favorite' cafe.id %}"
          class="mb-4 animate-fade-in-up animate-delay-700 fav-form js-ajax-post"
          data-cafe="{{ cafe.id }}">
      {% csrf_token %}
      {% if user in cafe.favorites.all %}
        <button type="submit"
                class="btn btn-danger rounded-xl js-fav-btn"
                aria-pressed="true"
                data-icon="‚ù§Ô∏è"
                data-icon-off="ü§ç"
                data-label-on="Quitar de favoritos"
                data-label-off="Agregar a favoritos">
          <span class="js-fav-icon" aria-hidden="true">‚ù§Ô∏è</span>
          Quitar de favoritos
        </button>
      {% else %}
        <button type="submit"
                class="btn btn-outline rounded-xl js-fav-btn"
                aria-pressed="false"
                data-icon="‚ù§Ô∏è"
                data-icon-off="ü§ç"
                data-label-on="Quitar de favoritos"
                data-label-off="Agregar a favoritos">
          <span class="js-fav-icon" aria-hidden="true">ü§ç</span>
          Agregar a favoritos
        </button>
      {% endif %}
    </form>
  {% else %}
    <a class="btn btn-outline rounded-xl" href="{% url 'account_login' %}?next={{ request.path }}">ü§ç Agregar a favoritos</a>
  {% endif %}

  {% if total_reviews %}
    <div class="cup-float">
      <span class="cup-emoji {% if positive_pct >= 50 %}fill{% endif %}">‚òï</span>
      <span class="text-sm text-gray-700">Positivas: <strong>{{ positive_pct }}%</strong></span>
    </div>
  {% endif %}

  {% if cafe.latitude and cafe.longitude %}
    <section aria-labelledby="ubicacion" class="mt-10">
      <h3 id="ubicacion" class="text-xl font-semibold mb-2">üìç Ubicaci√≥n</h3>

      <button type="button" id="btn-toggle-map" onclick="toggleMap(this)" class="mb-4 text-sm text-blue-600 hover:underline focus:outline-none">Mostrar mapa</button>

      <div id="map-container" class="hidden">
        <div id="map" class="relative w-full h-[250px] sm:h-[350px] md:h-[450px] lg:h-[550px] rounded-xl overflow-hidden shadow-lg mb-10"></div>
      </div>
    </section>

    <style>
      .leaflet-marker-icon.cup-marker { filter: drop-shadow(0 3px 6px rgba(0,0,0,.25)); }
    </style>

    <script>
      function toggleMap(btn) {
        const mapContainer = document.getElementById('map-container');
        const mapDiv = document.getElementById('map');
        if (!mapContainer || !mapDiv) return;

        const willShow = mapContainer.classList.contains('hidden');

        if (willShow) {
          mapContainer.classList.remove('hidden');
          btn.textContent = 'Ocultar mapa';
          setTimeout(() => {
            if (typeof L === 'undefined') return;
            if (!mapContainer.dataset.mapLoaded) {
              const lat = parseFloat('{{ cafe.latitude|escapejs }}');
              const lon = parseFloat('{{ cafe.longitude|escapejs }}');
              window._cafeMap = L.map('map').setView([lat, lon], 15);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
              }).addTo(window._cafeMap);

              const iconUrl = "{% static 'images/coffee-cup.svg' %}";
              const cupIcon = L.icon({
                iconUrl, iconSize: [32,38], iconAnchor: [16,38], popupAnchor: [0,-32],
                className: 'cup-marker'
              });

              L.marker([lat, lon], { icon: cupIcon }).addTo(window._cafeMap)
                .bindPopup(`<strong>{{ cafe.name|escapejs }}</strong><br>{{ cafe.address|default:'Sin direcci√≥n'|escapejs }}<br><em>{{ one_liner|default:""|escapejs }}</em>`)
                .openPopup();

              mapContainer.dataset.mapLoaded = '1';
            } else if (window._cafeMap && typeof window._cafeMap.invalidateSize === 'function') {
              window._cafeMap.invalidateSize();
            }
          }, 50);
        } else {
          mapContainer.classList.add('hidden');
          btn.textContent = 'Mostrar mapa';
        }
      }
    </script>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  {% if radar_values and radar_labels %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const labels = {{ radar_labels|safe }};
      const values = {{ radar_values|safe }};
      const maxVal = Math.max(1, ...values);

      const palette = ['#F1E8E3','#E7D7C9','#E6CCB2','#DDB892','#B08968','#996B53','#7A4F2A'];
      const bg = labels.map((_, i) => palette[i % palette.length]);

      const el = document.getElementById('sensor-bars');
      if (!el) return;

      new Chart(el.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels.map((l, i) => `${l} (${values[i]})`),
          datasets: [{ data: values, backgroundColor: bg, borderWidth: 0, borderRadius: 10, barThickness: 16, maxBarThickness: 18 }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 2, right: 8, bottom: 2, left: 0 } },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => ` ${ctx.raw} mencione${ctx.raw === 1 ? '': 's'}` } }
          },
          scales: {
            x: { beginAtZero: true, suggestedMax: maxVal, grid: { color: 'rgba(0,0,0,.06)' }, ticks: { precision: 0, color: '#475569' } },
            y: { grid: { display: false }, ticks: { color: '#334155' } }
          },
          animation: { duration: 300 }
        }
      });
    });
  </script>
  {% endif %}

  <script>
  function toggleReviews() {
    const container = document.getElementById("review-container");
    const btn = document.getElementById("btn-reviews");
    const fade = document.getElementById("fade-reviews");
    if (!container || !btn) return;
    const collapsed = container.classList.contains("max-h-[1056px]");
    container.classList.toggle("max-h-[1056px]", !collapsed);
    container.classList.toggle("overflow-hidden", !collapsed);
    if (fade) fade.style.display = collapsed ? "block" : "none";
    btn.textContent = collapsed ? "Ver todas" : "Ver menos";
  }

  // Likes en rese√±as (AJAX)
  document.addEventListener("DOMContentLoaded", () => {
    const getCSRFFrom = (form) => form.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
    document.querySelectorAll(".like-form").forEach(form => {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const rid  = form.dataset.review;
        const csrf = getCSRFFrom(form);
        try {
          const resp = await fetch(form.action, {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrf },
            body: new FormData(form),
            credentials: "same-origin"
          });
          const data = await resp.json();
          if (!data.ok) return;

          const btn = form.querySelector("button");
          const countEl = document.getElementById(`likes-count-${rid}`);
          const iconEl  = document.getElementById(`like-icon-${rid}`);

          countEl.textContent = data.count;
          if (data.liked) {
            btn.classList.remove("btn-outline");
            btn.classList.add("btn-success");
            btn.setAttribute("aria-pressed", "true");
            iconEl.textContent = "‚ù§Ô∏è";
          } else {
            btn.classList.remove("btn-success");
            btn.classList.add("btn-outline");
            btn.setAttribute("aria-pressed", "false");
            iconEl.textContent = "ü§ç";
          }

          if (window.bounceLike) window.bounceLike(btn);
        } catch (err) { console.error(err); }
      });
    });
  });
  </script>
{% endblock %}
