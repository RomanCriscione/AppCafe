{% extends "base.html" %}
{% load static %}

{% block content %}
  <h1>{{ cafe.name }}</h1>

  <p>
    <strong>üìç Direcci√≥n:</strong> {{ cafe.address }}, {{ cafe.location }}<br>
    <strong>‚òé Tel√©fono:</strong> {{ cafe.phone }}<br>
    <a href="https://www.google.com/maps/search/?api=1&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}"
      target="_blank" class="google-maps-link">üìç Ver en Google Maps</a>
  </p>

  {% if average_rating %}
    <p><strong>Calificaci√≥n promedio:</strong> ‚òï {{ average_rating|floatformat:1 }}</p>
    
    {% if best_review %}
      <div class="mejor-review">
        <p class="mejor-review-titulo">‚òï‚ú® <strong>Rese√±a destacada</strong></p>
        <p class="mejor-review-meta">
          {{ best_review.user.username }} ({{ best_review.created_at|date:"d M Y" }}) ‚Äî
          ‚òï {{ best_review.rating|floatformat:1 }}
        </p>
        <p class="mejor-review-comentario">‚Äú{{ best_review.comment }}‚Äù</p>
      </div>

      <div class="compartir-cafe">
        <p><strong>Compartir esta cafeter√≠a:</strong></p>
        <a href="https://api.whatsapp.com/send?text={{ request.build_absolute_uri }}" target="_blank" class="btn-share">üì± WhatsApp</a>
        <a href="https://twitter.com/intent/tweet?text=Recomiendo esta cafeter√≠a: {{ cafe.name }}&url={{ request.build_absolute_uri }}" target="_blank" class="btn-share">üê¶ X</a>
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="btn-share">üìò Facebook</a>
        <button onclick="copiarEnlace()" class="btn-share">üîó Copiar enlace</button>
      </div>
    {% endif %}

  {% else %}
    <p><strong>Calificaci√≥n promedio:</strong> Sin rese√±as todav√≠a.</p>
  {% endif %}

  {% if user.is_authenticated %}
    <form method="post" action="{% url 'toggle_favorite' cafe.id %}">
      {% csrf_token %}
      <button type="submit" class="btn">
        {% if user in cafe.favorites.all %}
          üíî Quitar de favoritos
        {% else %}
          ‚ù§Ô∏è Agregar a favoritos
        {% endif %}
      </button>
    </form>
  {% endif %}

  {% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
    <h3>üì∏ Fotos del lugar</h3>
    <div class="swiper-container">
      <div class="swiper-wrapper">
        {% if cafe.photo1 %}
          <div class="swiper-slide">
            <img src="{{ cafe.photo1.url }}" alt="{{ cafe.photo1_title }}" class="cafe-photo-slide">
          </div>
        {% endif %}
        {% if cafe.photo2 %}
          <div class="swiper-slide">
            <img src="{{ cafe.photo2.url }}" alt="{{ cafe.photo2_title }}" class="cafe-photo-slide">
          </div>
        {% endif %}
        {% if cafe.photo3 %}
          <div class="swiper-slide">
            <img src="{{ cafe.photo3.url }}" alt="{{ cafe.photo3_title }}" class="cafe-photo-slide">
          </div>
        {% endif %}
      </div>
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-pagination"></div>
    </div>
  {% endif %}

  <h3>Rese√±as:</h3>
  <ul class="review-list">
    {% for review in reviews %}
      <li class="review-card">
        <div class="review-header">
          <strong>{{ review.user.username }}</strong>
          <span class="review-date">({{ review.created_at|date:"d M Y" }})</span>
        </div>
        <div class="review-body">
          <p>‚òï {{ review.rating|floatformat:1 }}</p>
          <p>{{ review.comment }}</p>
        </div>

        {% if review.owner_reply %}
          <div class="reply-block">
            <strong>Respuesta del due√±o:</strong>
            <p>{{ review.owner_reply }}</p>
          </div>
        {% endif %}

        {% if user.is_authenticated and user == cafe.owner %}
          {% if review.owner_reply %}
            <button onclick="toggleReplyForm('{{ review.id }}')" type="button" class="btn-reply-edit">‚úèÔ∏è Editar respuesta</button>
          {% else %}
            <button onclick="toggleReplyForm('{{ review.id }}')" type="button" class="btn-reply-new">üí¨ Responder</button>
          {% endif %}
          <form method="post" action="{% url 'reply_review' review.id %}" id="reply-form-{{ review.id }}" style="display: none; margin-top: 1rem;">
            {% csrf_token %}
            <textarea name="reply" rows="2" style="width: 100%;">{{ review.owner_reply }}</textarea><br>
            <button type="submit" class="btn">Guardar respuesta</button>
          </form>
        {% endif %}
      </li>
    {% empty %}
      <li>No hay rese√±as a√∫n.</li>
    {% endfor %}
  </ul>

  {% if user.is_authenticated %}
    <h3>{% if existing_review %}Editar tu rese√±a{% else %}Dej√° tu rese√±a{% endif %}</h3>

    {% if form.errors %}
      <ul class="form-errors">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li>{{ field }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    {% endif %}

    <form method="post">
      {% csrf_token %}
      {{ form.comment.label_tag }}<br>
      {{ form.comment }}<br><br>

      <label for="id_rating">‚òï Calificaci√≥n:</label><br>
      <div class="rating-widget">
        {% for i in "54321" %}
          <input type="radio" name="rating" id="star{{ i }}" value="{{ i }}" {% if form.rating.value|stringformat:"s" == i %}checked{% endif %}>
          <label for="star{{ i }}">‚òï</label>
        {% endfor %}
      </div>

      <button type="submit">
        {% if existing_review %}Actualizar{% else %}Enviar{% endif %}
      </button>
    </form>
  {% else %}
    <h3>Dej√° tu rese√±a</h3>
    <p>
      Para dejar una rese√±a necesit√°s
      <a href="{% url 'account_login' %}?next={{ request.path }}">iniciar sesi√≥n</a>.
    </p>
  {% endif %}

  <script>
    function toggleReplyForm(id) {
      const form = document.getElementById('reply-form-' + id);
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function copiarEnlace() {
      navigator.clipboard.writeText(window.location.href)
        .then(() => alert("üìã Enlace copiado al portapapeles"))
        .catch(err => alert("No se pudo copiar el enlace"));
    }
  </script>

  <style>
    .google-maps-link {
      display: inline-block;
      background-color: #4285F4;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
    }

    .mejor-review {
      background: #fff8e1;
      border-left: 5px solid #ff9800;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 8px;
    }

    .mejor-review-titulo {
      font-weight: bold;
      margin-bottom: 0.3rem;
      font-size: 1.1rem;
    }

    .mejor-review-meta {
      color: #555;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .mejor-review-comentario {
      font-style: italic;
      font-size: 1rem;
    }

    .compartir-cafe {
      margin-top: 1rem;
    }

    .btn-share {
      margin-right: 0.5rem;
      background-color: #eee;
      padding: 5px 10px;
      border-radius: 5px;
      text-decoration: none;
    }

    .swiper-container {
      width: 100%;
      max-width: 700px;
      margin: 20px auto;
    }

    .swiper-slide img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 10px;
    }


    .review-list {
      padding-left: 0;
      list-style: none;
    }

    .review-card {
      margin-bottom: 1rem;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }

    .form-errors {
      color: red;
      list-style: none;
    }

    .btn {
      padding: 8px 16px;
      background-color: #ff4081;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      margin: 10px 0;
    }

    .btn:hover {
      background-color: #e91e63;
    }

    .rating-widget {
      direction: rtl;
      font-size: 1.5rem;
      display: inline-flex;
      gap: 0.2rem;
    }

    .rating-widget input[type="radio"] {
      display: none;
    }

    .rating-widget label {
      cursor: pointer;
      opacity: 0.4;
      transition: opacity 0.2s;
    }

    .rating-widget input[type="radio"]:checked ~ label,
    .rating-widget label:hover,
    .rating-widget label:hover ~ label {
      opacity: 1;
    }

    @media (max-width: 600px) {
      .swiper-container {
        max-width: 100%;
      }
    }
  </style>
{% endblock %}
