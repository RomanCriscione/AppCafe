<!-- templates/reviews/cafe_detail.html -->
{% extends "base.html" %}
{% load static cache tag_icons %}

{% block head_title %}
  <title>{{ cafe.name }} en {{ cafe.location }} | Gota</title>
{% endblock %}

{% block meta %}

  <link rel="canonical" href="{{ full_page_url }}" />

  {% if page_obj and page_obj.has_previous %}
    <link rel="prev" href="?page={{ page_obj.previous_page_number }}#reviews" />
  {% endif %}
  {% if page_obj and page_obj.has_next %}
    <link rel="next" href="?page={{ page_obj.next_page_number }}#reviews" />
  {% endif %}

  <!-- OG + Twitter -->
  <meta property="og:type" content="place" />
  <meta property="og:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta property="og:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}<meta property="og:image" content="{{ full_image_url }}" />{% endif %}
  <meta property="og:url" content="{{ full_page_url }}" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta name="twitter:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}<meta name="twitter:image" content="{{ full_image_url }}" />{% endif %}

  {% if cafe.description %}
    <meta name="description" content="{{ cafe.description|striptags|truncatechars:155 }}">
  {% elif best_review %}
    <meta name="description" content="{{ best_review.comment|striptags|truncatechars:155 }}">
  {% else %}
    <meta name="description" content="{{ cafe.name }} en {{ cafe.location }}: rese√±as, fotos y ubicaci√≥n.">
  {% endif %}

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CafeOrCoffeeShop",
    "@id": "{{ full_page_url }}#place",
    "name": "{{ cafe.name|escapejs }}",
    "priceRange": "$$",
    "servesCuisine": ["Coffee", "Cafe"],
    "openingHoursSpecification": [{
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": [
        "Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"
      ],
      "opens": "06:00",
      "closes": "23:59"
    }],
    "amenityFeature": [
      { "@type": "LocationFeatureSpecification", "name": "Wi-Fi", "value": true },
      { "@type": "LocationFeatureSpecification", "name": "Pet friendly", "value": true }
    ],
    "hasMap": "https://www.google.com/maps/search/?api=1&query={{ cafe.latitude }},{{ cafe.longitude }}",
    "url": "{{ full_page_url|escapejs }}",

    {% if full_image_url %}
    "image": "{{ full_image_url|escapejs }}",
    {% endif %}

    {% if cafe.address or cafe.location %}
    "address": {
      "@type": "PostalAddress",
      {% if cafe.address %}"streetAddress": "{{ cafe.address|escapejs }}",{% endif %}
      {% if cafe.location %}"addressLocality": "{{ cafe.location|escapejs }}",{% endif %}
      "addressCountry": "AR"
    },
    {% endif %}

    {% if cafe.latitude and cafe.longitude %}
    "geo": {
      "@type": "GeoCoordinates",
      "latitude": {{ cafe.latitude|floatformat:"3" }},
      "longitude": {{ cafe.longitude|floatformat:"3" }}
    },
    {% endif %}

    {% if cafe.phone %}
    "telephone": "{{ cafe.phone|escapejs }}",
    {% endif %}

    {% if average_rating and total_reviews %}
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "{{ average_rating|floatformat:1 }}",
      "reviewCount": "{{ total_reviews }}"
    },
    {% endif %}

    {% if schema_reviews %}
    "review": [
      {% for r in schema_reviews %}
      {
        "@type": "Review",
        "author": { "@type": "Person", "name": "{{ r.user.username|default:'Usuario'|escapejs }}" },
        "datePublished": "{{ r.created_at|date:'c' }}",
        "reviewBody": "{{ r.comment|striptags|truncatechars:400|escapejs }}",
        "reviewRating": {
          "@type": "Rating",
          "ratingValue": "{{ r.rating|floatformat:1 }}",
          "bestRating": "5",
          "worstRating": "1"
        }
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ],
    {% endif %}

    {% if cafe.google_maps_url or cafe.instagram %}
    "sameAs": [
      {% if cafe.google_maps_url %}
        "{{ cafe.google_maps_url|escapejs }}"
      {% endif %}
      {% if cafe.instagram %}
        {% if cafe.google_maps_url %},{% endif %}
        "https://www.instagram.com/{{ cafe.instagram|escapejs }}/"
      {% endif %}
    ]
    {% endif %}


  }
  </script>

  <!-- Breadcrumb JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Caf√©s", "item": "{{ cafe_list_abs }}" },
      { "@type": "ListItem", "position": 2, "name": "{{ cafe.name|escapejs }}", "item": "{{ full_page_url }}" }
    ]
  }
  </script>

{% endblock %}


{% block content %}

<div class="max-w-4xl mx-auto px-4 space-y-8">

<!-- HEADER PRINCIPAL -->
<section class="surface p-5 rounded-2xl space-y-4 animate-fade-in-up">

  <!-- FILA SUPERIOR: rating / rese√±as / precio -->
  <div class="flex flex-wrap items-center gap-4 text-sm text-gray-700 dark:text-[var(--text-2)]">

    {% if average_rating %}
      <div class="flex items-center gap-1 font-semibold text-gray-900 dark:text-[var(--text-1)]">
        {{ average_rating|floatformat:1 }}
        <svg viewBox="0 0 24 24" class="w-5 h-5 inline align-[-2px] ml-1">
          <path fill="#f59e0b" d="M5 9h9v5a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4V9z"/>
          <path fill="none" stroke="#9aa0a6" stroke-width="1.6"
                d="M4 8h11v6a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5V8z"/>
          <path fill="none" stroke="#9aa0a6" stroke-width="1.6"
                d="M15 9h3a3 3 0 0 1 0 6h-2"/>
        </svg>

      </div>
    {% endif %}

    {% if total_reviews %}
      <div class="flex items-center gap-1">
        üó≥Ô∏è {{ total_reviews }} rese√±a{{ total_reviews|pluralize }}
      </div>
    {% endif %}

    {% if precio_promedio %}
      <div class="flex items-center gap-1">
        üí≤ ${{ precio_promedio|floatformat:0 }}
      </div>
    {% endif %}

  </div>

  <!-- NOMBRE -->
  <h1 class="text-3xl font-bold text-gray-900 dark:text-[var(--text-1)]">
    {{ cafe.name }}
  </h1>

  <nav aria-label="Breadcrumb" class="text-sm text-gray-500 mb-3">
    <ol class="flex flex-wrap items-center gap-1">
      <li>
        <a href="{% url 'home' %}" class="hover:underline">Inicio</a>
        <span class="mx-1">‚Ä∫</span>
      </li>

      <li>
        <a href="{{ cafe_list_abs }}" class="hover:underline">Caf√©s</a>
        <span class="mx-1">‚Ä∫</span>
      </li>

      {% if cafe.location %}
        <li>
          <a href="{{ cafe_list_abs }}?zona={{ cafe.location|urlencode }}"
            class="hover:underline">
            {{ cafe.location }}
          </a>
          <span class="mx-1">‚Ä∫</span>
        </li>
      {% endif %}

      <li class="text-gray-700 font-medium">
        {{ cafe.name }}
      </li>
    </ol>
  </nav>


  {% if one_liner %}
    <p class="text-sm text-gray-600 dark:text-[var(--text-2)]">
      {{ one_liner }}
    </p>
  {% endif %}

  
  <!-- CTAs -->
  <div class="flex flex-wrap gap-3 pt-2">

    {% if user.is_authenticated %}
      <a href="{% url 'reviews:create_review' cafe.id %}"
         class="btn btn-primary rounded-xl">
        ‚úçÔ∏è Dejar rese√±a
      </a>
    {% else %}
      <a href="{% url 'account_login' %}?next={% url 'reviews:create_review' cafe.id %}"
         class="btn btn-primary rounded-xl">
        ‚úçÔ∏è Dejar rese√±a
      </a>
    {% endif %}

    <a href="#reviews" class="btn btn-outline rounded-xl">
      Ver rese√±as
    </a>
  </div>

</section>


    <!-- FOTOS -->
  {% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
    <section class="surface p-4 rounded-xl animate-fade-in-up animate-delay-200">
      {% include "reviews/includes/cafe_photos.html" with cafe=cafe %}
    </section>
  {% endif %}
    

  <!-- INFO PRINCIPAL -->
  <section class="surface p-4 rounded-xl animate-fade-in-up animate-delay-100">
    <div class="grid gap-4 sm:grid-cols-2">

      <!-- DIRECCI√ìN -->
      <div class="flex items-start gap-2">
        <span>üìç</span>
        <div>
          <div class="font-semibold text-gray-900 dark:text-[var(--text-1)]">
            Direcci√≥n
          </div>
          <div class="text-sm text-gray-600 dark:text-[var(--text-2)]">
            {{ cafe.address }}{% if cafe.location %}, {{ cafe.location }}{% endif %}
          </div>
        </div>
      </div>

      <!-- TEL√âFONO -->
      <div class="flex items-start gap-2">
        <span>‚òé</span>
        <div>
          <div class="font-semibold text-gray-900 dark:text-[var(--text-1)]">
            Tel√©fono
          </div>
          <div class="text-sm text-gray-600 dark:text-[var(--text-2)]">
            {{ cafe.phone|default:"‚Äî" }}
          </div>
        </div>
      </div>

      {% if cafe.instagram %}
      <div class="flex items-start gap-2">
        <span>üì∏</span>
        <div>
          <div class="font-semibold text-gray-900 dark:text-[var(--text-1)]">
            Instagram
          </div>
          <div class="text-sm">
            <a
              href="https://www.instagram.com/{{ cafe.instagram }}/"
              target="_blank"
              rel="noopener"
              class="text-pink-600 hover:underline"
            >
              @{{ cafe.instagram }}
            </a>
          </div>
        </div>
      </div>
      {% endif %}


        
      <!-- BOTONES ORDENADOS -->
      <div class="sm:col-span-2 space-y-3">

        <!-- FILA PRINCIPAL -->
        <div class="flex flex-wrap gap-3">

          <!-- QR rese√±as -->
          <button onclick="openQRModal()"
                  class="btn btn-primary rounded-xl">
            ‚≠ê QR para rese√±as
          </button>

          <!-- Compartir -->
          <button onclick="toggleShareMenu()"
                  class="btn btn-outline rounded-xl">
            üì§ Compartir
          </button>

        </div>

        <!-- MENU SHARE -->
        <div id="shareMenu"
            class="hidden flex flex-wrap gap-2 bg-gray-50 dark:bg-[var(--surface-2)] p-3 rounded-xl">

          <!-- WhatsApp -->
          <a href="https://wa.me/?text=Mir√°%20{{ cafe.name|urlencode }}%20en%20Gota%20‚òï%0A{{ full_page_url|urlencode }}"
            target="_blank"
            class="btn btn-outline btn-sm rounded-lg">
            üü¢ WhatsApp
          </a>

          <!-- Copiar -->
          <button onclick="copyCafeLink('{{ full_page_url }}', this)"
                  class="btn btn-outline btn-sm rounded-lg">
            üîó Copiar link
          </button>

        </div>

        <!-- FILA SECUNDARIA -->
        <div class="flex flex-wrap gap-4 pt-2 border-t border-gray-200 dark:border-[var(--border)]">

          <!-- Google maps -->
          <a href="https://www.google.com/maps/search/?api=1{% if cafe.latitude and cafe.longitude %}&query={{ cafe.latitude }},{{ cafe.longitude }}{% else %}&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}{% endif %}"
            target="_blank"
            class="text-sm text-gray-500 hover:underline">
            üìç Ver en Google Maps
          </a>

          {% if cafe.claim_status != 'VERIFIED' %}
            <a href="{% url 'reviews:claim_start' cafe.id %}"
              class="text-sm text-gray-500 hover:underline">
              üè∑Ô∏è ¬øSos el due√±o? Reclamalo
            </a>
          {% endif %}

        </div>

      </div>


    </div>
  </section>


  <!-- FEATURES -->
  <section class="mt-4 animate-fade-in-up animate-delay-150">
    <div class="surface p-4 rounded-xl">
      {% include "reviews/includes/cafe_features.html" with cafe=cafe %}
    </div>
  </section>

      <!-- TAGS -->
  {% if top_tags %}
    <section class="surface p-4 rounded-xl animate-fade-in-up animate-delay-225">

      <h2 class="text-lg font-semibold mb-3 text-[var(--text-1)]">üß† Lo que otros destacan</h2>

      <!-- TOP TAGS -->
      <ul class="flex flex-wrap gap-2">
        {% for t in top_tags %}
          <li>
            <span class="tag-chip">
              {{ t|tag_emoji }} {{ t.name }}
            </span>
          </li>
        {% empty %}
          <li class="text-gray-500 dark:text-[var(--text-2)]">A√∫n no hay etiquetas.</li>
        {% endfor %}
      </ul>

      {% if more_tags %}
      <details class="mt-3 group">
        <summary class="text-sm text-primary cursor-pointer dark:text-[var(--accent)]">
          Ver m√°s
        </summary>

        <ul class="mt-2 flex flex-wrap gap-2">
          {% for t in more_tags %}
            <li>
              <span class="tag-chip tag-chip--small">
                {{ t|tag_emoji }} {{ t.name }}
              </span>
            </li>
          {% endfor %}
        </ul>

      </details>
      {% endif %}

    </section>

  {% endif %}


  <!-- PERFIL SENSORIAL -->
  {% if radar_values and radar_labels %}
    <section class="surface p-4 rounded-xl animate-fade-in-up animate-delay-225">
      <div class="flex items-center gap-2 mb-2">
        <span>üìä</span>
        <h2 class="text-lg font-semibold">Perfil del caf√© seg√∫n usuarios</h2>

        {% if total_reviews == 1 %}
        <p class="text-sm text-gray-500 mt-1">
        Primeras impresiones del lugar ‚òï
        </p>

        {% elif total_reviews > 1 %}
        <p class="text-sm text-gray-500 mt-1 flex items-center gap-1">
        Perfil construido con {{ total_reviews }} rese√±as

        <svg viewBox="0 0 24 24" class="w-4 h-4 inline">
          <path fill="#f59e0b" d="M5 9h9v5a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4V9z"/>
          <path fill="none" stroke="#9aa0a6" stroke-width="1.6"
                d="M4 8h11v6a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5V8z"/>
          <path fill="none" stroke="#9aa0a6" stroke-width="1.6"
                d="M15 9h3a3 3 0 0 1 0 6h-2"/>
        </svg>

        </p>
        {% endif %}


      </div>
      <div class="h-56 sm:h-60 md:h-64">
        {% if total_reviews == 0 %}
        <p class="text-sm text-gray-400 text-center mt-6">
        A√∫n no hay datos suficientes para el perfil ‚òï
        </p>
        {% else %}
        <canvas id="sensor-bars"></canvas>
        {% endif %}

      </div>
    </section>
  {% endif %}

  <!-- PROMEDIO + PRECIO + BEST REVIEW -->
  <div class="animate-fade-in-up animate-delay-300">

    {% if average_rating %}
      <p class="mb-4">
        <strong>Calificaci√≥n promedio:</strong> {{ average_rating|floatformat:1 }}
        <svg viewBox="0 0 24 24" class="w-5 h-5 inline align-[-2px] ml-1">
          <path fill="#f59e0b" d="M5 9h9v5a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4V9z"/>
          <path fill="none" stroke="#9aa0a6" stroke-width="1.6"
                d="M4 8h11v6a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5V8z"/>
          <path fill="none" stroke="#9aa0a6" stroke-width="1.6"
                d="M15 9h3a3 3 0 0 1 0 6h-2"/>
        </svg>
      </p>

      {% if precio_promedio %}
        <div class="px-4 py-3 rounded-xl mt-4 border
                    bg-white dark:bg-[var(--surface-2)]
                    border-amber-200 dark:border-[var(--border)]
                    text-amber-800 dark:text-[var(--text-1)]">
          <p class="text-sm font-semibold">Capuccino mediano (promedio):</p>
          <p class="text-lg font-bold">${{ precio_promedio|floatformat:0 }}</p>
          <p class="text-xs text-gray-600 dark:text-[var(--text-2)]">
            Basado en precios reales cargados por usuarios
          </p>
        </div>

      {% endif %}

      {% if best_review %}
        <div class="p-4 rounded-xl border-l-4 mb-6 animate-fade-in
                    bg-white dark:bg-[var(--surface-2)]
                    border-accent/30 dark:border-accent/50">
          
          <p class="font-semibold text-accent">‚ú® Rese√±a destacada</p>

          <p class="text-sm text-gray-600 dark:text-[var(--text-2)]">
            {{ best_review.user.username }} ({{ best_review.created_at|date:"d M Y" }})
            ‚Äî {{ best_review.rating|floatformat:1 }}
            <svg viewBox="0 0 24 24" class="w-4 h-4 inline align-[-2px] ml-1">
              <path fill="#f59e0b" d="M5 9h9v5a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4V9z"/>
              <path fill="none" stroke="#9aa0a6" stroke-width="1.6"
                    d="M4 8h11v6a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5V8z"/>
              <path fill="none" stroke="#9aa0a6" stroke-width="1.6"
                    d="M15 9h3a3 3 0 0 1 0 6h-2"/>
            </svg>

          </p>

          <p class="mt-1 text-gray-800 dark:text-[var(--text-1)]">
            ‚Äú{{ best_review.comment }}‚Äù
          </p>

        </div>

      {% endif %}

    {% else %}
      <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> Sin rese√±as todav√≠a.</p>
    {% endif %}
  </div>

  <!-- LISTA DE RESE√ëAS -->
  <h3 id="reviews" class="text-xl font-semibold mt-6 mb-4 animate-fade-in-up animate-delay-400">Rese√±as:</h3>

  {% cache 600 cafe_reviews_list cafe.id user.id %}
  <div id="review-container"
       class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 max-h-[1056px] overflow-hidden relative animate-fade-in-up animate-delay-500">

    {% for review in reviews %}
      {% include "reviews/_review_card.html" with review=review %}
    {% empty %}
      <p class="text-gray-500 text-sm col-span-full">{{ ui_messages.no_reviews }}</p>
    {% endfor %}

    {% if reviews|length > 3 %}
      <div id="fade-reviews" class="absolute bottom-0 left-0 w-full h-20 reviews-fade-gradient pointer-events-none"></div>
    {% endif %}

  </div>

  {% if reviews|length > 3 %}
    <button onclick="toggleReviews()" id="btn-reviews"
            class="btn btn-outline btn-sm mt-2 animate-fade-in-up animate-delay-600">
      Ver todas
    </button>
  {% endif %}
  {% endcache %}

  {% include "reviews/includes/pagination.html" with page_obj=page_obj anchor="#reviews" %}

<!-- FAVORITOS -->
<section class="surface p-4 rounded-xl animate-fade-in-up animate-delay-350">

  {% if user.is_authenticated %}
    <form method="post" action="{% url 'reviews:toggle_favorite' cafe.id %}"
          class="fav-form js-ajax-post" data-cafe="{{ cafe.id }}">
      {% csrf_token %}

      {% if user in cafe.favorites.all %}
        <button type="submit"
                class="btn btn-danger rounded-xl js-fav-btn"
                aria-pressed="true">
          <span class="js-fav-icon">‚ù§Ô∏è</span> Quitar de favoritos
        </button>
      {% else %}
        <button type="submit"
                class="btn btn-outline rounded-xl js-fav-btn"
                aria-pressed="false">
          <span class="js-fav-icon">ü§ç</span> Agregar a favoritos
        </button>
      {% endif %}
    </form>

  {% else %}
    <a class="btn btn-outline rounded-xl"
       href="{% url 'account_login' %}?next={{ request.path }}">
      ü§ç Agregar a favoritos
    </a>
  {% endif %}

</section>


  <!-- PORCENTAJE POSITIVAS -->
  {% if total_reviews %}
    <div class="cup-float">
      <span class="cup-emoji {% if positive_pct >= 50 %}fill{% endif %}">‚òï</span>
      <span class="text-sm text-gray-700">Positivas: <strong>{{ positive_pct }}%</strong></span>
    </div>
  {% endif %}

  <!-- MAPA -->
  {% if cafe.latitude and cafe.longitude %}
  <section aria-labelledby="ubicacion" class="mt-10">
    <h3 id="ubicacion" class="text-xl font-semibold mb-2">üìç Ubicaci√≥n</h3>

    <button type="button" id="btn-toggle-map" onclick="toggleMap(this)"
            class="mb-4 text-sm text-blue-600 hover:underline">
      Mostrar mapa
    </button>

    <div id="map-container" class="hidden">
      <div id="map"
           class="relative w-full h-[250px] sm:h-[350px] md:h-[450px] lg:h-[550px]
                  rounded-xl overflow-hidden shadow-lg mb-10"></div>
    </div>
  </section>

  <style>
    .leaflet-marker-icon.cup-marker {
      filter: drop-shadow(0 3px 6px rgba(0,0,0,.25));
    }
  </style>

  <script>
    function toggleMap(btn) {
      const mapContainer = document.getElementById('map-container');
      const mapDiv = document.getElementById('map');
      if (!mapContainer || !mapDiv) return;

      const willShow = mapContainer.classList.contains('hidden');
      if (willShow) {
        mapContainer.classList.remove('hidden');
        btn.textContent = 'Ocultar mapa';

        setTimeout(() => {
          if (typeof L === 'undefined') return;

          if (!mapContainer.dataset.mapLoaded) {
            const lat = parseFloat('{{ cafe.latitude|escapejs }}');
            const lon = parseFloat('{{ cafe.longitude|escapejs }}');

            window._cafeMap = L.map('map').setView([lat, lon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
            }).addTo(window._cafeMap);

            const iconUrl = "{% static 'images/coffee-cup.svg' %}";
            const cupIcon = L.icon({
              iconUrl,
              iconSize: [32, 38],
              iconAnchor: [16, 38],
              popupAnchor: [0, -32],
              className: 'cup-marker'
            });

            L.marker([lat, lon], { icon: cupIcon }).addTo(window._cafeMap)
              .bindPopup(`<strong>{{ cafe.name|escapejs }}</strong><br>{{ cafe.address|default:'Sin direcci√≥n'|escapejs }}<br><em>{{ one_liner|default:""|escapejs }}</em>`)
              .openPopup();

            mapContainer.dataset.mapLoaded = '1';
          } else if (window._cafeMap && typeof window._cafeMap.invalidateSize === 'function') {
            window._cafeMap.invalidateSize();
          }
        }, 50);

      } else {
        mapContainer.classList.add('hidden');
        btn.textContent = 'Mostrar mapa';
      }
    }
  </script>

  {% endif %}
</div>

<!-- MODAL QR -->
<div id="qrModal" class="fixed inset-0 bg-black/60 hidden z-50 items-center justify-center">
  <div class="bg-white rounded-2xl p-6 max-w-sm w-full text-center relative">

    <button onclick="closeQRModal()" class="absolute top-2 right-3 text-xl">‚úñ</button>

    <h3 class="text-lg font-bold mb-3">QR para dejar rese√±a</h3>
    <p class="text-sm text-gray-500 mb-4">
      Escane√° y dej√° tu opini√≥n en Gota ‚òï
    </p>

    <img id="qrImage" class="mx-auto rounded-lg shadow mb-4"/>

    <a id="downloadQR"
       class="btn btn-primary w-full mb-2"
       download="qr-gota.png">
       Descargar QR
    </a>

  </div>
</div>


{% endblock %}


{% block scripts %}
  {{ block.super }}

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  {% if radar_values and radar_labels %}
  <script>
  document.addEventListener('DOMContentLoaded', () => {

    const labels = {{ radar_labels|safe }};
    const values = {{ radar_values|safe }};

    // üëâ convertir a porcentaje
    const total = values.reduce((a,b)=>a+b,0) || 1;
    const pct = values.map(v => Math.round((v/total)*100));

    const isDark = document.documentElement.classList.contains("dark");

    const paletteLight = [
      "#E6C7A6",
      "#D6A77A",
      "#C28B5A",
      "#A56A3F",
      "#7B4A2E",
      "#5B371F",
      "#3E2515"
    ];

    const paletteDark = [
      "#F1D2B6",
      "#E2B88F",
      "#D09A64",
      "#B87A45",
      "#915A33",
      "#6E4125",
      "#4A2A18"
    ];

    const bg = (isDark ? paletteDark : paletteLight).slice(0, labels.length);

    const el = document.getElementById('sensor-bars');
    if (!el) return;

    new Chart(el.getContext('2d'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          data: pct,
          backgroundColor: bg,
          borderWidth: 0,
          borderRadius: 999,
          barThickness: 18,
          maxBarThickness: 26
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        animation:{
          duration:1200,
          easing:'easeOutQuart'
        },
        scales: {
          x: {
            beginAtZero: true,
            max: 100,
            ticks:{ callback:v=>v+"%" }
          },
          y: {
            grid: { display: false }
          }
        }
      }
    });
  });
  
  </script>
  {% endif %}

  <script>
    function toggleReviews() {
      const container = document.getElementById("review-container");
      const btn = document.getElementById("btn-reviews");
      const fade = document.getElementById("fade-reviews");

      if (!container || !btn) return;

      const collapsed = container.classList.contains("max-h-[1056px]");
      container.classList.toggle("max-h-[1056px]", !collapsed);
      container.classList.toggle("overflow-hidden", !collapsed);

      if (fade) fade.style.display = collapsed ? "block" : "none";
      btn.textContent = collapsed ? "Ver todas" : "Ver menos";
    }

    // Likes en rese√±as
    document.addEventListener("DOMContentLoaded", () => {

      const getCSRFFrom = (form) =>
        form.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

      document.querySelectorAll(".like-form").forEach(form => {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const rid = form.dataset.review;
          const csrf = getCSRFFrom(form);

          try {
            const resp = await fetch(form.action, {
              method: "POST",
              headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": csrf
              },
              body: new FormData(form),
              credentials: "same-origin"
            });

            const data = await resp.json();
            if (!data.ok) return;

            const btn = form.querySelector("button");
            const countEl = document.getElementById(`likes-count-${rid}`);
            const iconEl = document.getElementById(`like-icon-${rid}`);

            countEl.textContent = data.count;

            if (data.liked) {
              btn.classList.remove("btn-outline");
              btn.classList.add("btn-success");
              btn.setAttribute("aria-pressed", "true");
              iconEl.textContent = "‚ù§Ô∏è";
            } else {
              btn.classList.remove("btn-success");
              btn.classList.add("btn-outline");
              btn.setAttribute("aria-pressed", "false");
              iconEl.textContent = "ü§ç";
            }

            if (window.bounceLike) window.bounceLike(btn);

          } catch (err) { console.error(err); }
        });
      });
    });
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    document
      .querySelectorAll("[data-animate-on-load]")
      .forEach(el => {
        requestAnimationFrame(() => {
          el.classList.add("animate-fade-in-up-active");
        });
      });
  });

  </script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const el = document.querySelector("[data-rating-celebration]");
    if (!el) return;

    // entrada
    requestAnimationFrame(() => {
      el.classList.add("animate-fade-in-up-active");
    });

    // salida suave
    setTimeout(() => {
      el.classList.remove("animate-fade-in-up-active");
      el.style.opacity = "0";
    }, 2200);
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const highlightId = "{{ highlight_id|default:'' }}";
  if (!highlightId) return;

  const el = document.getElementById(`review-${highlightId}`);
  if (!el) return;

  setTimeout(() => {
    el.scrollIntoView({ behavior: "smooth", block: "center" });
    el.classList.add("review-highlight-active");

    setTimeout(() => {
      el.classList.remove("review-highlight-active");
    }, 3500);
  }, 300);
});

</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  if (!window.location.search.includes("highlight=")) return;

  const url = new URL(window.location.href);
  url.searchParams.delete("highlight");

  window.history.replaceState({}, "", url.pathname + url.search + url.hash);
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const banner = document.getElementById("review-success-banner");
  if (!banner) return;

  // entrada
  requestAnimationFrame(() => {
    banner.classList.remove("opacity-0", "translate-y-4");
  });

  // salida autom√°tica
  setTimeout(() => {
    banner.classList.add("opacity-0", "translate-y-4");
  }, 6000);
});
</script>

<script>

function toggleShareMenu(){
  const menu = document.getElementById("shareMenu");
  if(!menu) return;
  menu.classList.toggle("hidden");
}

function shareCafe(title, url){
  if(navigator.share){
    navigator.share({
      title: title,
      text: "Mir√° este caf√© en Gota ‚òï",
      url: url
    });
  }else{
    navigator.clipboard.writeText(url);
    alert("Link copiado üìã");
  }
}

</script>


<script>
function openQRModal(){
  const modal = document.getElementById("qrModal");

  // mostrar modal
  modal.classList.remove("hidden");
  modal.classList.add("flex");

  // URL review directa
  const url = window.location.origin + "{% url 'reviews:create_review' cafe.id %}";
  const qrApi = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(url);

  document.getElementById("qrImage").src = qrApi;
  document.getElementById("downloadQR").href = qrApi;
}

function closeQRModal(){
  const modal = document.getElementById("qrModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

// cerrar tocando fondo oscuro (UX pro)
document.addEventListener("click", function(e){
  const modal = document.getElementById("qrModal");
  if(!modal) return;

  if(e.target === modal){
    closeQRModal();
  }
});
</script>



{% endblock %}
