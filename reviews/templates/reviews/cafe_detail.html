{% extends "base.html" %}
{% load static %}

{% block meta %}
  <!-- Open Graph y Twitter -->
  <meta property="og:title" content="{{ cafe.name }} - CafeterÃ­a en {{ cafe.location }}" />
  <meta property="og:description" content="ReseÃ±as, fotos y ubicaciÃ³n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta property="og:image" content="{{ full_image_url }}" />
  {% endif %}
  <meta property="og:url" content="{{ full_page_url }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ cafe.name }} - CafeterÃ­a en {{ cafe.location }}" />
  <meta name="twitter:description" content="ReseÃ±as, fotos y ubicaciÃ³n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta name="twitter:image" content="{{ full_image_url }}" />
  {% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4">
  <h1 class="text-3xl font-bold mb-4">{{ cafe.name }}</h1>

  <div class="mb-4 text-gray-700 space-y-1">
    <p>ğŸ“ <strong>DirecciÃ³n:</strong> {{ cafe.address }}, {{ cafe.location }}</p>
    <p>â˜ <strong>TelÃ©fono:</strong> {{ cafe.phone }}</p>
    <a href="https://www.google.com/maps/search/?api=1&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}" target="_blank" class="text-blue-600 hover:underline">ğŸ“ Ver en Google Maps</a>
  </div>

  <p class="mb-4">
    ğŸŒŸ <strong>Plan actual:</strong>
    {% if cafe.visibility_level == 2 %}
      <span class="text-yellow-600 font-bold">â˜•â˜• Plan Maestro</span>
    {% elif cafe.visibility_level == 1 %}
      <span class="text-blue-500 font-bold">â˜• Plan Barista</span>
    {% else %}
      <span class="text-gray-500 font-bold">â˜• Gratuito</span>
    {% endif %}
  </p>

  {% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
    <h3 class="text-xl font-semibold mb-2">ğŸ“¸ Fotos del lugar</h3>
    <div class="flex flex-wrap gap-4 mb-6 justify-center sm:justify-start">
      {% if cafe.photo1 %}<img src="{{ cafe.photo1.url }}" alt="{{ cafe.photo1_title }}" class="w-full sm:w-64 rounded shadow">{% endif %}
      {% if cafe.photo2 %}<img src="{{ cafe.photo2.url }}" alt="{{ cafe.photo2_title }}" class="w-full sm:w-64 rounded shadow">{% endif %}
      {% if cafe.photo3 %}<img src="{{ cafe.photo3.url }}" alt="{{ cafe.photo3_title }}" class="w-full sm:w-64 rounded shadow">{% endif %}
    </div>
  {% endif %}

  {% if average_rating %}
    <p class="mb-4"><strong>CalificaciÃ³n promedio:</strong> â˜• {{ average_rating|floatformat:1 }}</p>

    {% if best_review %}
      <div class="bg-yellow-100 p-4 rounded border-l-4 border-yellow-500 mb-6 animate-fade-in">
        <p class="font-semibold">â˜•âœ¨ ReseÃ±a destacada</p>
        <p class="text-sm text-gray-600">{{ best_review.user.username }} ({{ best_review.created_at|date:"d M Y" }}) â€” â˜• {{ best_review.rating|floatformat:1 }}</p>
        <p>â€œ{{ best_review.comment }}â€</p>
      </div>
    {% endif %}
  {% else %}
    <p class="mb-4"><strong>CalificaciÃ³n promedio:</strong> Sin reseÃ±as todavÃ­a.</p>
  {% endif %}

  {% if user.is_authenticated %}
    <form method="post" action="{% url 'toggle_favorite' cafe.id %}" class="mb-4">{% csrf_token %}
      <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-all">
        {% if user in cafe.favorites.all %}
          ğŸ’” Quitar de favoritos
        {% else %}
          â¤ï¸ Agregar a favoritos
        {% endif %}
      </button>
    </form>
  {% endif %}

  <h3 class="text-xl font-semibold mt-6 mb-2">ReseÃ±as:</h3>
  <ul class="space-y-4">
    {% for review in reviews %}
      <li class="bg-white p-4 rounded shadow animate-fade-in">
        <div class="flex justify-between items-center mb-2">
          <strong>{{ review.user.username }}</strong>
          <span class="text-sm text-gray-500">{{ review.created_at|date:"d M Y" }}</span>
        </div>
        <p class="mb-1">â˜• {{ review.rating|floatformat:1 }}</p>
        <p class="mb-2">{{ review.comment }}</p>

        {% if review.owner_reply %}
          <div class="bg-gray-100 p-3 rounded">
            <strong>Respuesta del dueÃ±o:</strong>
            <p>{{ review.owner_reply }}</p>
          </div>
        {% endif %}

        {% if user.is_authenticated and user == cafe.owner %}
          <form method="post" action="{% url 'reply_review' review.id %}" class="mt-2">{% csrf_token %}
            <textarea name="reply" rows="2" class="w-full p-2 border rounded">{{ review.owner_reply }}</textarea>
            <button type="submit" class="mt-1 bg-primary text-white px-3 py-1 rounded">Guardar respuesta</button>
          </form>
        {% endif %}
      </li>
    {% empty %}
      <li class="text-gray-500">No hay reseÃ±as aÃºn.</li>
    {% endfor %}
  </ul>

  {% if user.is_authenticated %}
    <button onclick="document.getElementById('modal-review').style.display='flex'" class="mt-6 bg-secondary text-white px-4 py-2 rounded">DejÃ¡ tu reseÃ±a</button>
  {% else %}
    <p class="mt-4">Para dejar una reseÃ±a necesitÃ¡s <a href="{% url 'account_login' %}?next={{ request.path }}" class="text-blue-600 hover:underline">iniciar sesiÃ³n</a>.</p>
  {% endif %}

  <!-- Modal -->
  <div id="modal-review" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded shadow-md w-full max-w-md relative animate-fade-in">
      <span onclick="document.getElementById('modal-review').style.display='none'" class="absolute top-2 right-3 cursor-pointer text-xl text-gray-700">&times;</span>
      <h3 class="text-xl font-semibold mb-2">DejÃ¡ tu reseÃ±a</h3>
      <form method="post">{% csrf_token %}
        {{ form.comment.label_tag }}<br>
        {{ form.comment }}<br>
        <label for="id_rating" class="block mt-2">â˜• CalificaciÃ³n:</label>
        <div class="flex gap-1 mt-1">
          {% for i in "54321" %}
            <input type="radio" name="rating" id="star{{ i }}" value="{{ i }}" class="hidden" {% if form.rating.value|stringformat:"s" == i %}checked{% endif %}>
            <label for="star{{ i }}" class="cursor-pointer text-xl">â˜•</label>
          {% endfor %}
        </div>
        <button type="submit" class="mt-4 bg-primary text-white px-4 py-2 rounded">Enviar</button>
      </form>
    </div>
  </div>

  {% if cafe.latitude and cafe.longitude %}
    <h3 class="text-xl font-semibold mt-10 mb-2">ğŸ“ UbicaciÃ³n</h3>
    <div id="map" class="h-[300px] sm:h-[400px] md:h-[500px] lg:h-[600px] w-full rounded shadow-lg mb-10"></div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const lat = parseFloat("{{ cafe.latitude|escapejs }}");
        const lon = parseFloat("{{ cafe.longitude|escapejs }}");
        const map = L.map('map').setView([lat, lon], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        L.marker([lat, lon]).addTo(map)
          .bindPopup("<strong>{{ cafe.name|escapejs }}</strong><br>{{ cafe.address|escapejs }}").openPopup();
      });
    </script>
  {% endif %}

  <!-- CafÃ©s vistos recientemente -->
  <section class="pt-12 pb-6 bg-orange-50 overflow-x-hidden mt-10">
    <h2 class="text-2xl font-semibold mb-6">ğŸ‘€ CafÃ©s vistos recientemente</h2>
    <div class="swiper-container" id="recently-viewed-container">
      <div class="swiper-wrapper" id="recently-viewed-list"></div>
      <div class="swiper-button-next text-brown-900"></div>
      <div class="swiper-button-prev text-brown-900"></div>
      <div class="swiper-pagination"></div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const visitedCafe = {
      id: {{ cafe.id }},
      name: "{{ cafe.name|escapejs }}",
      url: "{% url 'cafe_detail' cafe.id %}",
      photo1: {% if cafe.photo1 %}"{{ cafe.photo1.url }}"{% else %}null{% endif %},
      location: "{{ cafe.location|escapejs }}",
      address: "{{ cafe.address|escapejs }}"
    };
    let history = JSON.parse(localStorage.getItem("recently_viewed_cafes") || "[]");
    history = history.filter(c => c.id !== visitedCafe.id);
    history.unshift(visitedCafe);
    history = history.slice(0, 5);
    localStorage.setItem("recently_viewed_cafes", JSON.stringify(history));

    const container = document.getElementById("recently-viewed-list");
    if (!container) return;
    history.forEach(cafe => {
      const card = document.createElement("div");
      card.className = "swiper-slide w-[300px] bg-white rounded-lg shadow-md p-4 box-border";
      card.innerHTML = `
        <div class="flex gap-4 items-start">
          ${cafe.photo1 ? `<img src="${cafe.photo1}" alt="${cafe.name}" class="w-20 h-20 object-cover rounded-md" loading="lazy">` : ""}
          <div class="flex flex-col justify-between">
            <p class="font-semibold leading-snug">
              <a href="${cafe.url}" class="text-blue-600 hover:underline">${cafe.name}</a>
            </p>
            <p class="text-sm text-gray-700">${cafe.location}</p>
            <p class="text-xs text-gray-500">${cafe.address}</p>
          </div>
        </div>`;
      container.appendChild(card);
    });

    new Swiper("#recently-viewed-container", {
      slidesPerView: 'auto',
      spaceBetween: 16,
      navigation: {
        nextEl: ".swiper-button-next",
        prevEl: ".swiper-button-prev",
      },
      pagination: {
        el: ".swiper-pagination",
        clickable: true,
      },
    });
  });
</script>
{% endblock %}
