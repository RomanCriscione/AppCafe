{% extends "base.html" %}

{% block content %}
  <h1>Detalle de la cafeter√≠a</h1>
  <h2>{{ cafe.name }}</h2>
  üìç Direcci√≥n: {{ cafe.address }}, {{ cafe.location }}<br>
  ‚òé Tel√©fono: {{ cafe.phone }}<br>
  <p>
    <a href="https://www.google.com/maps/search/?api=1&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}"
      target="_blank"
      style="display: inline-block; background-color: #4285F4; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-weight: bold;">
      üìç Ver en Google Maps
    </a>

  {% if average_rating %}
    <p><strong>Calificaci√≥n promedio:</strong>
      {% for i in "12345" %}
        {% if average_rating|floatformat:1 >= forloop.counter %}
          <span style="opacity: 1.0">‚òï</span>
        {% elif average_rating|floatformat:1 >= forloop.counter0|add:0.25 and average_rating|floatformat:1 < forloop.counter %}
          <span style="opacity: 0.5">‚òï</span>
        {% elif average_rating|floatformat:1 >= forloop.counter0|add:0.1 and average_rating|floatformat:1 < forloop.counter0|add:0.25 %}
          <span style="opacity: 0.2">‚òï</span>
        {% else %}
          <span style="opacity: 0.1">‚òï</span>
        {% endif %}
      {% endfor %}
      ({{ average_rating|floatformat:1 }}/5)
    </p>
  {% else %}
    <p><strong>Calificaci√≥n promedio:</strong> Sin rese√±as todav√≠a.</p>
  {% endif %}

  {% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
    <h3>Fotos del lugar:</h3>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      {% if cafe.photo1 %}
        <img src="{{ cafe.photo1.url }}" alt="Foto 1 de {{ cafe.name }}" style="width: 200px;">
      {% endif %}
      {% if cafe.photo2 %}
        <img src="{{ cafe.photo2.url }}" alt="Foto 2 de {{ cafe.name }}" style="width: 200px;">
      {% endif %}
      {% if cafe.photo3 %}
        <img src="{{ cafe.photo3.url }}" alt="Foto 3 de {{ cafe.name }}" style="width: 200px;">
      {% endif %}
    </div>
  {% endif %}

  <h3>Rese√±as:</h3>
  <ul>
    {% for review in reviews %}
      <li>
        <strong>{{ review.user.username }}</strong> ({{ review.created_at|date:"d M Y" }})<br>
        {% for i in "12345" %}
          {% if review.rating >= forloop.counter %}
            <span style="opacity: 1.0">‚òï</span>
          {% elif review.rating >= forloop.counter0|add:0.25 and review.rating < forloop.counter %}
            <span style="opacity: 0.5">‚òï</span>
          {% elif review.rating >= forloop.counter0|add:0.1 and review.rating < forloop.counter0|add:0.25 %}
            <span style="opacity: 0.2">‚òï</span>
          {% else %}
            <span style="opacity: 0.1">‚òï</span>
          {% endif %}
        {% endfor %}
        <br>
        {{ review.comment }}
      </li>
    {% empty %}
      <li>A√∫n no hay rese√±as.</li>
    {% endfor %}
  </ul>

  {% if user.is_authenticated %}
    <h3>{% if existing_review %}Editar tu rese√±a{% else %}Dej√° tu rese√±a{% endif %}</h3>

    {% if form.errors %}
      <ul style="color: red;">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li>{{ field }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    {% endif %}

    <form method="post">
      {% csrf_token %}
      {{ form.comment.label_tag }}<br>
      {{ form.comment }}<br><br>

      {{ form.rating.label_tag }}<br>
      {{ form.rating }}<br><br>

      <button type="submit">
        {% if existing_review %}Actualizar{% else %}Enviar{% endif %}
      </button>
    </form>
  {% else %}
    <h3>Dej√° tu rese√±a</h3>
    <p>
      Para dejar una rese√±a necesit√°s
      <a href="{% url 'account_login' %}?next={{ request.path }}">iniciar sesi√≥n</a>.
    </p>
  {% endif %}
{% endblock %}
