{% extends "base.html" %}
{% load static %}

{% block meta %}
  <!-- Open Graph y Twitter -->
  <meta property="og:title" content="{{ cafe.name }} - Cafetería en {{ cafe.location }}" />
  <meta property="og:description" content="Reseñas, fotos y ubicación de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta property="og:image" content="{{ full_image_url }}" />
  {% endif %}
  <meta property="og:url" content="{{ full_page_url }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ cafe.name }} - Cafetería en {{ cafe.location }}" />
  <meta name="twitter:description" content="Reseñas, fotos y ubicación de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta name="twitter:image" content="{{ full_image_url }}" />
  {% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4">
  <h1 class="text-3xl font-bold mb-4">{{ cafe.name }}</h1>

  <div class="mb-4 text-gray-700 space-y-1">
    <p>📍 <strong>Dirección:</strong> {{ cafe.address }}, {{ cafe.location }}</p>
    <p>☎ <strong>Teléfono:</strong> {{ cafe.phone }}</p>
    <a href="https://www.google.com/maps/search/?api=1&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}" target="_blank" class="text-blue-600 hover:underline">📍 Ver en Google Maps</a>
  </div>

  <p class="mb-4">
    🌟 <strong>Plan actual:</strong>
    {% if cafe.visibility_level == 2 %}
      <span class="text-accent font-bold">☕☕ Plan Maestro</span>
    {% elif cafe.visibility_level == 1 %}
      <span class="text-primary font-bold">☕ Plan Barista</span>
    {% else %}
      <span class="text-gray-500 font-bold">☕ Gratuito</span>
    {% endif %}
  </p>

{% if cafe.tags.exists %}
  <div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">🏷️ Etiquetas destacadas del lugar:</h2>
    <div class="flex flex-wrap gap-2">
      {% for tag in cafe.tags.all %}
        <span class="bg-gray-200 text-gray-800 text-sm px-3 py-1 rounded-full">{{ tag.name }}</span>
      {% endfor %}
    </div>
  </div>
{% endif %}

{% if sensory_tags %}
  <div class="mt-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">🧠 Lo que otros destacan (etiquetas sensoriales)</h2>
    <div class="flex flex-wrap gap-2">
      {% for tag in sensory_tags %}
        <span class="bg-[#f0fdfa] text-accent text-sm px-3 py-1 rounded-full border border-accent">
          {{ tag.name }}
        </span>
      {% endfor %}
    </div>
  </div>
{% endif %}

{% include "reviews/includes/cafe_features.html" with cafe=cafe %}

{% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
  {% include "reviews/includes/cafe_photos.html" with cafe=cafe %}
{% endif %}

{% if average_rating %}
  <p class="mb-4"><strong>Calificación promedio:</strong> ☕ {{ average_rating|floatformat:1 }}</p>
  {% if best_review %}
    <div class="bg-[#f0fdfa] p-4 rounded border-l-4 border-accent mb-6 animate-fade-in">
      <p class="font-semibold text-accent">☕✨ Reseña destacada</p>
      <p class="text-sm text-gray-600">{{ best_review.user.username }} ({{ best_review.created_at|date:"d M Y" }}) — ☕ {{ best_review.rating|floatformat:1 }}</p>
      <p>“{{ best_review.comment }}”</p>
    </div>
  {% endif %}
{% else %}
  <p class="mb-4"><strong>Calificación promedio:</strong> Sin reseñas todavía.</p>
{% endif %}

{% if recommended_cafes %}
  {% include "reviews/includes/recommended_cafes.html" with recommended_cafes=recommended_cafes %}
{% endif %}

{% if user.is_authenticated %}
  <form method="post" action="{% url 'toggle_favorite' cafe.id %}" class="mb-4">{% csrf_token %}
    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-xl hover:bg-red-600 transition">
      {% if user in cafe.favorites.all %}
        💔 Quitar de favoritos
      {% else %}
        ❤️ Agregar a favoritos
      {% endif %}
    </button>
  </form>
{% endif %}

<h3 class="text-xl font-semibold mt-6 mb-4">Reseñas:</h3>
<div id="review-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8 transition-all duration-300 max-h-[1056px] overflow-hidden relative">
  {% for review in reviews %}
    {% include "reviews/_review_card.html" with review=review %}
  {% empty %}
    <p class="text-gray-500 text-sm col-span-full">Aún no hay reseñas para este café.</p>
  {% endfor %}
  {% if reviews|length > 3 %}
    <div id="fade-reviews" class="absolute bottom-0 left-0 w-full h-20 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
  {% endif %}
</div>

{% if user.is_authenticated %}
  <h3 class="text-xl font-semibold mt-8 mb-4">Dejá tu reseña rápida:</h3>
  {% include "reviews/_review_form.html" with form=form %}
{% else %}
  <p class="mt-8 text-gray-600">
    <a href="{% url 'account_login' %}" class="text-blue-600 hover:underline">Iniciá sesión</a> para dejar una reseña.
  </p>
{% endif %}

{% if reviews|length > 3 %}
  <button onclick="toggleReviews()" id="btn-reviews" class="text-sm text-blue-600 mt-1 hover:underline">Ver todas</button>
{% endif %}

<!-- Modal Wizard -->
<div id="modal-review" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden items-center justify-center z-50 opacity-0 transition-opacity duration-300">
  <div id="modal-content" class="bg-white w-full max-w-xl rounded-2xl shadow-xl p-6 relative transform scale-95 transition-all duration-300">
    <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 text-2xl transition">
      <i class="fas fa-times"></i>
    </button>
    {% include "reviews/includes/review_wizard_step1.html" %}
    {% include "reviews/includes/review_wizard_step2.html" with tag_choices=tag_choices %}
  </div>
</div>

<!-- Botón flotante -->
<button id="open-modal-btn" class="fixed bottom-6 right-6 z-50 bg-gradient-to-r from-primary to-blue-700 text-white font-semibold p-4 rounded-full shadow-lg hover:scale-110 transition-transform duration-300">
  <i class="fas fa-pen"></i>
</button>
{% endblock %}

{% block scripts %}
<script>
// -----------------------------
// ⭐ Estrellas de calificación
// -----------------------------
document.addEventListener("DOMContentLoaded", () => {
  const stars = document.querySelectorAll('#rating-stars label');
  const radios = document.querySelectorAll('#rating-stars input');
  const ratingLabel = document.getElementById('rating-label');

  const labels = {
    5: "Excelente",
    4: "Muy bueno",
    3: "Bueno",
    2: "Regular",
    1: "Malo"
  };

  function updateRatingVisual() {
    let selected = null;
    radios.forEach(radio => {
      if (radio.checked) selected = radio.value;
    });

    stars.forEach(star => {
      const value = star.dataset.value;
      if (selected && value === selected) {
        star.classList.add('text-yellow-400', 'scale-110', 'opacity-100');
        star.classList.remove('text-gray-300', 'opacity-50');
      } else {
        star.classList.remove('text-yellow-400', 'scale-110');
        star.classList.add('text-gray-300', 'opacity-50');
      }
    });

    ratingLabel.textContent = selected ? labels[selected] : "";
  }

  radios.forEach(radio => radio.addEventListener('change', updateRatingVisual));
  updateRatingVisual();
});

// -----------------------------
// 🔽 Mostrar/Ocultar reseñas
// -----------------------------
function toggleReviews() {
  const container = document.getElementById("review-container");
  const btn = document.getElementById("btn-reviews");
  const fade = document.getElementById("fade-reviews");

  if (container.classList.contains("max-h-[1056px]")) {
    container.classList.remove("max-h-[1056px]", "overflow-hidden");
    if (fade) fade.style.display = "none";
    btn.textContent = "Ver menos";
  } else {
    container.classList.add("max-h-[1056px]", "overflow-hidden");
    if (fade) fade.style.display = "block";
    btn.textContent = "Ver todas";
  }
}

// -----------------------------
// 🔽 Mostrar/Ocultar etiquetas
// -----------------------------
function toggleTags(index) {
  const container = document.getElementById(`tag-container-${index}`);
  const button = document.getElementById(`btn-${index}`);
  const fade = document.getElementById(`fade-${index}`);
  const isCollapsed = container.classList.contains("max-h-[96px]");

  if (isCollapsed) {
    container.classList.remove("max-h-[96px]", "overflow-hidden");
    if (fade) fade.style.display = "none";
    button.textContent = "Ver menos";
  } else {
    container.classList.add("max-h-[96px]", "overflow-hidden");
    if (fade) fade.style.display = "block";
    button.textContent = "Ver todas";
  }
}

// -----------------------------
// Modal animado
// -----------------------------
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("modal-review");
  const modalContent = document.getElementById("modal-content");
  const openBtn = document.getElementById("open-modal-btn");
  const closeBtn = document.getElementById("close-modal-btn");

  function openModal() {
    modal.classList.remove("hidden");
    setTimeout(() => {
      modal.classList.remove("opacity-0");
      modal.classList.add("opacity-100");
      modalContent.classList.remove("scale-95");
      modalContent.classList.add("scale-100");
    }, 10);
  }

  function closeModal() {
    modal.classList.remove("opacity-100");
    modal.classList.add("opacity-0");
    modalContent.classList.remove("scale-100");
    modalContent.classList.add("scale-95");
    setTimeout(() => modal.classList.add("hidden"), 300);
  }

  openBtn.addEventListener("click", openModal);
  closeBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });
});

// -----------------------------
// Wizard paso a paso + etiquetas
// -----------------------------
document.addEventListener("DOMContentLoaded", () => {
  const steps = document.querySelectorAll(".wizard-step");
  const nextButtons = document.querySelectorAll(".next-btn");
  const prevButtons = document.querySelectorAll(".prev-btn");
  const skipButtons = document.querySelectorAll(".skip-btn");
  const tagCategorySteps = document.querySelectorAll(".tag-category-step");

  let currentStepIndex = 0;
  let currentCategoryIndex = 0;

  function showStep(index) {
    steps.forEach((step, i) => {
      step.classList.add("hidden");
      step.classList.remove("active");
      if (i === index) {
        step.classList.remove("hidden");
        void step.offsetWidth; // reflow para animación
        step.classList.add("active");
      }
    });

    // Si estamos en el paso 2 (etiquetas), mostrar la primera categoría
    if (index === 1 && tagCategorySteps.length > 0) {
      tagCategorySteps.forEach((cat, i) =>
        cat.classList.toggle("hidden", i !== 0)
      );
      currentCategoryIndex = 0;
    }
  }

  function showNextCategory() {
    if (currentStepIndex === 1 && currentCategoryIndex < tagCategorySteps.length - 1) {
      tagCategorySteps[currentCategoryIndex].classList.add("hidden");
      currentCategoryIndex++;
      tagCategorySteps[currentCategoryIndex].classList.remove("hidden");
    } else {
      document.getElementById("review-form-step-1").submit();
    }
  }

  function showPrevCategory() {
    if (currentStepIndex === 1 && currentCategoryIndex > 0) {
      tagCategorySteps[currentCategoryIndex].classList.add("hidden");
      currentCategoryIndex--;
      tagCategorySteps[currentCategoryIndex].classList.remove("hidden");
    } else if (currentStepIndex === 1 && currentCategoryIndex === 0) {
      currentStepIndex = 0;
      showStep(currentStepIndex);
    }
  }

  nextButtons.forEach((btn) => {
    btn.addEventListener("click", function () {
      if (currentStepIndex === 0) {
        currentStepIndex = 1;
        showStep(currentStepIndex);
      } else {
        showNextCategory();
      }
    });
  });

  prevButtons.forEach((btn) => {
    btn.addEventListener("click", function () {
      showPrevCategory();
    });
  });

  skipButtons.forEach((btn) => {
    btn.addEventListener("click", function () {
      document.getElementById("review-form-step-1").submit();
    });
  });

  showStep(currentStepIndex); // Inicializar en el paso 1
});
</script>
{% endblock %}
