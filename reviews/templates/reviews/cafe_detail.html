{% extends "base.html" %}
{% load static cache %}

{% block meta %}
  <!-- Canonical -->
  <link rel="canonical" href="{{ full_page_url }}" />

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="place" />
  <meta property="og:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta property="og:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta property="og:image" content="{{ full_image_url }}" />
  {% endif %}
  <meta property="og:url" content="{{ full_page_url }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta name="twitter:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta name="twitter:image" content="{{ full_image_url }}" />
  {% endif %}

  {# Meta description din√°mica #}
  {% if cafe.description %}
    <meta name="description" content="{{ cafe.description|striptags|truncatechars:155 }}">
  {% elif best_review %}
    <meta name="description" content="{{ best_review.comment|striptags|truncatechars:155 }}">
  {% else %}
    <meta name="description" content="{{ cafe.name }} en {{ cafe.location }}: rese√±as, fotos y ubicaci√≥n.">
  {% endif %}

  <!-- JSON-LD: Breadcrumbs -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Inicio", "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'home' %}" },
      { "@type": "ListItem", "position": 2, "name": "Cafeter√≠as", "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'cafe_list' %}" },
      { "@type": "ListItem", "position": 3, "name": "{{ cafe.name|escapejs }}", "item": "{{ full_page_url }}" }
    ]
  }
  </script>

  <!-- JSON-LD: Cafe / LocalBusiness -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CafeOrCoffeeShop",
    "@id": "{{ full_page_url }}#identity",
    "name": "{{ cafe.name|escapejs }}",
    {% if full_image_url %}"image": ["{{ full_image_url }}"],{% endif %}
    "url": "{{ full_page_url }}",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "{{ cafe.address|default_if_none:''|escapejs }}",
      "addressLocality": "{{ cafe.location|default_if_none:''|escapejs }}",
      "addressCountry": "AR"
    }{% if cafe.phone %},
    "telephone": "{{ cafe.phone|escapejs }}"{% endif %}{% if cafe.latitude and cafe.longitude %},
    "geo": { "@type": "GeoCoordinates", "latitude": {{ cafe.latitude }}, "longitude": {{ cafe.longitude }} }{% endif %}{% if average_rating %},
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "{{ average_rating|floatformat:1 }}",
      "bestRating": "5",
      "worstRating": "1",
      "reviewCount": "{{ reviews|length }}"
    }{% endif %}{% if reviews and reviews|length > 0 %},
    "review": [
      {% for r in reviews|slice:":5" %}{
        "@type": "Review",
        "author": { "@type": "Person", "name": "{{ r.user.username|default:'Usuario'|escapejs }}" },
        "datePublished": "{{ r.created_at|date:'Y-m-d' }}",
        "reviewBody": "{{ r.comment|default_if_none:''|truncatechars:300|escapejs }}",
        "reviewRating": { "@type": "Rating", "ratingValue": "{{ r.rating }}", "bestRating": "5", "worstRating": "1" }
      }{% if not forloop.last %},{% endif %}{% endfor %}
    ]{% endif %}
  }
  </script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 space-y-8">

  <!-- T√≠tulo -->
  <h1 class="text-3xl font-bold animate-fade-in-up">{{ cafe.name }}</h1>

  <!-- Tarjeta de contacto (sin mostrar plan) -->
  <section class="surface p-4 rounded-xl animate-fade-in-up animate-delay-100">
    <div class="grid gap-4 sm:grid-cols-2">
      <div class="flex items-start gap-2">
        <span aria-hidden="true">üìç</span>
        <div>
          <div class="font-semibold">Direcci√≥n</div>
          <div class="text-sm text-gray-600">{{ cafe.address }}, {{ cafe.location }}</div>
        </div>
      </div>

      <div class="flex items-start gap-2">
        <span aria-hidden="true">‚òé</span>
        <div>
          <div class="font-semibold">Tel√©fono</div>
          <div class="text-sm text-gray-600">{{ cafe.phone|default:"‚Äî" }}</div>
        </div>
      </div>

      <div class="sm:col-span-2">
        <a href="https://www.google.com/maps/search/?api=1&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}"
           target="_blank" rel="noopener"
           class="btn btn-primary rounded-xl">
          üìç Ver en Google Maps
        </a>
      </div>
    </div>
  </section>

  <!-- Features (badges) -->
  <section class="mt-4 animate-fade-in-up animate-delay-150">
    {% include "reviews/includes/cafe_features.html" with cafe=cafe %}
  </section>

  <!-- Fotos -->
  {% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
    <div class="animate-fade-in-up animate-delay-200">
      {% include "reviews/includes/cafe_photos.html" with cafe=cafe %}
    </div>
  {% endif %}

  <!-- Etiquetas sensoriales (debajo de features/fotos) -->
  {% if sensory_tags %}
    <section class="surface p-4 rounded-xl animate-fade-in-up animate-delay-250">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">üß† Lo que otros destacan</h2>
      <ul class="tag-list">
        {% for tag in sensory_tags %}
          <li class="tag-item">
            <span class="tag-dot" aria-hidden="true"></span>
            <span class="tag-text">{{ tag.name }}</span>
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

  <!-- Calificaci√≥n + rese√±a destacada -->
  <div class="animate-fade-in-up animate-delay-300">
    {% if average_rating %}
      <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> ‚òï {{ average_rating|floatformat:1 }}</p>
      {% if best_review %}
        <div class="bg-[#f0fdfa] p-4 rounded border-l-4 border-accent mb-6 animate-fade-in">
          <p class="font-semibold text-accent">‚òï‚ú® Rese√±a destacada</p>
          <p class="text-sm text-gray-600">{{ best_review.user.username }} ({{ best_review.created_at|date:"d M Y" }}) ‚Äî ‚òï {{ best_review.rating|floatformat:1 }}</p>
          <p>‚Äú{{ best_review.comment }}‚Äù</p>
        </div>
      {% endif %}
    {% else %}
      <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> Sin rese√±as todav√≠a.</p>
    {% endif %}
  </div>

  <!-- Rese√±as -->
  <h3 class="text-xl font-semibold mt-6 mb-4 animate-fade-in-up animate-delay-400">Rese√±as:</h3>

  {% cache 600 cafe_reviews_list cafe.id %}
    <div id="review-container"
         class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 transition-all duration-300 max-h-[1056px] overflow-hidden relative animate-fade-in-up animate-delay-500">
      {% for review in reviews %}
        {% include "reviews/_review_card.html" with review=review %}
      {% empty %}
        <p class="text-gray-500 text-sm col-span-full">
          {{ ui_messages.no_reviews }}
        </p>
      {% endfor %}
      {% if reviews|length > 3 %}
        <div id="fade-reviews"
             class="absolute bottom-0 left-0 w-full h-20 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
      {% endif %}
    </div>

    {% if reviews|length > 3 %}
      <button
        onclick="toggleReviews()" id="btn-reviews"
        class="btn btn-outline btn-sm mt-2 animate-fade-in-up animate-delay-600"
      >
        Ver todas
      </button>
    {% endif %}
  {% endcache %}

  <!-- Favorito -->
  {% if user.is_authenticated %}
    <form method="post" action="{% url 'toggle_favorite' cafe.id %}" class="mb-4 animate-fade-in-up animate-delay-700">{% csrf_token %}
      <button type="submit" class="btn btn-danger rounded-xl">
        {% if user in cafe.favorites.all %} üíî Quitar de favoritos {% else %} ‚ù§Ô∏è Agregar a favoritos {% endif %}
      </button>
    </form>
  {% endif %}

  <!-- Modal Wizard -->
  <div id="modal-review"
       class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 opacity-0 transition-opacity duration-300 flex items-center justify-center">
    <div id="modal-content"
         class="bg-white w-full max-w-xl rounded-2xl shadow-xl p-6 relative transform scale-95 transition-all duration-300">
      <button id="close-modal-btn"
              class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 text-2xl transition">
        <i class="fas fa-times"></i>
      </button>

      <!-- Contenedor pasos -->
      <div id="wizard-steps" class="transition-transform duration-500 ease-in-out">
        {% include "reviews/includes/review_wizard_step1.html" %}
        {% include "reviews/includes/review_wizard_step2.html" with tag_choices=tag_choices %}
      </div>

      <!-- Mensaje de confirmaci√≥n -->
      <div id="thank-you-message" class="hidden text-center py-6">
        <h2 class="text-2xl font-semibold text-green-600 mb-4">¬°Gracias por tu rese√±a! ‚òï</h2>
        <p class="text-gray-700">Tu opini√≥n nos ayuda a mejorar la experiencia de todos.</p>
      </div>
    </div>
  </div>

  <!-- Bot√≥n flotante -->
  <button id="open-modal-btn"
          class="fixed bottom-6 right-6 z-50 bg-gradient-to-r from-primary to-blue-700 text-white font-semibold px-5 py-3 rounded-full shadow-lg hover:scale-110 transition-transform duration-300 flex items-center gap-2">
    <i class="fas fa-pen"></i>
    <span class="hidden sm:inline">Dej√° tu rese√±a</span>
  </button>

</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
  // ‚≠ê Estrellas de calificaci√≥n (si us√°s el widget de estrellas en el wizard)
  document.addEventListener("DOMContentLoaded", () => {
    const stars = document.querySelectorAll('#rating-stars label');
    const radios = document.querySelectorAll('#rating-stars input');
    const ratingLabel = document.getElementById('rating-label');
    if (!stars.length || !radios.length || !ratingLabel) return;

    const labels = { 5: "Excelente", 4: "Muy bueno", 3: "Bueno", 2: "Regular", 1: "Malo" };

    function updateRatingVisual() {
      const selected = Array.from(radios).find(r => r.checked)?.value;
      stars.forEach(star => {
        const value = star.dataset.value;
        star.classList.toggle('text-yellow-400', selected == value);
        star.classList.toggle('scale-110', selected == value);
        star.classList.toggle('opacity-100', selected == value);
        star.classList.toggle('text-gray-300', selected != value);
        star.classList.toggle('opacity-50', selected != value);
      });
      ratingLabel.textContent = selected ? labels[selected] : "";
    }
    radios.forEach(radio => radio.addEventListener('change', updateRatingVisual));
    updateRatingVisual();
  });

  // Mostrar/Ocultar TODAS las rese√±as (bot√≥n debajo del grid)
  function toggleReviews() {
    const container = document.getElementById("review-container");
    const btn = document.getElementById("btn-reviews");
    const fade = document.getElementById("fade-reviews");
    if (!container || !btn) return;

    const collapsed = container.classList.contains("max-h-[1056px]");
    container.classList.toggle("max-h-[1056px]", !collapsed);
    container.classList.toggle("overflow-hidden", !collapsed);
    if (fade) fade.style.display = collapsed ? "block" : "none";
    btn.textContent = collapsed ? "Ver todas" : "Ver menos";
  }

  // ‚ÄúVer m√°s / Ver menos‚Äù dentro de cada tarjeta de rese√±a (un √∫nico bloque)
  document.addEventListener('DOMContentLoaded', () => {
    // Si no definiste la variable en tu CSS, por defecto usamos 140px
    const MAX = parseInt(
      getComputedStyle(document.documentElement).getPropertyValue('--review-collapsed')
    ) || 140;

    document.querySelectorAll('.review-card').forEach(card => {
      const body = card.querySelector('.review-body');
      const text = card.querySelector('.review-text');
      const btn  = card.querySelector('.review-toggle');
      const fade = card.querySelector('.review-fade');
      if (!body || !text || !btn) return;

      function sync(){
        const needs = text.scrollHeight > MAX + 8;
        body.classList.toggle('collapsible', needs);
        body.classList.toggle('collapsed', needs);
        btn.hidden = !needs;
        if (fade) fade.style.display = needs ? 'block' : 'none';
        if (!needs) btn.textContent = 'Ver m√°s';
      }

      btn.addEventListener('click', () => {
        const collapsed = body.classList.contains('collapsed');
        body.classList.toggle('collapsed', !collapsed);
        btn.textContent = collapsed ? 'Ver menos' : 'Ver m√°s';
      });

      sync();
      let rto;
      window.addEventListener('resize', () => {
        clearTimeout(rto);
        rto = setTimeout(sync, 120);
      });
    });
  });

  // Modal + Wizard
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("modal-review");
    const modalContent = document.getElementById("modal-content");
    const openBtn = document.getElementById("open-modal-btn");
    const closeBtn = document.getElementById("close-modal-btn");
    const thankYouMessage = document.getElementById("thank-you-message");
    const wizardStepsContainer = document.getElementById("wizard-steps");

    if (!modal || !modalContent || !openBtn || !closeBtn || !wizardStepsContainer || !thankYouMessage) return;

    function openModal() {
      modal.setAttribute("aria-hidden", "false");
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      setTimeout(() => {
        modal.classList.replace("opacity-0", "opacity-100");
        modalContent.classList.replace("scale-95", "scale-100");
        modalContent.focus();
      }, 10);
    }
    function closeModal() {
      modal.setAttribute("aria-hidden", "true");
      modal.classList.replace("opacity-100", "opacity-0");
      modalContent.classList.replace("scale-100", "scale-95");
      setTimeout(() => {
        modal.classList.remove("flex");
        modal.classList.add("hidden");
        wizardStepsContainer.classList.remove("hidden");
        thankYouMessage.classList.add("hidden");
      }, 300);
    }

    openBtn.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
  });
  </script>
{% endblock %}
