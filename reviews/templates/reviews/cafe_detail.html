{% extends "base.html" %}
{% load static %}

{% block meta %}
  <!-- Canonical -->
  <link rel="canonical" href="{{ full_page_url }}" />

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta property="og:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta property="og:image" content="{{ full_image_url }}" />
  {% endif %}
  <meta property="og:url" content="{{ full_page_url }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ cafe.name }} - Cafeter√≠a en {{ cafe.location }}" />
  <meta name="twitter:description" content="Rese√±as, fotos y ubicaci√≥n de {{ cafe.name }}." />
  {% if full_image_url %}
    <meta name="twitter:image" content="{{ full_image_url }}" />
  {% endif %}

  <!-- JSON-LD: Breadcrumbs -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Inicio",
        "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'home' %}"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Cafeter√≠as",
        "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'cafe_list' %}"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": "{{ cafe.name|escapejs }}",
        "item": "{{ full_page_url }}"
      }
    ]
  }
  </script>
{% endblock %}


{% block content %}
<div class="max-w-4xl mx-auto px-4 space-y-8">

  <!-- T√≠tulo -->
  <h1 class="text-3xl font-bold animate-fade-in-up">{{ cafe.name }}</h1>

  <!-- Informaci√≥n b√°sica -->
  <div class="mb-4 text-gray-700 space-y-1 animate-fade-in-up animate-delay-100">
    <p>üìç <strong>Direcci√≥n:</strong> {{ cafe.address }}, {{ cafe.location }}</p>
    <p>‚òé <strong>Tel√©fono:</strong> {{ cafe.phone }}</p>
    <a href="https://www.google.com/maps/search/?api=1&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}"
        target="_blank"
        class="text-blue-600 hover:underline">
        üìç Ver en Google Maps
    </a>
  </div>

  <!-- Plan -->
  <p class="mb-4 animate-fade-in-up animate-delay-200">
    üåü <strong>Plan actual:</strong>
    {% if cafe.visibility_level == 2 %}
      <span class="text-accent font-bold">‚òï‚òï Plan Maestro</span>
    {% elif cafe.visibility_level == 1 %}
      <span class="text-primary font-bold">‚òï Plan Barista</span>
    {% else %}
      <span class="text-gray-500 font-bold">‚òï Gratuito</span>
    {% endif %}
  </p>

  <!-- Etiquetas destacadas -->
  {% if cafe.tags.all|length %}
    <div class="animate-fade-in-up animate-delay-300">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">üè∑Ô∏è Etiquetas destacadas del lugar:</h2>
      <div class="flex flex-wrap gap-2">
        {% for tag in cafe.tags.all %}
          <span class="bg-gray-200 text-gray-800 text-sm px-3 py-1 rounded-full">{{ tag.name }}</span>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- Etiquetas sensoriales -->
  {% if sensory_tags %}
    <div class="animate-fade-in-up animate-delay-400">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">üß† Lo que otros destacan (etiquetas sensoriales)</h2>
      <div class="flex flex-wrap gap-2">
        {% for tag in sensory_tags %}
          <span class="bg-[#f0fdfa] text-accent text-sm px-3 py-1 rounded-full border border-accent">{{ tag.name }}</span>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- Features -->
  <div class="animate-fade-in-up animate-delay-500">
    {% include "reviews/includes/cafe_features.html" with cafe=cafe %}
  </div>

  <!-- Fotos -->
  {% if cafe.photo1 or cafe.photo2 or cafe.photo3 %}
    <div class="animate-fade-in-up animate-delay-600">
      {% include "reviews/includes/cafe_photos.html" with cafe=cafe %}
    </div>
  {% endif %}

  <!-- Calificaci√≥n -->
  <div class="animate-fade-in-up animate-delay-700">
    {% if average_rating %}
      <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> ‚òï {{ average_rating|floatformat:1 }}</p>
      {% if best_review %}
        <div class="bg-[#f0fdfa] p-4 rounded border-l-4 border-accent mb-6 animate-fade-in">
          <p class="font-semibold text-accent">‚òï‚ú® Rese√±a destacada</p>
          <p class="text-sm text-gray-600">{{ best_review.user.username }} ({{ best_review.created_at|date:"d M Y" }}) ‚Äî ‚òï {{ best_review.rating|floatformat:1 }}</p>
          <p>‚Äú{{ best_review.comment }}‚Äù</p>
        </div>
      {% endif %}
    {% else %}
      <p class="mb-4"><strong>Calificaci√≥n promedio:</strong> Sin rese√±as todav√≠a.</p>
    {% endif %}
  </div>

  <!-- Recomendados -->
  {% if recommended_cafes %}
    <div class="animate-fade-in-up animate-delay-800">
      {% include "reviews/includes/recommended_cafes.html" with recommended_cafes=recommended_cafes %}
    </div>
  {% endif %}

  <!-- Favorito -->
  {% if user.is_authenticated %}
    <form method="post" action="{% url 'toggle_favorite' cafe.id %}" class="mb-4 animate-fade-in-up animate-delay-900">{% csrf_token %}
      <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-xl hover:bg-red-600 transition">
        {% if user in cafe.favorites.all %}
          üíî Quitar de favoritos
        {% else %}
          ‚ù§Ô∏è Agregar a favoritos
        {% endif %}
      </button>
    </form>
  {% endif %}

  <!-- Rese√±as -->
  <h3 class="text-xl font-semibold mt-6 mb-4 animate-fade-in-up animate-delay-1000">Rese√±as:</h3>
  <div id="review-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8 transition-all duration-300 max-h-[1056px] overflow-hidden relative animate-fade-in-up animate-delay-1100">
    {% for review in reviews %}
      {% include "reviews/_review_card.html" with review=review %}
    {% empty %}
      <p class="text-gray-500 text-sm col-span-full">
        {{ ui_messages.no_reviews }}
      </p>
    {% endfor %}
    {% if reviews|length > 3 %}
      <div id="fade-reviews" class="absolute bottom-0 left-0 w-full h-20 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
    {% endif %}
  </div>

  {% if reviews|length > 3 %}
    <button onclick="toggleReviews()" id="btn-reviews" class="text-sm text-blue-600 mt-1 hover:underline animate-fade-in-up animate-delay-1300">Ver todas</button>
  {% endif %}

  <!-- Modal Wizard -->
  <div id="modal-review"
       class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 opacity-0 transition-opacity duration-300 flex items-center justify-center">
    <div id="modal-content"
         class="bg-white w-full max-w-xl rounded-2xl shadow-xl p-6 relative transform scale-95 transition-all duration-300">
      <button id="close-modal-btn"
              class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 text-2xl transition">
        <i class="fas fa-times"></i>
      </button>

      <!-- Contenedor pasos -->
      <div id="wizard-steps" class="transition-transform duration-500 ease-in-out">
        {% include "reviews/includes/review_wizard_step1.html" %}
        {% include "reviews/includes/review_wizard_step2.html" with tag_choices=tag_choices %}
      </div>

      <!-- Mensaje de confirmaci√≥n -->
      <div id="thank-you-message" class="hidden text-center py-6">
        <h2 class="text-2xl font-semibold text-green-600 mb-4">¬°Gracias por tu rese√±a! ‚òï</h2>
        <p class="text-gray-700">Tu opini√≥n nos ayuda a mejorar la experiencia de todos.</p>
      </div>
    </div>
  </div>

  <!-- Bot√≥n flotante -->
  <button id="open-modal-btn"
          class="fixed bottom-6 right-6 z-50 bg-gradient-to-r from-primary to-blue-700 text-white font-semibold px-5 py-3 rounded-full shadow-lg hover:scale-110 transition-transform duration-300 flex items-center gap-2">
    <i class="fas fa-pen"></i>
    <span class="hidden sm:inline">Dej√° tu rese√±a</span>
  </button>

</div>
{% endblock %}

{# ==== DEJAR UN SOLO BLOQUE SCRIPTS ==== #}
{% block scripts %}
  {{ block.super }}
  <script>
  // -----------------------------
  // ‚≠ê Estrellas de calificaci√≥n
  // -----------------------------
  document.addEventListener("DOMContentLoaded", () => {
    const stars = document.querySelectorAll('#rating-stars label');
    const radios = document.querySelectorAll('#rating-stars input');
    const ratingLabel = document.getElementById('rating-label');
    if (!stars.length || !radios.length || !ratingLabel) return;

    const labels = { 5: "Excelente", 4: "Muy bueno", 3: "Bueno", 2: "Regular", 1: "Malo" };

    function updateRatingVisual() {
      const selected = Array.from(radios).find(r => r.checked)?.value;
      stars.forEach(star => {
        const value = star.dataset.value;
        star.classList.toggle('text-yellow-400', selected == value);
        star.classList.toggle('scale-110', selected == value);
        star.classList.toggle('opacity-100', selected == value);
        star.classList.toggle('text-gray-300', selected != value);
        star.classList.toggle('opacity-50', selected != value);
      });
      ratingLabel.textContent = selected ? labels[selected] : "";
    }
    radios.forEach(radio => radio.addEventListener('change', updateRatingVisual));
    updateRatingVisual();
  });

  // -----------------------------
  // Mostrar/Ocultar rese√±as
  // -----------------------------
  function toggleReviews() {
    const container = document.getElementById("review-container");
    const btn = document.getElementById("btn-reviews");
    const fade = document.getElementById("fade-reviews");
    if (!container || !btn) return;

    const collapsed = container.classList.contains("max-h-[1056px]");
    container.classList.toggle("max-h-[1056px]", !collapsed);
    container.classList.toggle("overflow-hidden", !collapsed);
    if (fade) fade.style.display = collapsed ? "block" : "none";
    btn.textContent = collapsed ? "Ver todas" : "Ver menos";
  }

  // -----------------------------
  // Modal animado + Wizard
  // -----------------------------
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("modal-review");
    const modalContent = document.getElementById("modal-content");
    const openBtn = document.getElementById("open-modal-btn");
    const closeBtn = document.getElementById("close-modal-btn");
    const thankYouMessage = document.getElementById("thank-you-message");
    const wizardStepsContainer = document.getElementById("wizard-steps");

    if (!modal || !modalContent || !openBtn || !closeBtn || !wizardStepsContainer || !thankYouMessage) return;

    function openModal() {
      modal.setAttribute("aria-hidden", "false");
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      setTimeout(() => {
        modal.classList.replace("opacity-0", "opacity-100");
        modalContent.classList.replace("scale-95", "scale-100");
        modalContent.focus();
      }, 10);
    }
    function closeModal() {
      modal.setAttribute("aria-hidden", "true");
      modal.classList.replace("opacity-100", "opacity-0");
      modalContent.classList.replace("scale-100", "scale-95");
      setTimeout(() => {
        modal.classList.remove("flex");
        modal.classList.add("hidden");
        // Reset wizard
        wizardStepsContainer.classList.remove("hidden");
        thankYouMessage.classList.add("hidden");
        currentStepIndex = 0;
        showStep(currentStepIndex);
      }, 300);
    }

    openBtn.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    // Wizard steps
    const steps = document.querySelectorAll(".wizard-step");
    const nextButtons = document.querySelectorAll(".next-btn");
    const prevButtons = document.querySelectorAll(".prev-btn");
    const skipButtons = document.querySelectorAll(".skip-btn");
    let currentStepIndex = 0;
    let tagCategorySteps = [];
    let currentCategoryIndex = 0;

    function showStep(index) {
      steps.forEach((step, i) => step.classList.toggle("hidden", i !== index));
      if (index === 1) {
        tagCategorySteps = document.querySelectorAll(".tag-category-step");
        tagCategorySteps.forEach((cat, i) => cat.classList.toggle("hidden", i !== 0));
        currentCategoryIndex = 0;
      }
    }
    function showNextCategory() {
      if (currentStepIndex === 1) {
        if (!tagCategorySteps.length) return;
        tagCategorySteps[currentCategoryIndex].classList.add("hidden");
        if (currentCategoryIndex < tagCategorySteps.length - 1) {
          currentCategoryIndex++;
          tagCategorySteps[currentCategoryIndex].classList.remove("hidden");
        } else {
          const form = document.getElementById("review-form-step-1");
          if (form) form.requestSubmit();
        }
      }
    }
    function showPrevCategory() {
      if (currentStepIndex === 1 && currentCategoryIndex > 0) {
        tagCategorySteps[currentCategoryIndex].classList.add("hidden");
        currentCategoryIndex--;
        tagCategorySteps[currentCategoryIndex].classList.remove("hidden");
      } else if (currentStepIndex === 1 && currentCategoryIndex === 0) {
        currentStepIndex = 0; showStep(currentStepIndex);
      }
    }
    nextButtons.forEach(btn => btn.addEventListener("click", () => {
      if (currentStepIndex === 0) { currentStepIndex = 1; showStep(currentStepIndex); }
      else { showNextCategory(); }
    }));
    prevButtons.forEach(btn => btn.addEventListener("click", showPrevCategory));
    skipButtons.forEach(btn => btn.addEventListener("click", () => {
      const form = document.getElementById("review-form-step-1");
      if (form) form.requestSubmit();
    }));

    // Enviar formulario (env√≠o real, sin prevenir)
    const reviewForm = document.getElementById("review-form-step-1");
    if (reviewForm) {
      reviewForm.addEventListener("submit", () => {
        const btns = reviewForm.querySelectorAll("button, input[type=submit]");
        btns.forEach(b => b.setAttribute("disabled", "disabled"));
      });
    }

    showStep(currentStepIndex);
  });

  // -----------------------------
  // Lightbox con protecci√≥n
  // -----------------------------
  let currentImageIndex = 0;

  function openLightbox(index) {
    const thumbs = document.querySelectorAll('.photo-thumb img');
    const images = Array.from(thumbs).filter(img => img && img.src);
    if (!images.length || index < 0 || index >= images.length) return;

    const selected = images[index];
    const img = document.getElementById("lightbox-image");
    const caption = document.getElementById("lightbox-caption");
    const modal = document.getElementById('lightbox-modal');
    if (!img || !caption || !modal) return;

    img.src = selected.src;
    img.alt = selected.alt || "";
    caption.textContent = selected.alt || "";

    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function changeLightboxImage(direction) {
    const thumbs = document.querySelectorAll('.photo-thumb img');
    const images = Array.from(thumbs).filter(img => img && img.src);
    if (!images.length) return;

    currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
    const newImage = images[currentImageIndex];

    const img = document.getElementById("lightbox-image");
    const caption = document.getElementById("lightbox-caption");
    if (!img || !caption) return;

    img.src = newImage.src;
    img.alt = newImage.alt || "";
    caption.textContent = newImage.alt || "";
  }

  (function initLightbox() {
    const closeBtn = document.getElementById('lightbox-close');
    const modal = document.getElementById('lightbox-modal');
    if (closeBtn && modal) {
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
      });
      modal.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          e.currentTarget.classList.remove('flex');
          e.currentTarget.classList.add('hidden');
        }
      });
      // Swipe en mobile
      let touchStartX = 0, touchEndX = 0;
      modal.addEventListener('touchstart', (e) => touchStartX = e.changedTouches[0].screenX);
      modal.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        if (touchEndX < touchStartX - 50) changeLightboxImage(1);
        if (touchEndX > touchStartX + 50) changeLightboxImage(-1);
      });
    }
  })();

  // -----------------------------
  // Scroll Reveal seguro
  // -----------------------------
  document.addEventListener("DOMContentLoaded", () => {
    const elements = document.querySelectorAll('.animate-fade-in-up');
    if (!elements.length) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.remove('opacity-0', 'translate-y-5');
          entry.target.classList.add('animate-fade-in-up-active');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });

    elements.forEach(el => {
      el.classList.add('opacity-0', 'translate-y-5');
      observer.observe(el);
    });
  });
  </script>
{% endblock %}

