{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<h1 class="text-2xl font-semibold mb-4">Editar cafeter√≠a: {{ cafe.name }}</h1>

{% if messages %}
  <ul class="mb-4">
    {% for message in messages %}
      <li class="{{ message.tags }} text-sm">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<form class="space-y-6" enctype="multipart/form-data" method="post" onsubmit="return validarDireccionAntesDeEnviar();">
  {% csrf_token %}

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="block font-medium text-sm mb-1">{{ form.name.label }}</label>
      {{ form.name|add_class:"w-full rounded border-gray-300 focus:ring focus:ring-blue-200" }}
    </div>
    <div>
      <label class="block font-medium text-sm mb-1">{{ form.address.label }}</label>
      {{ form.address|add_class:"w-full rounded border-gray-300 focus:ring focus:ring-blue-200" }}
      {% if form.address.errors %}
        <p class="text-red-600 text-sm mt-1">{{ form.address.errors.0 }}</p>
      {% endif %}
    </div>

    <div>
      <label class="block font-medium text-sm mb-1">{{ form.location.label }}</label>
      {{ form.location|add_class:"w-full rounded border-gray-300 focus:ring focus:ring-blue-200" }}
    </div>
    <div class="md:col-span-2">
      <label class="block font-medium text-sm mb-1">{{ form.description.label }}</label>
      {{ form.description|add_class:"w-full rounded border-gray-300 focus:ring focus:ring-blue-200" }}
    </div>
    <div>
      <label class="block font-medium text-sm mb-1">{{ form.phone.label }}</label>
      {{ form.phone|add_class:"w-full rounded border-gray-300 focus:ring focus:ring-blue-200" }}
    </div>
    <div>
      <label class="block font-medium text-sm mb-1">{{ form.google_maps_url.label }}</label>
      {{ form.google_maps_url|add_class:"w-full rounded border-gray-300 focus:ring focus:ring-blue-200" }}
    </div>
  </div>

  <h3 class="text-lg font-semibold mt-6">Fotos</h3>
<h3 class="text-lg font-semibold mt-6">Fotos</h3>

{% if cafe.photo1 %}
  <div>
    <p>Foto 1 actual:</p>
    <img alt="Foto 1" class="w-32 rounded shadow" loading="lazy" src="{{ cafe.photo1.url }}"/>
  </div>
{% endif %}
<div>
  <label>{{ form.photo1.label }}</label>
  {{ form.photo1|add_class:"block mt-1" }}
  {{ form.photo1_title|add_class:"w-full mt-1" }}
</div>

{% if cafe.photo2 %}
  <div>
    <p>Foto 2 actual:</p>
    <img alt="Foto 2" class="w-32 rounded shadow" loading="lazy" src="{{ cafe.photo2.url }}"/>
  </div>
{% endif %}
<div>
  <label>{{ form.photo2.label }}</label>
  {{ form.photo2|add_class:"block mt-1" }}
  {{ form.photo2_title|add_class:"w-full mt-1" }}
</div>

{% if cafe.photo3 %}
  <div>
    <p>Foto 3 actual:</p>
    <img alt="Foto 3" class="w-32 rounded shadow" loading="lazy" src="{{ cafe.photo3.url }}"/>
  </div>
{% endif %}
<div>
  <label>{{ form.photo3.label }}</label>
  {{ form.photo3|add_class:"block mt-1" }}
  {{ form.photo3_title|add_class:"w-full mt-1" }}
</div>

  <h3 class="text-lg font-semibold mt-6">Opciones</h3>
  <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
    {% for field in form %}
      {% if field.name|slice:":3" == "is_" or field.name|slice:":4" == "has_" or field.name|slice:":7" == "serves_" %}
        <label class="flex items-center">{{ field }} <span class="ml-2">{{ field.label }}</span></label>
      {% endif %}
    {% endfor %}
  </div>

  <h3 class="text-lg font-semibold mt-6">Etiquetas</h3>
  {{ form.tags|add_class:"w-full rounded border-gray-300 focus:ring focus:ring-blue-200" }}

  <h3 class="text-lg font-semibold mt-6">Ubicaci√≥n geogr√°fica</h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label>{{ form.latitude.label }}</label>
      {{ form.latitude|add_class:"w-full rounded border-gray-300 focus:ring focus:ring-blue-200" }}
    </div>
    <div>
      <label>{{ form.longitude.label }}</label>
      {{ form.longitude|add_class:"w-full rounded border-gray-300 focus:ring focus:ring-blue-200" }}
    </div>
  </div>

  <button type="button" onclick="mostrarMapaMobile()" class="block md:hidden bg-primary text-white px-4 py-2 rounded mb-4">
    üìç Mostrar mapa
  </button>

  <div class="h-80 mt-4 hidden md:block" id="map"></div>
  <p class="text-sm italic text-gray-600 mt-1" id="location-status"></p>

  <button class="mt-6 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700" type="submit">
    Guardar cambios
  </button>
</form>

<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const latInput = document.getElementById("id_latitude");
    const lonInput = document.getElementById("id_longitude");
    const addressInput = document.getElementById("id_address");
    const locationInput = document.getElementById("id_location");
    const locationStatus = document.getElementById("location-status");

    const initialLat = parseFloat(latInput.value) || -34.6037;
    const initialLon = parseFloat(lonInput.value) || -58.3816;
    let direccionGeolocalizada = !isNaN(initialLat) && !isNaN(initialLon);

    const map = L.map('map').setView([initialLat, initialLon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([initialLat, initialLon], { draggable: true }).addTo(map);

    function actualizarInputs(lat, lon) {
      latInput.value = lat.toFixed(6);
      lonInput.value = lon.toFixed(6);
    }

    function mostrarUbicacionTexto(lat, lon) {
      locationStatus.textContent = `üìç Ubicaci√≥n actualizada: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }

    marker.on("dragend", function () {
      const pos = marker.getLatLng();
      actualizarInputs(pos.lat, pos.lng);
      mostrarUbicacionTexto(pos.lat, pos.lng);
      direccionGeolocalizada = true;
    });

    function geolocalizarDireccion() {
      const direccion = addressInput?.value.trim();
      const localidad = locationInput?.value.trim();
      if (direccion.length > 5 && localidad.length > 1) {
        const fullQuery = `${direccion}, ${localidad}, Buenos Aires`;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullQuery)}`)
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              const { lat, lon } = data[0];
              map.setView([lat, lon], 16);
              marker.setLatLng([lat, lon]);
              actualizarInputs(parseFloat(lat), parseFloat(lon));
              mostrarUbicacionTexto(parseFloat(lat), parseFloat(lon));
              direccionGeolocalizada = true;
            } else {
              direccionGeolocalizada = false;
              alert("‚ùå No se pudo encontrar la direcci√≥n ingresada.");
              locationStatus.textContent = "‚ùå Direcci√≥n no reconocida.";
            }
          });
      }
    }

    if (addressInput) addressInput.addEventListener("blur", geolocalizarDireccion);
    if (locationInput) locationInput.addEventListener("change", geolocalizarDireccion);

    window.validarDireccionAntesDeEnviar = function () {
      const lat = parseFloat(latInput.value);
      const lon = parseFloat(lonInput.value);
      if (isNaN(lat) || isNaN(lon) || !direccionGeolocalizada) {
        alert("‚ö†Ô∏è Por favor, asegurate de ingresar una direcci√≥n v√°lida y que se haya ubicado correctamente en el mapa.");
        return false;
      }
      return true;
    };
  });

  function mostrarMapaMobile() {
    document.getElementById("map").classList.remove("hidden");
    document.getElementById("map").scrollIntoView({ behavior: "smooth" });
  }
</script>
{% endblock %}
