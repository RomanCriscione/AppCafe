{% extends "base.html" %}
{% load static %}

{% block content %}
  <h1>Editar cafeter√≠a: {{ cafe.name }}</h1>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" enctype="multipart/form-data" onsubmit="return validarDireccionAntesDeEnviar();">
    {% csrf_token %}
    {{ form.as_p }}

    <div>
      {% if cafe.photo1 %}
        <p>Foto 1 actual:</p>
        <img src="{{ cafe.photo1.url }}" alt="Foto 1" class="miniatura-cafe">
      {% endif %}
    </div>

    <div>
      {% if cafe.photo2 %}
        <p>Foto 2 actual:</p>
        <img src="{{ cafe.photo2.url }}" alt="Foto 2" class="miniatura-cafe">
      {% endif %}
    </div>

    <div>
      {% if cafe.photo3 %}
        <p>Foto 3 actual:</p>
        <img src="{{ cafe.photo3.url }}" alt="Foto 3" class="miniatura-cafe">
      {% endif %}
    </div>

    <!-- Mapa -->
    <div id="map" style="height: 400px; margin-top: 1rem;"></div>

    <!-- Mensaje din√°mico -->
    <p id="location-status" style="margin-top: 0.5rem; font-style: italic; color: #555;"></p>

    <button type="submit" class="btn">Guardar cambios</button>
  </form>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const latInput = document.getElementById("id_latitude");
    const lonInput = document.getElementById("id_longitude");
    const addressInput = document.getElementById("id_address");
    const locationInput = document.getElementById("id_location");
    const locationStatus = document.getElementById("location-status");

    const initialLat = parseFloat(latInput.value) || -34.6037;
    const initialLon = parseFloat(lonInput.value) || -58.3816;

    let direccionGeolocalizada = false;

    const map = L.map('map').setView([initialLat, initialLon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([initialLat, initialLon], { draggable: true }).addTo(map);

    function actualizarInputs(lat, lon) {
      latInput.value = lat.toFixed(6);
      lonInput.value = lon.toFixed(6);
    }

    function mostrarUbicacionTexto(lat, lon) {
      locationStatus.textContent = `üìç Ubicaci√≥n actualizada: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }

    marker.on("dragend", function () {
      const pos = marker.getLatLng();
      actualizarInputs(pos.lat, pos.lng);
      mostrarUbicacionTexto(pos.lat, pos.lng);
      direccionGeolocalizada = true;
    });

    addressInput.addEventListener("blur", function () {
      const direccion = addressInput.value;
      const localidad = locationInput ? locationInput.value : "";
      const fullQuery = `${direccion}, ${localidad}, Buenos Aires`;

      if (direccion.length > 5 && localidad.length > 1) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullQuery)}`)
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              const { lat, lon } = data[0];
              map.setView([lat, lon], 16);
              marker.setLatLng([lat, lon]);
              actualizarInputs(lat, lon);
              mostrarUbicacionTexto(parseFloat(lat), parseFloat(lon));
              direccionGeolocalizada = true;
            } else {
              direccionGeolocalizada = false;
              alert("‚ùå No se pudo encontrar la direcci√≥n ingresada.");
            }
          });
      }
    });

    locationInput.addEventListener("change", function () {
      const event = new Event('blur');
      addressInput.dispatchEvent(event);
});


    function validarDireccionAntesDeEnviar() {
      const lat = parseFloat(latInput.value);
      const lon = parseFloat(lonInput.value);
      if (isNaN(lat) || isNaN(lon) || !direccionGeolocalizada) {
        alert("‚ö†Ô∏è Por favor, asegurate de ingresar una direcci√≥n v√°lida y que se haya ubicado correctamente en el mapa.");
        return false;
      }
      return true;
    }
  </script>

{% endblock %}
