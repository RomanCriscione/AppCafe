{% extends "base.html" %}
{% load static %}

{% block content %}
  <h1>Agregar nueva cafeter√≠a</h1>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" enctype="multipart/form-data" onsubmit="return validarDireccionAntesDeEnviar();">
    {% csrf_token %}

    {{ form.name.label_tag }} {{ form.name }}<br>
    {{ form.address.label_tag }} {{ form.address }}<br>
    {{ form.location.label_tag }} {{ form.location }}<br>
    {{ form.description.label_tag }} {{ form.description }}<br>
    {{ form.phone.label_tag }} {{ form.phone }}<br>
    {{ form.google_maps_url.label_tag }} {{ form.google_maps_url }}<br>

    <h3>Fotos</h3>
    {{ form.photo1.label_tag }} {{ form.photo1 }} {{ form.photo1_title }}<br>
    {{ form.photo2.label_tag }} {{ form.photo2 }} {{ form.photo2_title }}<br>
    {{ form.photo3.label_tag }} {{ form.photo3 }} {{ form.photo3_title }}<br>

    <h3>Opciones</h3>
    {{ form.is_vegan_friendly }} Vegano friendly<br>
    {{ form.is_pet_friendly }} Pet friendly<br>
    {{ form.has_wifi }} WiFi<br>
    {{ form.has_outdoor_seating }} Mesas al aire libre<br>

    <h3>Etiquetas</h3>
    {{ form.tags }}

    <h3>Ubicaci√≥n geogr√°fica</h3>
    {{ form.latitude.label_tag }} {{ form.latitude }}<br>
    {{ form.longitude.label_tag }} {{ form.longitude }}<br>

    <div id="map" style="height: 400px; margin-top: 1rem;"></div>
    <p id="location-status" style="margin-top: 0.5rem; font-style: italic; color: #555;"></p>

    <button type="submit" class="btn">Guardar</button>
  </form>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const map = L.map('map').setView([-34.6037, -58.3816], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([-34.6037, -58.3816], { draggable: true }).addTo(map);

    const latInput = document.getElementById("id_latitude");
    const lonInput = document.getElementById("id_longitude");
    const addressInput = document.getElementById("id_address");
    const locationInput = document.getElementById("id_location");
    const locationStatus = document.getElementById("location-status");

    let direccionGeolocalizada = false;

    function actualizarInputs(lat, lon) {
      latInput.value = lat.toFixed(6);
      lonInput.value = lon.toFixed(6);
    }

    function mostrarUbicacionTexto(lat, lon) {
      locationStatus.textContent = `üìç Ubicaci√≥n actualizada: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }

    marker.on("dragend", function () {
      const pos = marker.getLatLng();
      actualizarInputs(pos.lat, pos.lng);
      mostrarUbicacionTexto(pos.lat, pos.lng);
      direccionGeolocalizada = true;
    });

    function geolocalizarDireccion() {
      const query = addressInput.value;
      const location = locationInput.value;
      if (query.length > 5 && location.length > 0) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', ' + location)}`)
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              const { lat, lon } = data[0];
              map.setView([lat, lon], 16);
              marker.setLatLng([lat, lon]);
              actualizarInputs(lat, lon);
              mostrarUbicacionTexto(parseFloat(lat), parseFloat(lon));
              direccionGeolocalizada = true;
            } else {
              direccionGeolocalizada = false;
              alert("‚ùå No se pudo encontrar la direcci√≥n ingresada.");
              locationStatus.textContent = "‚ùå Direcci√≥n no reconocida.";
            }
          });
      }
    }

    addressInput.addEventListener("blur", geolocalizarDireccion);
    locationInput.addEventListener("change", geolocalizarDireccion);

    function validarDireccionAntesDeEnviar() {
      const lat = parseFloat(latInput.value);
      const lon = parseFloat(lonInput.value);
      if (isNaN(lat) || isNaN(lon) || !direccionGeolocalizada) {
        alert("‚ö†Ô∏è Por favor, asegurate de ingresar una direcci√≥n v√°lida y que se haya ubicado correctamente en el mapa.");
        return false;
      }
      return true;
    }
  </script>
{% endblock %}
