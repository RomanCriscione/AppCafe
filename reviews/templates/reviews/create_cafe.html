{% extends "base.html" %}
{% load static %}

{% block content %}
  <h1>Agregar nueva cafeter√≠a</h1>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <div id="map" style="height: 400px; margin: 1rem 0; border-radius: 10px;"></div>
    <button type="submit" class="btn">Guardar</button>
  </form>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const latInput = document.getElementById("id_latitude");
      const lonInput = document.getElementById("id_longitude");

      const initialLat = parseFloat(latInput.value) || -34.6037;
      const initialLon = parseFloat(lonInput.value) || -58.3816;

      window.map = L.map("map").setView([initialLat, initialLon], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

      window.marker = L.marker([initialLat, initialLon], { draggable: true }).addTo(map);

      marker.on("dragend", function (e) {
        const position = marker.getLatLng();
        latInput.value = position.lat.toFixed(6);
        lonInput.value = position.lng.toFixed(6);
      });

      function obtenerCoordenadasDesdeDireccion() {
        const address = document.querySelector("#id_address")?.value;
        const location = document.querySelector("#id_location")?.value;

        if (!address || !location) return;

        const query = encodeURIComponent(address + ", " + location);
        const url = `https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`;

        fetch(url)
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              const result = data[0];
              latInput.value = result.lat;
              lonInput.value = result.lon;
              map.setView([result.lat, result.lon], 15);
              marker.setLatLng([result.lat, result.lon]);
            } else {
              alert("No se encontraron coordenadas.");
            }
          })
          .catch(err => alert("Error buscando coordenadas."));
      }

      document.querySelector("#id_address")?.addEventListener("blur", obtenerCoordenadasDesdeDireccion);
      document.querySelector("#id_location")?.addEventListener("blur", obtenerCoordenadasDesdeDireccion);
    });
  </script>
{% endblock %}

