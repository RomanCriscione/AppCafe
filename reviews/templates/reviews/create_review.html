{% extends "base.html" %}
{% load static tag_icons %}

{% block head_title %}
<title>Dejar reseña — {{ cafe.name }}</title>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-6">

  <!-- VOLVER -->
  <a href="{% url 'reviews:cafe_detail' cafe.id %}" class="text-blue-600 hover:underline text-sm">
    ← Volver a {{ cafe.name }}
  </a>

  <h1 class="text-2xl font-bold mt-2 mb-4">Contanos tu experiencia</h1>

  <form method="post" id="review-form">
    {% csrf_token %}

    <!-- ================================================= -->
    <!-- PASO 1 — RATING → COMENTARIO → PRECIO (opcional) -->
    <!-- ================================================= -->
    <section id="step-1" class="wizard-step">

      <h3 class="text-xl font-semibold mb-4">1) Calificación, comentario y precio</h3>

      <!-- ===================== -->
      <!-- RATING (Tazas)       -->
      <!-- ===================== -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">Calificación</label>

        <style>
          .cup-btn { width: 40px; height: 40px; display:grid; place-items:center; cursor:pointer; }
          .cup-icon { width: 32px; height:32px; }
          .cup-outline { stroke:#9aa0a6; stroke-width:1.6; fill:none; opacity:.9; }
          .cup-fill { fill:#f59e0b; opacity:0; transition:opacity .15s; }
          .cup-btn.active .cup-fill { opacity:1; }
          .cup-btn.dim .cup-outline { opacity:.35; }
        </style>

        <div id="rating-cups" class="flex gap-2">
          {% for n in "12345" %}
            <input type="radio" name="rating" id="rating_{{ forloop.counter }}"
                   value="{{ forloop.counter }}" class="sr-only">

            <label class="cup-btn" data-value="{{ forloop.counter }}" for="rating_{{ forloop.counter }}">
              <svg viewBox="0 0 24 24" class="cup-icon">
                <path class="cup-fill" d="M5 9h9v5a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4V9z"/>
                <g class="cup-outline">
                  <path d="M4 8h11v6a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5V8z"/>
                  <path d="M15 9h3a3 3 0 0 1 0 6h-2"/>
                </g>
              </svg>
            </label>
          {% endfor %}
        </div>
      </div>

      <!-- ===================== -->
      <!-- COMENTARIO            -->
      <!-- ===================== -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-1">Tu comentario</label>
        <textarea name="comment" rows="5" maxlength="600"
          class="w-full rounded-lg border border-gray-300 p-3 focus:ring-2 focus:ring-blue-500"
          placeholder="¿Qué te gustó? ¿Algo para mejorar?"></textarea>
      </div>

      <!-- ===================== -->
      <!-- PRECIO (opcional)     -->
      <!-- ===================== -->
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">
          ¿Cuánto pagaste por un capuccino mediano? (opcional)
        </label>

        <input type="number"
              name="precio_capuccino"
              min="1000"
              max="15000"
              placeholder="Ej: 3500"
              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-amber-400">

        <p class="text-sm text-gray-600 mt-1">
          Esto ayuda a otros usuarios, pero podés saltearlo.
        </p>
      </div>

      <div class="flex justify-end">
        <button type="button"
                class="next-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
          Siguiente →
        </button>
      </div>

    </section>

    <!-- ========================================= -->
    <!-- PASO 2 — ETIQUETAS (3 categorías)         -->
    <!-- ========================================= -->
    <section id="step-2" class="wizard-step hidden">
      <h3 class="text-xl font-semibold mb-4 text-center">2) Elegí las etiquetas que mejor describen tu experiencia</h3>

      <div id="tag-steps">
        {% for category, tags in tag_choices.items %}
          <div class="tag-step hidden">

            <h4 class="text-lg font-semibold mb-3 text-center">{{ category }}</h4>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              {% for t in tags %}
                <label class="flex items-start gap-2 cursor-pointer">
                  <input type="checkbox"
                         name="tags"
                         value="{{ t.id }}"
                         class="mt-1 h-4 w-4 text-blue-600">
                  <span>{{ t|tag_emoji }} {{ t.name }}</span>
                </label>
              {% endfor %}
            </div>

            <div class="flex justify-between mt-6">
              <button type="button"
                      class="prev-tag bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
                ← Volver
              </button>

              <div class="flex gap-2">
                <button type="button" class="skip-tag text-sm underline text-gray-600">Saltar</button>

                {% if forloop.last %}
                  <button type="button"
                          class="finish-tags bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    Finalizar reseña →
                  </button>
                {% else %}
                  <button type="button"
                          class="next-tag bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    Siguiente →
                  </button>
                {% endif %}
              </div>
            </div>

          </div>
        {% endfor %}
      </div>
    </section>

  </form>
</div>

<!-- =============================== -->
<!--       SCRIPT DEL WIZARD        -->
<!-- =============================== -->
<script>
(function () {
  const step1 = document.getElementById("step-1");
  const step2 = document.getElementById("step-2");
  const steps = Array.from(document.querySelectorAll(".tag-step"));

  let i = 0;

  // === RATING ===
  document.querySelectorAll("#rating-cups .cup-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const val = btn.dataset.value;
      document.getElementById(`rating_${val}`).checked = true;

      document.querySelectorAll("#rating-cups .cup-btn").forEach(b => {
        b.classList.toggle("active", b.dataset.value <= val);
        b.classList.toggle("dim", b.dataset.value > val);
      });
    });
  });

  // Paso 1 → Paso 2
  document.querySelector("#step-1 .next-btn").onclick = () => {
    step1.classList.add("hidden");
    step2.classList.remove("hidden");
    show(0);
  };

  // Mostrar categoría de etiquetas
  function show(k) {
    i = Math.max(0, Math.min(k, steps.length - 1));
    steps.forEach((s, idx) => s.classList.toggle("hidden", idx !== i));
  }

  // Navegación entre categorías
  steps.forEach((step, idx) => {
    step.querySelector(".next-tag")?.addEventListener("click", () => show(idx + 1));
    step.querySelector(".skip-tag")?.addEventListener("click", () => show(idx + 1));
    step.querySelector(".prev-tag")?.addEventListener("click", () => show(idx - 1));
  });

  // Finalizar reseña
  document.querySelectorAll(".finish-tags").forEach(btn =>
    btn.addEventListener("click", () => {
      document.getElementById("review-form").submit();
    })
  );

})();
</script>

{% endblock %}
