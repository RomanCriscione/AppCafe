{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load custom_filters %}

{% block content %}
<div class="max-w-xl mx-auto bg-white p-6 rounded-2xl shadow-md border border-gray-200">
  <form id="reviewForm" method="post">
    {% csrf_token %}

    <!-- Paso 1: Comentario y puntuaciÃ³n -->
    <div class="step" id="step-0">
      <h2 class="text-2xl font-bold mb-4 text-primary">ğŸ“ DejÃ¡ tu reseÃ±a</h2>

      <div class="mb-4">
        <label class="block font-medium mb-1">Comentario</label>
        {{ form.comment|add_class:"w-full rounded-xl border-gray-300 focus:ring-accent focus:border-accent shadow-sm" }}
      </div>

      <div class="mb-4">
        <label class="block font-medium mb-2">PuntuaciÃ³n</label>
        <div id="rating-stars" class="flex flex-row-reverse justify-start gap-1 text-2xl">
          {% for i in "54321" %}
            <input type="radio"
                   name="rating"
                   id="rating{{ i }}"
                   value="{{ i }}"
                   class="hidden peer"
                   {% if form.rating.value|stringformat:"s" == i %}checked{% endif %}>
            <label for="rating{{ i }}"
                   class="cursor-pointer text-gray-300 hover:text-accent transition-all peer-checked:text-accent"
                   data-value="{{ i }}">â˜•</label>
          {% endfor %}
        </div>
        <div id="rating-label" class="text-sm text-gray-600 mt-1"></div>
      </div>
    </div>

    <!-- Paso 2+: Etiquetas por categorÃ­a (usa tag_choices del contexto) -->
    {% for category, tags in tag_choices.items %}
      <div class="step hidden" id="step-{{ forloop.counter }}">
        <h3 class="text-lg font-semibold mb-3 text-gray-800">
          ğŸ§  Â¿QuerÃ©s agregar alguna etiqueta <span class="text-primary">{{ category }}</span>?
        </h3>

        <div class="grid grid-cols-1 gap-2">
          {% for tag in tags %}
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox"
                     name="tags"
                     value="{{ tag.id }}"
                     class="rounded border-gray-300 text-accent focus:ring-accent">
              {{ tag.name }}
            </label>
          {% empty %}
            <p class="text-sm text-gray-500">No hay etiquetas cargadas para esta categorÃ­a.</p>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    <!-- Botones de navegaciÃ³n -->
    <div class="flex justify-between mt-6">
      <button type="button" id="prevBtn"
              class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-xl shadow hidden transition">
        â† Anterior
      </button>

      <button type="button" id="nextBtn"
              class="bg-accent hover:bg-[#14b8a6] text-white px-4 py-2 rounded-xl shadow transition">
        Siguiente â†’
      </button>

      <button type="submit" id="submitBtn"
              class="bg-primary hover:bg-[#172b68] text-white px-4 py-2 rounded-xl shadow hidden transition">
        âœ… Enviar reseÃ±a
      </button>
    </div>
  </form>
</div>

<!-- Wizard + UX JS -->
<script>
  // ------- Estrellas (UI) -------
  document.addEventListener("DOMContentLoaded", () => {
    const starsWrap = document.getElementById('rating-stars');
    const ratingLabel = document.getElementById('rating-label');
    if (!starsWrap || !ratingLabel) return;

    const radios = starsWrap.querySelectorAll('input[type="radio"]');
    const stars = starsWrap.querySelectorAll('label[data-value]');
    const labels = { 5: "Excelente", 4: "Muy bueno", 3: "Bueno", 2: "Regular", 1: "Malo" };

    function updateRatingVisual() {
      const selected = Array.from(radios).find(r => r.checked)?.value;
      stars.forEach(star => {
        const v = star.dataset.value;
        star.classList.toggle('text-accent', selected == v);
        star.classList.toggle('text-gray-300', selected != v);
      });
      ratingLabel.textContent = selected ? labels[selected] : "";
    }
    radios.forEach(r => r.addEventListener('change', updateRatingVisual));
    updateRatingVisual();
  });

  // ------- Wizard -------
  const steps = document.querySelectorAll('.step');
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');
  const submitBtn = document.getElementById('submitBtn');
  let currentStep = 0;

  function showStep(index) {
    steps.forEach((step, i) => step.classList.toggle('hidden', i !== index));
    if (prevBtn && nextBtn && submitBtn) {
      prevBtn.classList.toggle('hidden', index === 0);
      nextBtn.classList.toggle('hidden', index === steps.length - 1);
      submitBtn.classList.toggle('hidden', index !== steps.length - 1);
    }
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      if (currentStep < steps.length - 1) {
        currentStep++;
        showStep(currentStep);
      }
    });
  }

  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
      }
    });
  }

  showStep(currentStep);
</script>
{% endblock %}
