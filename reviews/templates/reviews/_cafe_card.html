{% load static %}

<article class="card cafe-card focus:outline-none min-w-0 min-h-[450px] sm:min-h-[500px]">

  <!-- FOTO + OVERLAY -->
  <a href="{% url 'reviews:cafe_detail' cafe.id %}" class="block min-w-0 relative">

    <div class="w-full h-48 sm:h-60 lg:h-72 overflow-hidden rounded-t-[16px] relative">
      
      <!-- FOTO -->
      {% if cafe.photo1 and cafe.photo1.url %}
        <img
          src="{{ cafe.photo1.url }}"
          alt="{{ cafe.photo1_title|default:cafe.name }}"
          loading="lazy"
          decoding="async"
          fetchpriority="low"
          class="w-full h-full object-cover block"
        >
      {% else %}
        <img
          src="{% static 'images/coffee-hero.jpg' %}"
          alt="Foto no disponible ‚Äî {{ cafe.name }}"
          loading="lazy"
          decoding="async"
          fetchpriority="low"
          class="w-full h-full object-cover block"
        >
      {% endif %}

      <!-- OVERLAY: RATING IZQUIERDA + RESE√ëAS DERECHA -->
      <div class="absolute top-2 left-2 flex items-center">
        <div class="bg-white/90 backdrop-blur px-2 py-1 rounded-md shadow text-xs font-semibold flex items-center gap-1 text-gray-800">
          ‚òï 
          {% if cafe.avg_rating %}
            {{ cafe.avg_rating|floatformat:1 }}
          {% else %}
            ‚Äì
          {% endif %}
          <span class="text-gray-500">/ 5</span>
        </div>
      </div>

      <div class="absolute top-2 right-2">
        <div class="bg-white/90 backdrop-blur px-2 py-1 rounded-md shadow text-xs text-gray-700">
          ({{ cafe.num_reviews }} rese√±as)
        </div>
      </div>

    </div>
  </a>

  <!-- CUERPO DE LA CARD -->
  <div class="card-body">

    <!-- NOMBRE + UBICACI√ìN -->
    <a href="{% url 'reviews:cafe_detail' cafe.id %}" class="block hover:underline">
      <h3 class="card-title">{{ cafe.name }}</h3>

      {% if cafe.location %}
        <p class="card-sub">{{ cafe.location }}</p>
      {% elif cafe.neighborhood %}
        <p class="card-sub">{{ cafe.neighborhood }}</p>
      {% elif cafe.address %}
        <p class="card-sub">{{ cafe.address }}</p>
      {% endif %}
    </a>

    <div class="card-actions space-y-3">

      <!-- PRECIO (opcional) -->
      {% if cafe.precio_promedio %}
        <div class="text-sm text-amber-900 bg-amber-50 border border-amber-200 px-3 py-2 rounded-lg w-fit">
          ‚òï Capuccino mediano:
          <strong>${{ cafe.precio_promedio|floatformat:0 }}</strong>
        </div>
      {% endif %}

      {% if cafe.tags.exists %}
        <div class="flex flex-wrap gap-1">
          {% for tag in cafe.tags.all|slice:":3" %}
            <span class="bg-blue-100 text-blue-800 text-[11px] px-2 py-0.5 rounded-full">
              {{ tag.name }}
            </span>
          {% endfor %}
        </div>

        <span class="sr-only">
          Cafeter√≠a percibida como
          {% for tag in cafe.tags.all|slice:":3" %}
            {{ tag.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
          seg√∫n rese√±as reales.
        </span>
      {% endif %}


      <!-- FAVORITOS + VER -->
      <div class="flex items-center justify-between">

        <!-- FAVORITO -->
        <div class="flex items-center gap-2">
          {% if user.is_authenticated %}
            <form method="post"
                  action="{% url 'reviews:toggle_favorite' cafe.id %}"
                  class="fav-form js-ajax-post"
                  data-cafe="{{ cafe.id }}">
              {% csrf_token %}
              {% if cafe.is_favorite or user in cafe.favorites.all %}
                <button type="submit"
                        class="btn btn-success btn-sm js-fav-btn"
                        aria-pressed="true">‚ù§Ô∏è</button>
              {% else %}
                <button type="submit"
                        class="btn btn-outline btn-sm js-fav-btn"
                        aria-pressed="false">ü§ç</button>
              {% endif %}
            </form>
          {% else %}
            <a href="{% url 'account_login' %}?next={% url 'reviews:cafe_list' %}"
               class="btn btn-outline btn-sm"
               title="Iniciar sesi√≥n para guardar favoritos">ü§ç</a>
          {% endif %}
        </div>

          <button onclick="copyCafeLink('{{ request.scheme }}://{{ request.get_host }}{% url 'reviews:cafe_detail' cafe.id %}', this)"
                  class="text-xs text-gray-500 hover:text-black">
            üîó Compartir
          </button>



        <!-- VER -->
        <a href="{% url 'reviews:cafe_detail' cafe.id %}"
          class="btn btn-primary btn-sm">
          Ver
        </a>

      </div>

    </div>
  </div>

</article>
