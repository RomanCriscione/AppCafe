{% load static %}

<article class="card cafe-card focus:outline-none" tabindex="0">
  <a href="{% url 'reviews:cafe_detail' cafe.id %}" class="block">
    <div class="card-media">
      {% if cafe.photo1 and cafe.photo1.url %}
        <img src="{{ cafe.photo1.url }}"
             alt="{{ cafe.photo1_title|default:cafe.name }}"
             loading="lazy" decoding="async" fetchpriority="low">
      {% else %}
        <img src="{% static 'images/coffee-hero.jpg' %}"
             alt="Foto no disponible ‚Äî {{ cafe.name }}"
             loading="lazy" decoding="async" fetchpriority="low">
      {% endif %}
    </div>
  </a>

  <div class="card-body">
    <a href="{% url 'reviews:cafe_detail' cafe.id %}" class="block hover:underline">
      <h3 class="card-title">{{ cafe.name }}</h3>

      {% if cafe.location %}
        <p class="card-sub">{{ cafe.location }}</p>
      {% elif cafe.neighborhood %}
        <p class="card-sub">{{ cafe.neighborhood }}</p>
      {% elif cafe.address %}
        <p class="card-sub">{{ cafe.address }}</p>
      {% endif %}
    </a>

    <div class="card-actions">
      <div class="flex items-center gap-2">
        {% with avg=cafe.average_rating|default:0 %}
          <span class="badge" title="Calificaci√≥n promedio">
            ‚òï {{ avg|floatformat:1 }} / 5
          </span>
        {% endwith %}
        {% with rc=cafe.reviews_count|default:0 %}
          <span class="text-muted text-sm">({{ rc }} rese√±as)</span>
        {% endwith %}
      </div>

      <div class="flex items-center gap-2">
        {% if user.is_authenticated %}
          {# Fallback HTML normal + mejora con JS si est√° disponible #}
          <form
            method="post"
            action="{% url 'reviews:toggle_favorite' cafe.id %}"
            class="fav-form js-ajax-post"
            data-cafe="{{ cafe.id }}"
          >
            {% csrf_token %}
            {% if cafe.is_favorite or user in cafe.favorites.all %}
              <button type="submit"
                      class="btn btn-success btn-sm js-fav-btn"
                      aria-pressed="true"
                      data-icon="‚ù§Ô∏è"
                      data-icon-off="ü§ç"
                      data-label-on="Quitar"
                      data-label-off="Favorito">
                <span class="js-fav-icon" aria-hidden="true">‚ù§Ô∏è</span>
                <span class="sr-only">Quitar de favoritos</span>
              </button>
            {% else %}
              <button type="submit"
                      class="btn btn-outline btn-sm js-fav-btn"
                      aria-pressed="false"
                      data-icon="‚ù§Ô∏è"
                      data-icon-off="ü§ç"
                      data-label-on="Quitar"
                      data-label-off="Favorito">
                <span class="js-fav-icon" aria-hidden="true">ü§ç</span>
                <span class="sr-only">Agregar a favoritos</span>
              </button>
            {% endif %}
          </form>
        {% else %}
          <a href="{% url 'account_login' %}?next={% url 'reviews:cafe_list' %}"
             class="btn btn-outline btn-sm"
             title="Iniciar sesi√≥n para guardar favoritos">ü§ç</a>
        {% endif %}

        <a href="{% url 'reviews:cafe_detail' cafe.id %}" class="btn btn-primary btn-sm">
          Ver
        </a>
      </div>
    </div>
  </div>
</article>
