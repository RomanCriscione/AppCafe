{% extends "base.html" %}
{% load static %}

{% block content %}
  <div class="cafes-container">
    <!-- Panel lateral -->
    <aside class="filtros">
      <h2>üîç Filtros</h2>
      <form method="get">
        <label for="zona">Zona:</label>
        <select name="zona" id="zona">
          <option value="">Todas</option>
          {% for z in zonas_disponibles %}
            <option value="{{ z }}" {% if zona_seleccionada == z %}selected{% endif %}>{{ z }}</option>
          {% endfor %}
        </select>

        <label for="orden">Orden:</label>
        <select name="orden" id="orden">
          <option value="">Nombre</option>
          <option value="rating" {% if orden_actual == 'rating' %}selected{% endif %}>Puntuaci√≥n</option>
          <option value="reviews" {% if orden_actual == 'reviews' %}selected{% endif %}>M√°s rese√±as</option>
        </select>

        <fieldset>
          <legend>Caracter√≠sticas:</legend>
          <label><input type="checkbox" name="vegan" {% if filtros_aplicados.is_vegan_friendly %}checked{% endif %}> Vegano friendly</label><br>
          <label><input type="checkbox" name="pet" {% if filtros_aplicados.is_pet_friendly %}checked{% endif %}> Pet friendly</label><br>
          <label><input type="checkbox" name="wifi" {% if filtros_aplicados.has_wifi %}checked{% endif %}> WiFi</label><br>
          <label><input type="checkbox" name="outdoor" {% if filtros_aplicados.has_outdoor_seating %}checked{% endif %}> Mesas afuera</label>
        </fieldset>

        <fieldset style="margin-top: 1rem;">
          <legend>Etiquetas:</legend>
          {% for tag in tags %}
            <label>
              <input type="checkbox" name="tags" value="{{ tag.id }}" {% if tag.id in tags_seleccionados %}checked{% endif %}>
              {{ tag.name }}
            </label><br>
          {% endfor %}
        </fieldset>

        <button type="submit" class="btn-filtrar">Aplicar filtros</button>
      </form>
    </aside>

    <!-- Lista de caf√©s -->
    <section class="lista-cafes">
      <h1>Cafeter√≠as</h1>

      <!-- Bot√≥n para caf√©s cercanos SIEMPRE visible -->
      <button onclick="obtenerCafesCercanos()" class="btn">üìç Ver caf√©s cerca m√≠o</button>
      <ul id="cafes-cercanos" style="margin-top: 1rem;"></ul>

      {% if user.is_authenticated and user.is_owner %}
        <p>
          <a href="{% url 'create_cafe' %}" class="btn-agregar">‚ûï Agregar nueva cafeter√≠a</a>
        </p>
      {% endif %}

      <div class="cafe-list-grid">
        {% for cafe in cafes %}
          <div class="cafe-card">
            {% if cafe.photo1 %}
              <img src="{{ cafe.photo1.url }}" alt="Foto de {{ cafe.name }}" class="cafe-thumbnail">
            {% endif %}
            <div class="cafe-info">
              <h3>
                <a href="{% url 'cafe_detail' cafe.id %}">{{ cafe.name }}</a>
                {% if user.is_authenticated %}
                  <form method="post" action="{% url 'toggle_favorite' cafe.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="fav-btn" title="Favorito">
                      {% if user in cafe.favorites.all %}
                        ‚ù§Ô∏è
                      {% else %}
                        ü§ç
                      {% endif %}
                    </button>
                  </form>
                {% endif %}
              </h3>
              <p>üìç {{ cafe.address }}, {{ cafe.location }}</p>
              <p>‚òé {{ cafe.phone }}</p>
              <p>üìù {{ cafe.total_reviews }} rese√±as</p>
              <p>
                {% if cafe.average_rating %}
                  ‚òï {{ cafe.average_rating|floatformat:1 }}
                {% else %}
                  Sin puntuar
                {% endif %}
              </p>

              {% if cafe.tags.all %}
                <p>
                  üè∑Ô∏è Etiquetas:
                  {% for tag in cafe.tags.all %}
                    <span class="tag-label">{{ tag.name }}</span>
                  {% endfor %}
                </p>
              {% endif %}

              <a href="https://www.google.com/maps/search/?api=1&query={{ cafe.address|urlencode }}+{{ cafe.location|urlencode }}"
                target="_blank" class="btn-maps">üìç Ver en Google Maps</a>
            </div>
          </div>
        {% empty %}
          <p>No hay cafeter√≠as que coincidan con los filtros.</p>
        {% endfor %}
      </div>
    </section>
  </div>

  <!-- Script para ubicaci√≥n -->
  <script>
    function obtenerCafesCercanos() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          fetch(`/reviews/cafes/cercanos/?lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
              const lista = document.getElementById('cafes-cercanos');
              lista.innerHTML = "";
              if (data.length === 0) {
                lista.innerHTML = "<li>No se encontraron caf√©s cercanos.</li>";
              } else {
                data.forEach(cafe => {
                  const li = document.createElement("li");
                  li.innerHTML = `<a href="${cafe.url}">${cafe.name}</a> ‚Äì ${cafe.distance_km} km`;
                  lista.appendChild(li);
                });
              }
            });
        }, () => {
          alert("No se pudo obtener tu ubicaci√≥n.");
        });
      } else {
        alert("Tu navegador no soporta geolocalizaci√≥n.");
      }
    }
  </script>

  <style>
    .cafes-container {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
    }

    .filtros {
      flex: 1 1 250px;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      background: #f9f9f9;
      min-width: 220px;
    }

    .lista-cafes {
      flex: 3 1 600px;
    }

    .btn-filtrar {
      margin-top: 1rem;
      padding: 6px 12px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .cafe-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .cafe-card {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: #fff;
      align-items: flex-start;
    }

    .cafe-thumbnail {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }

    .cafe-info {
      flex: 1;
    }

    .fav-btn {
      font-size: 1.2rem;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      margin-left: 5px;
    }

    .btn-agregar {
      background-color: #4CAF50;
      color: white;
      padding: 8px 12px;
      text-decoration: none;
      border-radius: 5px;
    }

    .btn-maps {
      background-color: #4285F4;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      text-decoration: none;
      display: inline-block;
      margin-top: 0.5rem;
    }

    .tag-label {
      display: inline-block;
      background-color: #eee;
      padding: 2px 6px;
      margin: 2px;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    @media (max-width: 768px) {
      .cafes-container {
        flex-direction: column;
      }

      .filtros {
        width: 100%;
      }

      .cafe-card {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .cafe-thumbnail {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
{% endblock %}
