{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block meta %}
  <link rel="canonical" href="{{ request.build_absolute_uri }}">
  {% if page_obj %}
    {% if page_obj.has_previous %}
      <link rel="prev" href="?page={{ page_obj.previous_page_number }}{% if request.GET.zona %}&zona={{ request.GET.zona }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}">
    {% endif %}
    {% if page_obj.has_next %}
      <link rel="next" href="?page={{ page_obj.next_page_number }}{% if request.GET.zona %}&zona={{ request.GET.zona }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}">
    {% endif %}
  {% endif %}

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "itemListElement": [
      {% for c in cafes %}
      {
        "@type": "ListItem",
        "position": {{ forloop.counter }},
        "url": "{{ request.scheme }}://{{ request.get_host }}{% url 'cafe_detail' c.id %}"
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  }
  </script>
{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6 relative px-4">
  <!-- Bot√≥n de Filtros para Mobile -->
  <button id="toggle-filtros" class="lg:hidden fixed bottom-4 right-4 z-50 bg-primary text-white p-3 rounded-full shadow-lg hover:bg-secondary transition">
    üîç Filtros
  </button>

  <!-- Overlay -->
  <div id="filtros-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0 transition-opacity duration-300 lg:hidden"></div>

  <!-- Filtros -->
  <aside id="panel-filtros" class="lg:static fixed top-0 left-0 h-full w-4/5 max-w-xs bg-white p-4 rounded-lg shadow-lg z-50 transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:w-1/4 lg:h-auto lg:shadow-none overflow-auto">
    <div class="flex justify-between items-center lg:hidden mb-4">
      <h2 class="text-xl font-semibold">üîç Filtros</h2>
      <button id="cerrar-filtros" class="text-gray-600 hover:text-black text-2xl">&times;</button>
    </div>

    <form method="get" class="space-y-4">
      <div>
        <label for="zona" class="block font-medium">Zona:</label>
        <select name="zona" id="zona" class="w-full mt-1 p-2 border rounded">
          <option value="">Todas</option>
          {% for z in zonas_disponibles %}
            <option value="{{ z }}" {% if zona_seleccionada == z %}selected{% endif %}>{{ z }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="orden" class="block font-medium">Orden:</label>
        <select name="orden" id="orden" class="w-full mt-1 p-2 border rounded">
          <option value="algoritmo" {% if orden_actual == 'algoritmo' or not orden_actual %}selected{% endif %}>‚ú® Recomendadas</option>
          <option value="rating" {% if orden_actual == 'rating' %}selected{% endif %}>Puntuaci√≥n</option>
          <option value="reviews" {% if orden_actual == 'reviews' %}selected{% endif %}>M√°s rese√±as</option>
          <option value="" {% if orden_actual == '' %}selected{% endif %}>Nombre</option>
        </select>
      </div>

      <fieldset>
        <legend class="font-medium mb-2">Caracter√≠sticas del caf√©:</legend>
        {% for key, activo in campos_activos.items %}
          <label class="block">
            <input type="checkbox" name="{{ key }}" {% if activo %}checked{% endif %}>
            {{ key|replace:"_| "|capfirst }}
          </label>
        {% endfor %}
      </fieldset>

      <button type="submit" class="mt-4 bg-accent hover:bg-[#14b8a6] text-white px-4 py-2 rounded-xl transition-colors">
        Aplicar filtros
      </button>
    </form>
  </aside>

  <!-- Lista de Caf√©s -->
  <section class="lg:w-3/4 max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Cafeter√≠as</h1>
      <div class="flex gap-3 items-center">
        <form id="ubicacion-form" method="get" class="inline">
          <input type="hidden" name="orden" value="algoritmo">
          <input type="hidden" name="lat" id="lat">
          <input type="hidden" name="lon" id="lon">
          <button type="submit" class="bg-accent hover:bg-[#14b8a6] text-white px-3 py-2 rounded-xl text-sm transition-transform hover:scale-105 shadow">
            üìç Caf√©s cerca m√≠o
          </button>
        </form>
        {% if mostrar_boton_reset %}
          <a href="{% url 'cafe_list' %}" class="inline-block bg-gray-100 text-gray-800 px-3 py-2 rounded-xl hover:bg-gray-200 transition-colors">
            üîÑ Ver todos los caf√©s
          </a>
        {% endif %}
      </div>
    </div>

    {% include "reviews/includes/mapa_cafe_list.html" %}

    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for cafe in cafes %}
        <div class="bg-white rounded-2xl shadow-md hover:shadow-lg p-4 transition duration-200">
          <a href="{% url 'cafe_detail' cafe.id %}" class="block">
            {% if cafe.photo1 %}
              <img src="{{ cafe.photo1.url }}" alt="{{ cafe.name }}" class="w-full h-40 object-cover rounded-md mb-3" loading="lazy" decoding="async" width="800" height="533">
            {% else %}
              <div class="w-full h-40 bg-gray-200 flex items-center justify-center text-gray-500 rounded-md mb-3">
                Sin foto
              </div>
            {% endif %}
            <h3 class="text-lg font-semibold text-gray-800 line-clamp-1">{{ cafe.name }}</h3>
            <p class="text-sm text-gray-600 line-clamp-1">{{ cafe.location }}</p>
            <p class="text-accent text-sm mt-1">‚òï {{ cafe.average_rating|floatformat:1 }}/5</p>
          </a>
          <div class="mt-3">
            {% include "reviews/includes/cafe_features.html" with cafe=cafe %}
          </div>
        </div>
      {% empty %}
        <p class="text-center text-gray-600 mt-10">{{ ui_messages.no_results }}</p>
      {% endfor %}
    </div>

    {% if is_paginated %}
      <nav class="mt-8 flex items-center justify-center gap-2" aria-label="Paginaci√≥n de cafeter√≠as">
        {% if page_obj.has_previous %}
          <a rel="prev" href="?page={{ page_obj.previous_page_number }}{% if request.GET.zona %}&zona={{ request.GET.zona }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}"
             class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Anterior</a>
        {% endif %}
        <span class="px-3 py-2 text-sm text-gray-700">P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a rel="next" href="?page={{ page_obj.next_page_number }}{% if request.GET.zona %}&zona={{ request.GET.zona }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}"
             class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Siguiente</a>
        {% endif %}
      </nav>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    // Geolocalizaci√≥n "Caf√©s cerca m√≠o"
    (function () {
      const form = document.getElementById('ubicacion-form');
      const latEl = document.getElementById('lat');
      const lonEl = document.getElementById('lon');
      if (!form || !latEl || !lonEl) return;

      form.addEventListener('submit', function (e) {
        if (!navigator.geolocation) return;
        e.preventDefault();
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            latEl.value = pos.coords.latitude.toFixed(6);
            lonEl.value = pos.coords.longitude.toFixed(6);
            form.submit();
          },
          () => form.submit(),
          { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
        );
      });
    })();

    // Panel de filtros en mobile
    (function () {
      const toggle = document.getElementById('toggle-filtros');
      const overlay = document.getElementById('filtros-overlay');
      const panel = document.getElementById('panel-filtros');
      const cerrar = document.getElementById('cerrar-filtros');
      if (!toggle || !overlay || !panel || !cerrar) return;

      function open() {
        panel.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
        requestAnimationFrame(() => overlay.classList.add('opacity-100'));
      }
      function close() {
        panel.classList.add('-translate-x-full');
        overlay.classList.remove('opacity-100');
        setTimeout(() => overlay.classList.add('hidden'), 200);
      }

      toggle.addEventListener('click', open);
      cerrar.addEventListener('click', close);
      overlay.addEventListener('click', close);
    })();
  </script>
{% endblock %}
