{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block meta %}
  <link rel="canonical" href="{{ request.build_absolute_uri }}">
  {% if page_obj %}
    {% if page_obj.has_previous %}
      <link rel="prev" href="?page={{ page_obj.previous_page_number }}{% if request.GET.zona %}&zona={{ request.GET.zona }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}">
    {% endif %}
    {% if page_obj.has_next %}
      <link rel="next" href="?page={{ page_obj.next_page_number }}{% if request.GET.zona %}&zona={{ request.GET.zona }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}">
    {% endif %}
  {% endif %}

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "itemListElement": [
      {% for c in cafes %}
      { "@type": "ListItem", "position": {{ forloop.counter }}, "url": "{{ request.scheme }}://{{ request.get_host }}{% url 'reviews:cafe_detail' c.id %}" }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  }
  </script>
{% endblock %}

{% block content %}
<div class="page-cafe-list flex flex-col lg:flex-row gap-6 relative px-4 min-w-0">
  <!-- Bot√≥n filtros (mobile) -->
  <button id="toggle-filtros" class="lg:hidden fixed bottom-4 right-4 z-[1001] btn btn-primary rounded-full shadow-lg">
    üîç Filtros
  </button>

  <!-- Overlay filtros (mobile) -->
  <div id="filtros-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden opacity-0 transition-opacity duration-300 lg:hidden"></div>

  <!-- Panel filtros -->
  <aside id="panel-filtros" class="lg:static fixed top-0 left-0 h-full w-4/5 max-w-xs bg-white p-4 rounded-lg shadow-lg z-[1001] transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:w-1/4 lg:h-auto lg:shadow-none overflow-auto">
    <div class="flex justify-between items-center lg:hidden mb-4">
      <h2 class="text-xl font-semibold">üîç Filtros</h2>
      <button id="cerrar-filtros" class="text-gray-600 hover:text-black text-2xl">&times;</button>
    </div>

    <form method="get" class="space-y-4">
      <div>
        <label for="zona" class="block font-medium">Zona:</label>
        <select name="zona" id="zona" class="select mt-1">
          <option value="">Todas</option>
          {% for z in zonas_disponibles %}
            <option value="{{ z }}" {% if zona_seleccionada == z %}selected{% endif %}>{{ z }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="orden" class="block font-medium">Orden:</label>
        <select name="orden" id="orden" class="select mt-1">
          <option value="algoritmo" {% if orden_actual == 'algoritmo' or not orden_actual %}selected{% endif %}>‚ú® Recomendadas</option>
          <option value="rating" {% if orden_actual == 'rating' %}selected{% endif %}>Puntuaci√≥n</option>
          <option value="reviews" {% if orden_actual == 'reviews' %}selected{% endif %}>M√°s rese√±as</option>
          <option value="" {% if orden_actual == '' %}selected{% endif %}>Nombre</option>
        </select>
      </div>

      <fieldset>
        <legend class="font-medium mb-2">Caracter√≠sticas del caf√©:</legend>
        {% for key, activo in campos_activos.items %}
          <label class="block">
            <input type="checkbox" name="{{ key }}" {% if activo %}checked{% endif %}>
            {{ key|feature_label }}
          </label>
        {% endfor %}
      </fieldset>

      <button type="submit" class="mt-4 btn btn-primary rounded-xl w-full">Aplicar filtros</button>
    </form>
  </aside>

  <!-- Columna resultados -->
  <section class="lg:w-3/4 max-w-6xl mx-auto relative z-0 min-w-0">
    <a href="#resultados" class="sr-only">Saltar a resultados</a>
    <a href="#paginacion" class="sr-only">Saltar a paginaci√≥n</a>

    <div class="flex justify-between items-center mb-4">
      <h1 id="titulo-cafeterias" class="text-2xl font-bold">Cafeter√≠as</h1>
      <div class="flex gap-3 items-center">
        <a href="{% url 'reviews:mapa_cafes' %}"
          class="fixed bottom-5 right-5 z-40 bg-white text-brown hover:bg-brand-100 transition px-4 py-2 rounded-full shadow-md border border-brand-200 text-sm sm:text-base">
          üìç Ver mapa
        </a>
        <form id="ubicacion-form" method="get" class="inline">
          <input type="hidden" name="orden" value="algoritmo">
          <input type="hidden" name="lat" id="lat">
          <input type="hidden" name="lon" id="lon">
          <button type="submit" class="btn btn-primary rounded-xl text-sm">üìç Caf√©s cerca m√≠o</button>
        </form>
        {% if mostrar_boton_reset %}
          <a href="{% url 'reviews:cafe_list' %}" class="btn btn-ghost rounded-xl text-sm">üîÑ Ver todos los caf√©s</a>
        {% endif %}
      </div>
    </div>

    <!-- Skeleton inicial -->
    <div id="grid-skeleton" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 min-w-0">
      {% for _ in "123" %}
        <div class="card">
          <div class="skeleton h-44 w-full"></div>
          <div class="p-4 space-y-3">
            <div class="skeleton h-5 w-3/4"></div>
            <div class="skeleton h-4 w-1/2"></div>
            <div class="flex gap-2">
              <div class="skeleton h-6 w-16 rounded-full"></div>
              <div class="skeleton h-6 w-20 rounded-full"></div>
            </div>
            <div class="skeleton h-9 w-full"></div>
          </div>
        </div>
      {% endfor %}
    </div>

      <!-- Bot√≥n para ver mapa -->
  <div class="flex justify-end mb-4">
    <a href="{% url 'reviews:mapa_cafes' %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-amber-200 text-amber-900 font-semibold hover:bg-amber-300 transition-all shadow-sm">
      <i class="fas fa-map-marked-alt"></i> Ver mapa
    </a>
  </div>

  <!-- Grid real -->
  <div id="grid-cafes" class="hidden min-w-0" tabindex="-1" aria-labelledby="titulo-cafeterias">

      <div id="resultados" class="min-w-0">
        <div class="grid auto-rows-fr grid-cols-[repeat(auto-fit,minmax(280px,380px))] justify-center gap-6">
          {% for cafe in cafes %}
            {% include "reviews/_cafe_card.html" with cafe=cafe %}
          {% empty %}
            <div class="surface p-6 rounded-blob col-span-full">
              <p class="text-muted text-center">{{ ui_messages.no_results }}</p>
            </div>
          {% endfor %}
        </div>
      </div>

    </div>




      {% if is_paginated %}
        <nav id="paginacion" class="mt-8 flex items-center justify-center gap-2" aria-label="Paginaci√≥n de cafeter√≠as">
          {% if page_obj.has_previous %}
            <a rel="prev" href="?page={{ page_obj.previous_page_number }}{% if request.GET.zona %}&zona={{ request.GET.zona }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}"
               class="btn btn-outline btn-sm">‚Üê Anterior</a>
          {% else %}
            <span class="btn btn-ghost btn-sm" aria-disabled="true">‚Üê Anterior</span>
          {% endif %}

          <span class="text-muted text-sm px-2">P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

          {% if page_obj.has_next %}
            <a rel="next" href="?page={{ page_obj.next_page_number }}{% if request.GET.zona %}&zona={{ request.GET.zona }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}"
               class="btn btn-outline btn-sm">Siguiente ‚Üí</a>
          {% else %}
            <span class="btn btn-ghost btn-sm" aria-disabled="true">Siguiente ‚Üí</span>
          {% endif %}
        </nav>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    // Geolocalizaci√≥n
    (function () {
      const form = document.getElementById('ubicacion-form');
      const latEl = document.getElementById('lat');
      const lonEl = document.getElementById('lon');
      if (!form || !latEl || !lonEl) return;

      form.addEventListener('submit', function (e) {
        if (!navigator.geolocation) return;
        e.preventDefault();
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            latEl.value = pos.coords.latitude.toFixed(6);
            lonEl.value = pos.coords.longitude.toFixed(6);
            form.submit();
          },
          () => form.submit(),
          { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
        );
      });
    })();

    // Drawer filtros mobile
    (function () {
      const toggle = document.getElementById('toggle-filtros');
      const overlay = document.getElementById('filtros-overlay');
      const panel = document.getElementById('panel-filtros');
      const cerrar = document.getElementById('cerrar-filtros');
      if (!toggle || !overlay || !panel || !cerrar) return;

      function open() { panel.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); requestAnimationFrame(() => overlay.classList.add('opacity-100')); }
      function close() { panel.classList.add('-translate-x-full'); overlay.classList.remove('opacity-100'); setTimeout(() => overlay.classList.add('hidden'), 200); }

      toggle.addEventListener('click', open);
      cerrar.addEventListener('click', close);
      overlay.addEventListener('click', close);
    })();

    // Swap skeleton -> contenido real
    (function () {
      const sk = document.getElementById('grid-skeleton');
      const real = document.getElementById('grid-cafes');
      function swap() {
        if (sk) sk.style.display = 'none';
        if (real) real.classList.remove('hidden');
        const resultados = document.getElementById('resultados');
        if (resultados) resultados.focus();
      }
      if (document.readyState === 'complete') { swap(); }
      else { window.addEventListener('load', swap); setTimeout(swap, 2000); }
    })();

    </script>
{% endblock %}
