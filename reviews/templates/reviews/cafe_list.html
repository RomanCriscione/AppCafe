{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6 relative">
    <!-- Botón de Filtros para Mobile -->
  <button id="toggle-filtros" class="lg:hidden fixed bottom-4 right-4 z-50 bg-primary text-white p-3 rounded-full shadow-lg hover:bg-secondary transition">
    🔍 Filtros
  </button>
    <!-- Overlay (fondo oscuro al abrir filtros en mobile) -->
  <div id="filtros-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

  <!-- Filtros -->
  <aside id="panel-filtros" class="lg:static fixed top-0 left-0 h-full w-4/5 max-w-xs bg-white p-4 rounded-lg shadow-lg z-50 transform -translate-x-full transition-transform lg:translate-x-0 lg:w-1/4 lg:h-auto lg:shadow-none animate-fade-in">
  <!-- Encabezado para mobile -->
  <div class="flex justify-between items-center lg:hidden mb-4">
    <h2 class="text-xl font-semibold">🔍 Filtros</h2>
    <button id="cerrar-filtros" class="text-gray-600 hover:text-black text-2xl">&times;</button>
  </div>

  <!-- Formulario de filtros -->
  <form method="get" class="space-y-4">
    <div>
      <label for="zona" class="block font-medium">Zona:</label>
      <select name="zona" id="zona" class="w-full mt-1 p-2 border rounded">
        <option value="">Todas</option>
        {% for z in zonas_disponibles %}
          <option value="{{ z }}" {% if zona_seleccionada == z %}selected{% endif %}>{{ z }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="orden" class="block font-medium">Orden:</label>
      <select name="orden" id="orden" class="w-full mt-1 p-2 border rounded">
        <option value="algoritmo" {% if orden_actual == 'algoritmo' or not orden_actual %}selected{% endif %}>✨ Recomendadas</option>
        <option value="rating" {% if orden_actual == 'rating' %}selected{% endif %}>Puntuación</option>
        <option value="reviews" {% if orden_actual == 'reviews' %}selected{% endif %}>Más reseñas</option>
        <option value="" {% if orden_actual == '' %}selected{% endif %}>Nombre</option>
      </select>
    </div>

    <fieldset>
      <legend class="font-medium">Características:</legend>
      {% for key, label in caracteristicas %}
        <label class="block"><input type="checkbox" name="{{ key }}" {% if filtros_aplicados|get_item:key %}checked{% endif %}> {{ label }}</label>
      {% endfor %}
    </fieldset>

    <fieldset>
      <legend class="font-medium">Etiquetas:</legend>
      {% for tag in tags %}
        <label class="block">
          <input type="checkbox" name="tags" value="{{ tag.id }}" {% if tag.id in tags_seleccionados %}checked{% endif %}>
          {{ tag.name }}
        </label>
      {% endfor %}
    </fieldset>

    <button type="submit" class="mt-4 bg-primary text-white px-4 py-2 rounded hover:bg-secondary transition-colors">Aplicar filtros</button>
  </form>
</aside>

  <!-- Lista de Cafés -->
  <section class="lg:w-3/4">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Cafeterías</h1>
      <div class="flex gap-3 items-center">
        <form id="ubicacion-form" method="get" class="inline">
          <input type="hidden" name="orden" value="algoritmo">
          <input type="hidden" name="lat" id="lat">
          <input type="hidden" name="lon" id="lon">
          <button type="submit" class="bg-accent text-white px-3 py-2 rounded hover:bg-secondary transition-transform hover:scale-105">
            📍 Cafés cerca mío
          </button>
        </form>

        {% if mostrar_boton_reset %}
          <a href="{% url 'cafe_list' %}" class="inline-block bg-gray-200 text-gray-800 px-3 py-2 rounded hover:bg-gray-300 transition-colors">
            🔄 Ver todos los cafés
          </a>
        {% endif %}
      </div>
    </div>

    <div id="cafes-map" class="h-72 rounded mb-6"></div>

    {% if cafes %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for cafe in cafes %}
          <div class="relative bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 flex flex-col justify-between h-full min-h-[400px]">
            {% if cafe.id in favoritos_ids %}
              <span class="absolute top-2 right-2 text-red-500 text-xl animate-fade-in z-10">❤️</span>
            {% endif %}

            {% if cafe.photo1 %}
              <img src="{{ cafe.photo1.url }}" alt="Foto de {{ cafe.name }}"
              class="w-full h-52 aspect-[4/3] object-cover rounded-lg mb-4 transition-transform duration-300 transform hover:scale-105 hover:shadow-lg hover:opacity-90">
            {% else %}
              <div class="w-full h-52 bg-gray-200 flex items-center justify-center rounded-lg mb-4 text-gray-500 text-3xl">
                📷
              </div>
            {% endif %}

            <div class="flex-grow flex flex-col justify-between">
              <div>
                <h2 class="text-xl font-semibold flex items-center">
                  {{ cafe.name }}
                  <span class="ml-2 text-sm text-gray-500">({{ cafe.location }})</span>
                </h2>
                <p class="text-sm text-gray-600 mb-1">📍 {{ cafe.address }}</p>
                <p class="text-sm">☕ {{ cafe.average_rating|floatformat:1 }}</p>
              </div>

              <div class="mt-4">
                <a href="{% url 'cafe_detail' cafe.id %}" class="inline-block text-blue-600 hover:underline text-sm font-medium">Ver detalles</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      </div>
    {% else %}
      <div class="text-center text-lg text-gray-600 mt-8 space-y-4">
        <p>😕 No se encontraron cafeterías con los filtros seleccionados.</p>
        <a href="{% url 'cafe_list' %}" class="inline-block bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400 transition-colors">
          Limpiar filtros
        </a>
      </div>
    {% endif %}
  </section>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const map = L.map('cafes-map').setView([-34.6037, -58.3816], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const cafes = JSON.parse(`{{ cafes_json|escapejs }}`);

    cafes.forEach(cafe => {
      if (cafe.latitude && cafe.longitude) {
        const marker = L.marker([cafe.latitude, cafe.longitude]).addTo(map);
        const popupContent = `
          <strong>${cafe.name}</strong><br>
          <a href="${cafe.url}">Ver detalle</a>
        `;
        marker.bindPopup(popupContent);
      }
    });

    const urlParams = new URLSearchParams(window.location.search);
    const lat = urlParams.get("lat");
    const lon = urlParams.get("lon");

    if (lat && lon) {
      const userLat = parseFloat(lat);
      const userLon = parseFloat(lon); 

      const cafesCercanos = cafes.filter(cafe =>
        cafe.latitude && cafe.longitude &&
        Math.sqrt(
          Math.pow((cafe.latitude - userLat) * 111, 2) +
          Math.pow((cafe.longitude - userLon) * 85, 2)
        ) <= 3
      );

      const userMarker = L.marker([userLat, userLon], {
        icon: L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
          iconSize: [30, 30],
          iconAnchor: [15, 30],
          popupAnchor: [0, -30],
          className: 'animated-bounce'
        })
      }).addTo(map);

      userMarker.bindPopup(`📍 Estás aquí<br>${cafesCercanos.length} cafés cerca`).openPopup();

      const circle = L.circle([userLat, userLon], {
        radius: 3000,
        color: cafesCercanos.length > 10 ? "#e76f51" : "#2a9d8f",
        fillColor: cafesCercanos.length > 10 ? "#f4a261" : "#a8dadc",
        fillOpacity: 0.3
      }).addTo(map);

      map.setView([userLat, userLon], 13);
    }

  });

  const ubicacionForm = document.getElementById('ubicacion-form');
  if (ubicacionForm) {
    ubicacionForm.addEventListener('submit', function (e) {
      e.preventDefault();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          document.getElementById('lat').value = pos.coords.latitude;
          document.getElementById('lon').value = pos.coords.longitude;
          ubicacionForm.submit();
        }, () => {
          alert("No se pudo obtener tu ubicación.");
        });
      } else {
        alert("Tu navegador no soporta geolocalización.");
      }
    });
  }

  const panelFiltros = document.getElementById("panel-filtros");
  const btnAbrir = document.getElementById("toggle-filtros");
  const btnCerrar = document.getElementById("cerrar-filtros");

  
  if (btnCerrar) {
    btnCerrar.addEventListener("click", () => {
      panelFiltros.classList.add("-translate-x-full");
    });
  }

  const overlay = document.getElementById("filtros-overlay");

if (btnAbrir && panelFiltros && overlay) {
  btnAbrir.addEventListener("click", () => {
    panelFiltros.classList.remove("-translate-x-full");
    overlay.classList.remove("hidden");
  });

  btnCerrar.addEventListener("click", () => {
    panelFiltros.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
  });

  overlay.addEventListener("click", () => {
    panelFiltros.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
  });
}

</script>
{% endblock %}
