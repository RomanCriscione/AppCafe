{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6 relative px-4">
  <!-- Bot√≥n de Filtros para Mobile -->
  <button id="toggle-filtros" class="lg:hidden fixed bottom-4 right-4 z-50 bg-primary text-white p-3 rounded-full shadow-lg hover:bg-secondary transition">
    üîç Filtros
  </button>
  <!-- Overlay (fondo oscuro al abrir filtros en mobile) -->
  <div id="filtros-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0 transition-opacity duration-300 lg:hidden"></div>

  <!-- Filtros -->
  <aside id="panel-filtros" class="lg:static fixed top-0 left-0 h-full w-4/5 max-w-xs bg-white p-4 rounded-lg shadow-lg z-50 transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:w-1/4 lg:h-auto lg:shadow-none overflow-auto">
    <div class="flex justify-between items-center lg:hidden mb-4">
      <h2 class="text-xl font-semibold">üîç Filtros</h2>
      <button id="cerrar-filtros" class="text-gray-600 hover:text-black text-2xl">&times;</button>
    </div>

    <form method="get" class="space-y-4">
      <div>
        <label for="zona" class="block font-medium">Zona:</label>
        <select name="zona" id="zona" class="w-full mt-1 p-2 border rounded">
          <option value="">Todas</option>
          {% for z in zonas_disponibles %}
            <option value="{{ z }}" {% if zona_seleccionada == z %}selected{% endif %}>{{ z }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="orden" class="block font-medium">Orden:</label>
        <select name="orden" id="orden" class="w-full mt-1 p-2 border rounded">
          <option value="algoritmo" {% if orden_actual == 'algoritmo' or not orden_actual %}selected{% endif %}>‚ú® Recomendadas</option>
          <option value="rating" {% if orden_actual == 'rating' %}selected{% endif %}>Puntuaci√≥n</option>
          <option value="reviews" {% if orden_actual == 'reviews' %}selected{% endif %}>M√°s rese√±as</option>
          <option value="" {% if orden_actual == '' %}selected{% endif %}>Nombre</option>
        </select>
      </div>

      <fieldset>
        <legend class="font-medium mb-2">Etiquetas por percepci√≥n:</legend>
        {% for categoria, tags in tag_categorias.items %}
          <details class="mb-2">
            <summary class="cursor-pointer font-medium text-sm text-gray-700">{{ categoria|title }}</summary>
            <div class="pl-3 mt-1 space-y-1">
              {% for tag in tags %}
                <label class="flex items-center space-x-2 text-sm">
                  <input type="checkbox" name="tags" value="{{ tag.id }}" {% if tag.id in tags_seleccionados %}checked{% endif %}>
                  <span>{{ tag.name }}</span>
                </label>
              {% endfor %}
            </div>
          </details>
        {% endfor %}
      </fieldset>

      <fieldset>
        <legend class="font-medium">Etiquetas:</legend>
        {% for tag in tags %}
          <label class="block">
            <input type="checkbox" name="tags" value="{{ tag.id }}" {% if tag.id in tags_seleccionados %}checked{% endif %}>
            {{ tag.name }}
          </label>
        {% endfor %}
      </fieldset>

      <button type="submit" class="mt-4 bg-primary text-white px-4 py-2 rounded hover:bg-secondary transition-colors">Aplicar filtros</button>
    </form>
  </aside>

  <!-- Lista de Caf√©s -->
  <section class="lg:w-3/4 max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Cafeter√≠as</h1>
      <div class="flex gap-3 items-center">
        <form id="ubicacion-form" method="get" class="inline">
          <input type="hidden" name="orden" value="algoritmo">
          <input type="hidden" name="lat" id="lat">
          <input type="hidden" name="lon" id="lon">
          <button type="submit" class="bg-accent text-white px-3 py-2 rounded text-sm hover:bg-secondary transition-transform hover:scale-105">
            üìç Caf√©s cerca m√≠o
          </button>

        </form>

        {% if mostrar_boton_reset %}
          <a href="{% url 'cafe_list' %}" class="inline-block bg-gray-200 text-gray-800 px-3 py-2 rounded hover:bg-gray-300 transition-colors">
            üîÑ Ver todos los caf√©s
          </a>
        {% endif %}
      </div>
    </div>

{% include "reviews/includes/mapa_cafe_list.html" %}

<div class="grid md:grid-cols-2 lg:grid-cols-2 gap-6 mt-6">
  {% for cafe in cafes %}
    <div class="bg-white rounded-lg shadow hover:shadow-md p-4 transition duration-200">
      <a href="{% url 'cafe_detail' cafe.id %}" class="block">
        {% if cafe.photo1 %}
          <img src="{{ cafe.photo1.url }}" alt="{{ cafe.name }}" class="w-full h-40 object-cover rounded-md mb-3">
        {% else %}
          <div class="w-full h-40 bg-gray-200 flex items-center justify-center text-gray-500 rounded-md mb-3">
            Sin foto
          </div>
        {% endif %}

        <h3 class="text-lg font-semibold text-gray-800">{{ cafe.name }}</h3>
        <p class="text-sm text-gray-600">{{ cafe.location }}</p>
        <p class="text-yellow-500 text-sm mt-1">‚òï {{ cafe.average_rating|floatformat:1 }}/5</p>
      </a>

      {% with tag_data|get_item:cafe.id as grouped_tags %}
        {% if grouped_tags %}
          <div class="mt-3">
            <h4 class="text-sm font-semibold mb-1 text-gray-700">ü™Ñ C√≥mo lo perciben los visitantes:</h4>
            {% for category, tags in grouped_tags.items %}
              <div class="mb-1">
                <p class="text-xs font-medium text-gray-600">{{ category|title }}</p>
                <div class="flex flex-wrap gap-2 mt-1">
                  {% for tag in tags|slice:":5" %}
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                      {{ tag.name }} ({{ tag.count }})
                    </span>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>
  {% endfor %}
</div>


    </section>
  </div>
{% endblock %}
