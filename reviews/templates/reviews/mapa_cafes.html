{% extends "base.html" %}
{% load static %}

{% block title %}Mapa de CafÃ©s{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4">
    <h1 class="text-2xl font-bold mb-4">ğŸ—ºï¸ Mapa interactivo de CafÃ©s</h1>

    <div class="flex flex-wrap gap-4 mb-4">
        <button onclick="filtrarCafesCercanos()" class="px-4 py-2 bg-primary text-white rounded hover:bg-secondary transition">
            Ver cafÃ©s cerca mÃ­o (3km)
        </button>
        <button onclick="verTodosLosCafes()" class="px-4 py-2 bg-gray-300 text-black rounded hover:bg-gray-400 transition">
            ğŸ”„ Ver todos los cafÃ©s
        </button>
    </div>

    <div id="map" class="w-full h-[600px] rounded shadow-lg"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const cafes = {{ cafes_json|safe }};
    const map = L.map('map').setView([-34.6037, -58.3816], 12);
    let markers = [];
    let circle = null;
    let userMarker = null;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    function agregarMarcadores(lista) {
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        lista.forEach(cafe => {
            if (cafe.latitude && cafe.longitude) {
                const popup = `<strong>${cafe.name}</strong><br>${cafe.address}<br><a href="/reviews/${cafe.id}/" class="text-blue-500 underline">Ver mÃ¡s</a>`;
                const marker = L.marker([cafe.latitude, cafe.longitude]).bindPopup(popup).addTo(map);
                markers.push(marker);
            }
        });
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function filtrarCafesCercanos() {
        if (!navigator.geolocation) {
            alert("Tu navegador no soporta geolocalizaciÃ³n.");
            return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            // Marcar usuario
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([lat, lon], {
                icon: L.icon({
                        iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
                        iconSize: [30, 30],
                        iconAnchor: [15, 30],
                        popupAnchor: [0, -30]
                })
            }).addTo(map).bindPopup("ğŸ“ EstÃ¡s aquÃ­").openPopup();

            // Dibujar cÃ­rculo
            if (circle) map.removeLayer(circle);
            circle = L.circle([lat, lon], {
                radius: 3000,
                color: "#2a9d8f",
                fillColor: "#a8dadc",
                fillOpacity: 0.3
            }).addTo(map);

            // Filtrar cafÃ©s
            const cercanos = cafes.filter(c => {
                if (!c.latitude || !c.longitude) return false;
                return calcularDistancia(lat, lon, c.latitude, c.longitude) <= 3;
            });

            map.setView([lat, lon], 14);
            agregarMarcadores(cercanos);
        }, () => {
            alert("No se pudo obtener tu ubicaciÃ³n.");
        });
    }

    function verTodosLosCafes() {
        if (userMarker) map.removeLayer(userMarker);
        if (circle) map.removeLayer(circle);
        map.setView([-34.6037, -58.3816], 12);
        agregarMarcadores(cafes);
    }

    agregarMarcadores(cafes);
</script>
{% endblock %}
