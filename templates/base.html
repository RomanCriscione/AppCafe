<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Preconnect / DNS-Prefetch (perf) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
  <link rel="dns-prefetch" href="https://tile.openstreetmap.org">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

  {% block head_title %}<title>{{ meta_title|default:"Gota - Rese√±as de Caf√©s" }}</title>{% endblock %}
  {% block head_description %}<meta name="description" content="{{ meta_description|default:'Descubr√≠ cafeter√≠as, rese√±as reales y mapas.' }}">{% endblock %}
  {% block meta %}{% endblock %}

  <!-- CSS (orden recomendado) -->
  <link rel="stylesheet" href="{% static 'css/animations.css' %}?v=1">
  <!-- Tailwind compilado por npm (NO usar CDN) -->
  <link rel="stylesheet" href="{% static 'css/app.css' %}?v=1">
  <!-- Fuentes y libs de terceros -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:opsz,wght@9..144,300;9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <!-- Tu theme, siempre √∫ltimo para poder sobreescribir -->
  <link rel="stylesheet" href="{% static 'css/custom.css' %}?v=1">

  <!-- PWA / Icons -->
  <link rel="manifest" href="{% static 'site.webmanifest' %}">
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#553A2F">
  <link rel="icon" href="{% static 'images/coffee-icon.png' %}">
  <link rel="apple-touch-icon" sizes="192x192" href="{% static 'images/coffee-icon.png' %}">
  <link rel="canonical" href="{{ request.build_absolute_uri }}">

  <!-- Open Graph defaults -->
  <meta property="og:title" content="{{ page_title|default:'Gota ‚Äî Descubr√≠ tu pr√≥ximo caf√©' }}">
  <meta property="og:description" content="{{ page_description|default:'Encontr√° caf√©s por zona, estilo y experiencia.' }}">
  {% if og_image_url %}
    <meta property="og:image" content="{{ og_image_url }}">
  {% else %}
    <meta property="og:image" content="{% static 'images/og-default.jpg' %}">
  {% endif %}
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Chart.js (si lo us√°s en alguna vista) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>

<body class="page">
  <div class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="site-nav bg-white/90 backdrop-blur border-b border-slate-200 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <!-- Izquierda: marca + Volver (solo ‚â• sm) -->
        <div class="flex items-center gap-2 sm:gap-4">
          <a href="{% url 'home' %}" class="text-2xl font-bold text-brand-800">Gota</a>

          <!-- Volver: oculto en mobile, visible fuera de Home -->
          <a id="back-link"
            href="{% url 'reviews:cafe_list' %}"
            data-fallback="{% url 'reviews:cafe_list' %}"
            class="btn btn-ghost rounded-xl text-sm hidden sm:inline-flex">
            ‚Üê Volver
          </a>
        </div>

        <!-- Bot√≥n men√∫ (solo mobile) -->
        <button id="menu-toggle"
                class="lg:hidden p-2 rounded-xl text-slate-700"
                aria-label="Abrir men√∫" aria-expanded="false" aria-controls="nav-mobile">
          <i class="fas fa-bars text-xl" aria-hidden="true"></i>
        </button>

        <!-- Navegaci√≥n desktop -->
        <nav id="nav-desktop" class="hidden lg:flex items-center gap-2">
          <a href="{% url 'home' %}" class="nav-link">Inicio</a>
          <a href="{% url 'reviews:cafe_list' %}" class="nav-link">Caf√©s</a>
          <a href="{% url 'reviews:mapa_cafes' %}" class="nav-link">üìç Mapa</a>
          <a href="{% url 'about' %}" class="nav-link">Acerca de</a>
          <a href="{% url 'contact' %}" class="nav-link">Contacto</a>
          {% if user.is_authenticated %}
            <a href="{% url 'reviews:favorite_cafes' %}" class="nav-link">‚ù§Ô∏è Favoritos</a>
            {% if user.is_owner %}
              <a href="{% url 'reviews:create_cafe' %}" class="btn btn-ghost">‚ûï Agregar Caf√©</a>
              <a href="{% url 'reviews:owner_dashboard' %}" class="btn btn-ghost">Mis Caf√©s</a>
            {% else %}
              <a href="{% url 'register_owner' %}" class="btn btn-success">
                <i class="fas fa-coffee text-sm"></i> Registrar tu caf√©
              </a>
            {% endif %}
            <a href="{% url 'account_logout' %}" class="btn btn-danger btn-sm">Cerrar sesi√≥n</a>
          {% else %}
            <a href="{% url 'account_login' %}" class="btn btn-ghost">Iniciar sesi√≥n</a>
            <a href="{% url 'account_signup' %}" class="btn btn-primary">Registrarse</a>
            <a href="{% url 'register_owner' %}" class="btn btn-success">
              <i class="fas fa-coffee text-sm"></i> Registrar tu caf√©
            </a>
          {% endif %}
        </nav>
      </div>

      <!-- Overlay + men√∫ m√≥vil -->
      <div id="nav-overlay" class="hidden lg:hidden fixed inset-0 bg-black/30 z-40"></div>

      <nav id="nav-mobile"
          class="hidden lg:hidden fixed inset-x-0 top-[56px] z-50 bg-white/95 backdrop-blur border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 grid gap-3">
          <a href="{% url 'home' %}" class="nav-link block py-2">Inicio</a>
          <a href="{% url 'reviews:cafe_list' %}" class="nav-link block py-2">Caf√©s</a>
          <a href="{% url 'reviews:mapa_cafes' %}" class="nav-link block py-2">üìç Mapa</a>
          <a href="{% url 'about' %}" class="nav-link block py-2">Acerca de</a>
          <a href="{% url 'contact' %}" class="nav-link block py-2">Contacto</a>

          <hr class="my-2">

          {% if user.is_authenticated %}
            <a href="{% url 'reviews:favorite_cafes' %}" class="block py-2">‚ù§Ô∏è Favoritos</a>
            {% if user.is_owner %}
              <a href="{% url 'reviews:create_cafe' %}" class="block py-2">‚ûï Agregar Caf√©</a>
              <a href="{% url 'reviews:owner_dashboard' %}" class="block py-2">Mis Caf√©s</a>
            {% else %}
              <a href="{% url 'register_owner' %}" class="block py-2">‚òï Registrar tu caf√©</a>
            {% endif %}
            <a href="{% url 'account_logout' %}" class="block py-2">Cerrar sesi√≥n</a>
          {% else %}
            <a href="{% url 'account_login' %}" class="block py-2">Iniciar sesi√≥n</a>
            <a href="{% url 'account_signup' %}" class="block py-2">Registrarse</a>
            <a href="{% url 'register_owner' %}" class="block py-2">‚òï Registrar tu caf√©</a>
          {% endif %}
        </div>
      </nav>
    </header>


        <!-- JS: toggle men√∫ m√≥vil, estado scrolleado y bot√≥n Volver -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      const toggle = document.getElementById("menu-toggle");
      const mobile = document.getElementById("nav-mobile");
      const overlay = document.getElementById("nav-overlay");

      function openMenu() {
        mobile.classList.remove("hidden");
        overlay.classList.remove("hidden");
        toggle.setAttribute("aria-expanded", "true");
      }
      function closeMenu() {
        mobile.classList.add("hidden");
        overlay.classList.add("hidden");
        toggle.setAttribute("aria-expanded", "false");
      }
      toggle?.addEventListener("click", () => {
        const isOpen = !mobile.classList.contains("hidden");
        isOpen ? closeMenu() : openMenu();
      });
      overlay?.addEventListener("click", closeMenu);
      window.addEventListener("resize", () => {
        if (window.innerWidth >= 1024) closeMenu(); // auto-cierra al pasar a desktop
      });

      // ---- Bot√≥n Volver: oculto en Home y en xs
      const back = document.getElementById("back-link");
      if (back) {
        const homePath = "{% url 'home' %}";
        const isHome = (location.pathname === homePath) || (location.pathname === "/");
        if (!isHome && window.innerWidth >= 640) back.classList.remove("hidden");

        back.addEventListener("click", (e) => {
          const ref = document.referrer || "";
          let sameOrigin = false;
          try { sameOrigin = ref && new URL(ref, location.origin).origin === location.origin; } catch {}
          if (sameOrigin && history.length > 1) { e.preventDefault(); history.back(); }
        });
      }
    });
    </script>


    <!-- Contenido principal -->
    <main class="flex-1 container mx-auto px-4 py-6">
      {% if messages %}
        <div class="fixed top-4 right-4 z-[2147483000] space-y-2">
          {% for message in messages %}
            <div class="px-4 py-2 rounded shadow text-white alert-message
                        {% if message.tags == 'success' %} bg-green-600
                        {% elif message.tags == 'error' %} bg-red-600
                        {% else %} bg-blue-600 {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>

    <footer class="bg-white border-t py-4 text-center text-sm text-slate-500">
      ¬© 2025 Gota ‚Äì Una app de Roma ‚òï
    </footer>
  </div>

  <!-- JS externos (defer) -->
  <script defer src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script defer src="{% static 'js/main.js' %}"></script>

  <!-- Helpers UI: fade entre p√°ginas, init swiper, toasts y efecto like -->
  <script>
    // Fade entre p√°ginas (ignora anclas, externos y enlaces con data-no-fade)
    (function () {
      const root = document.body;
      function markReady() {
        if (root.classList.contains('page')) root.classList.add('page-ready');
      }

      // Asegur√° visibilidad al cargar o al volver desde bfcache
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        markReady();
      } else {
        document.addEventListener('DOMContentLoaded', markReady, { once: true });
      }
      // Cuando se muestra desde bfcache (back/forward), re-agregar la clase
      window.addEventListener('pageshow', function () { markReady(); });

      // Al navegar: fade-out en enlaces internos (salvo anclas/externos/no-fade)
      document.querySelectorAll('a[href]').forEach(a => {
        const href = a.getAttribute('href');
        const isAnchor   = href && href.startsWith('#');
        const isExternal = a.target === '_blank'
                        || a.hasAttribute('download')
                        || (href && /^https?:\/\//.test(href) && !href.includes(location.host));
        const noFade = a.hasAttribute('data-no-fade'); // respeta el bot√≥n Volver
        if (isAnchor || isExternal || noFade) return;

        a.addEventListener('click', (e) => {
          if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
          root.classList.remove('page-ready');
        });
      });
    })();

    // Swiper b√°sico + desaparecer alerts
    document.addEventListener('DOMContentLoaded', function () {
      if (document.querySelector('.swiper-container')) {
        new Swiper('.swiper-container', {
          slidesPerView: 'auto',
          spaceBetween: 16,
          navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
          pagination: { el: '.swiper-pagination', clickable: true },
        });
      }
      document.querySelectorAll('.alert-message').forEach(alert => {
        setTimeout(() => {
          alert.classList.add('opacity-0', 'transition-opacity', 'duration-500');
          setTimeout(() => alert.remove(), 500);
        }, 2000);
      });
    });

    // Helper global para animar el like (rebote)
    window.bounceLike = (el) => {
      if (!el) return;
      el.classList.remove('like-bounce');
      void el.offsetWidth; // reflow
      el.classList.add('like-bounce');
    };
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
