<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">

  {% block head_title %}<title>{{ meta_title|default:"Gota - Rese√±as de Caf√©s" }}</title>{% endblock %}
  {% block head_description %}<meta name="description" content="{{ meta_description|default:'Descubr√≠ cafeter√≠as, rese√±as reales y mapas.' }}">{% endblock %}
  {% block meta %}{% endblock %}

  <!-- CSS -->
  <link rel="stylesheet" href="{% static 'css/animations.css' %}?v=1">
  <link rel="stylesheet" href="{% static 'css/app.css' %}?v=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <link rel="stylesheet" href="{% static 'css/custom.css' %}?v=1">

  <!-- Icons / PWA -->
  <link rel="icon" href="{% static 'images/coffee-icon.png' %}">
  <meta name="theme-color" content="#553A2F">
  <link rel="canonical" href="{{ request.build_absolute_uri }}">

  <!-- OG -->
  <meta property="og:title" content="{{ page_title|default:'Gota ‚Äî Descubr√≠ tu pr√≥ximo caf√©' }}">
  <meta property="og:description" content="{{ page_description|default:'Encontr√° caf√©s por zona, estilo y experiencia.' }}">
  <meta property="og:image" content="{% if og_image_url %}{{ og_image_url }}{% else %}{% static 'images/og-default.jpg' %}{% endif %}">
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
  <meta name="twitter:card" content="summary_large_image">

  <!-- (Opcional) Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <!-- Anti-scroll cuando el men√∫ est√° abierto -->
  <style>
    .no-scroll { overflow: hidden; }
    /* Evita parpadeos: el panel empieza hidden sin transiciones */
    #mobile-panel { display: none; }
    #mobile-overlay { display: none; }
    .mobile-open #mobile-panel { display: block; }
    .mobile-open #mobile-overlay { display: block; }
  </style>
</head>

<body class="page">
  <div class="min-h-screen flex flex-col">

    <!-- NAVBAR -->
    <header class="bg-white/90 backdrop-blur border-b border-slate-200 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 py-2 sm:py-3 flex items-center justify-between">
        <div class="flex items-center gap-2 sm:gap-4">
          <a href="{% url 'home' %}" class="text-2xl font-bold text-brand-800">Gota</a>

          <!-- Volver: oculto por defecto; solo ‚â•768px y fuera de Home -->
          <a id="back-link"
             href="{% url 'reviews:cafe_list' %}"
             class="btn btn-ghost rounded-xl text-sm hidden md:inline-flex"
             style="display:none">‚Üê Volver</a>
        </div>

        <!-- Hamburguesa -->
        <button id="menu-toggle"
                class="lg:hidden p-2 rounded-xl text-slate-700"
                type="button" aria-label="Abrir men√∫" aria-expanded="false">
          <!-- √≠cono simple (sin fontawesome para evitar cargas extra) -->
          <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>

        <!-- Navegaci√≥n desktop -->
        <nav class="hidden lg:flex items-center gap-2">
          <a href="{% url 'home' %}" class="nav-link">Inicio</a>
          <a href="{% url 'reviews:cafe_list' %}" class="nav-link">Caf√©s</a>
          <a href="{% url 'reviews:mapa_cafes' %}" class="nav-link">üìç Mapa</a>
          <a href="{% url 'about' %}" class="nav-link">Acerca de</a>
          <a href="{% url 'contact' %}" class="nav-link">Contacto</a>
          {% if user.is_authenticated %}
            <a href="{% url 'reviews:favorite_cafes' %}" class="nav-link">‚ù§Ô∏è Favoritos</a>
            {% if user.is_owner %}
              <a href="{% url 'reviews:create_cafe' %}" class="btn btn-ghost">‚ûï Agregar Caf√©</a>
              <a href="{% url 'reviews:owner_dashboard' %}" class="btn btn-ghost">Mis Caf√©s</a>
            {% else %}
              <a href="{% url 'register_owner' %}" class="btn btn-success">Registrar tu caf√©</a>
            {% endif %}
            <a href="{% url 'account_logout' %}" class="btn btn-danger btn-sm">Cerrar sesi√≥n</a>
          {% else %}
            <a href="{% url 'account_login' %}" class="btn btn-ghost">Iniciar sesi√≥n</a>
            <a href="{% url 'account_signup' %}" class="btn btn-primary">Registrarse</a>
            <a href="{% url 'register_owner' %}" class="btn btn-success">Registrar tu caf√©</a>
          {% endif %}
        </nav>
      </div>
    </header>

    <!-- OVERLAY + PANEL MOBILE (full screen, fuera del header) -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black/45 z-[9998]"></div>

    <nav id="mobile-panel" class="fixed inset-0 z-[9999] bg-white overflow-y-auto lg:hidden" aria-hidden="true">
      <div class="px-5 py-4 flex items-center justify-between border-b">
        <span class="font-semibold">Men√∫</span>
        <button id="menu-close" class="p-2 rounded-xl" type="button" aria-label="Cerrar men√∫">
          <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="p-5 grid gap-3 text-lg">
        <a href="{% url 'home' %}" class="block py-2">Inicio</a>
        <a href="{% url 'reviews:cafe_list' %}" class="block py-2">Caf√©s</a>
        <a href="{% url 'reviews:mapa_cafes' %}" class="block py-2">üìç Mapa</a>
        <a href="{% url 'about' %}" class="block py-2">Acerca de</a>
        <a href="{% url 'contact' %}" class="block py-2">Contacto</a>
        <hr class="my-2">
        {% if user.is_authenticated %}
          <a href="{% url 'reviews:favorite_cafes' %}" class="block py-2">‚ù§Ô∏è Favoritos</a>
          {% if user.is_owner %}
            <a href="{% url 'reviews:create_cafe' %}" class="block py-2">‚ûï Agregar Caf√©</a>
            <a href="{% url 'reviews:owner_dashboard' %}" class="block py-2">Mis Caf√©s</a>
          {% else %}
            <a href="{% url 'register_owner' %}" class="block py-2">‚òï Registrar tu caf√©</a>
          {% endif %}
          <a href="{% url 'account_logout' %}" class="block py-2">Cerrar sesi√≥n</a>
        {% else %}
          <a href="{% url 'account_login' %}" class="block py-2">Iniciar sesi√≥n</a>
          <a href="{% url 'account_signup' %}" class="block py-2">Registrarse</a>
          <a href="{% url 'register_owner' %}" class="block py-2">‚òï Registrar tu caf√©</a>
        {% endif %}
      </div>
    </nav>

    <!-- JS: men√∫ mobile + Volver (a prueba de reentradas) -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const body    = document.body;
        const toggle  = document.getElementById("menu-toggle");
        const panel   = document.getElementById("mobile-panel");
        const overlay = document.getElementById("mobile-overlay");
        const closeBt = document.getElementById("menu-close");
        let busy = false;   // evita abrir/cerrar m√∫ltiples veces

        function openMenu() {
          if (busy || body.classList.contains("mobile-open")) return;
          busy = true;
          body.classList.add("mobile-open","no-scroll");
          toggle?.setAttribute("aria-expanded","true");
          panel.setAttribute("aria-hidden","false");
          busy = false;
        }
        function closeMenu() {
          if (busy || !body.classList.contains("mobile-open")) return;
          busy = true;
          body.classList.remove("mobile-open","no-scroll");
          toggle?.setAttribute("aria-expanded","false");
          panel.setAttribute("aria-hidden","true");
          busy = false;
        }

        toggle?.addEventListener("click", openMenu);
        closeBt?.addEventListener("click", closeMenu);
        overlay?.addEventListener("click", closeMenu);
        panel?.addEventListener("click", (e) => {
          const a = e.target.closest("a[href]");
          if (a) closeMenu();
        });
        window.addEventListener("resize", () => { if (window.innerWidth >= 1024) closeMenu(); });

        // ---- Bot√≥n Volver (solo ‚â•768px y no Home)
        const back = document.getElementById("back-link");
        if (back) {
          const homePath = "{% url 'home' %}";
          const isHome = (location.pathname === homePath) || (location.pathname === "/");
          function syncBack() {
            const wide = window.matchMedia("(min-width: 768px)").matches;
            const show = wide && !isHome;
            back.style.display = show ? "inline-flex" : "none";
            back.classList.toggle("hidden", !show);
          }
          syncBack();
          window.addEventListener("resize", syncBack);
          back.addEventListener("click", (e) => {
            const ref = document.referrer || "";
            let sameOrigin = false;
            try { sameOrigin = ref && new URL(ref, location.origin).origin === location.origin; } catch {}
            if (sameOrigin && history.length > 1) { e.preventDefault(); history.back(); }
          });
        }
      });
    </script>

    <!-- CONTENIDO -->
    <main class="flex-1 container mx-auto px-4 py-6">
      {% if messages %}
        <div class="fixed top-4 right-4 z-[2147483000] space-y-2">
          {% for message in messages %}
            <div class="px-4 py-2 rounded shadow text-white alert-message
                        {% if message.tags == 'success' %} bg-green-600
                        {% elif message.tags == 'error' %} bg-red-600
                        {% else %} bg-blue-600 {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>

    <footer class="bg-white border-t py-4 text-center text-sm text-slate-500">
      ¬© 2025 Gota ‚Äì Una app de Roma ‚òï
    </footer>
  </div>

  <!-- JS externos -->
  <script defer src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script defer src="{% static 'js/main.js' %}"></script>

  <!-- Helpers (fade + toasts) -->
  <script>
    (function () {
      const root = document.body;
      function markReady(){ if (root.classList.contains('page')) root.classList.add('page-ready'); }
      if (document.readyState === 'complete' || document.readyState === 'interactive') markReady();
      else document.addEventListener('DOMContentLoaded', markReady, { once:true });
      window.addEventListener('pageshow', markReady);

      document.querySelectorAll('a[href]').forEach(a=>{
        const href=a.getAttribute('href');
        const isAnchor = href && href.startsWith('#');
        const isExternal = a.target==='_blank'||a.hasAttribute('download')||(href&&/^https?:\/\//.test(href)&&!href.includes(location.host));
        const noFade = a.hasAttribute('data-no-fade');
        if (isAnchor||isExternal||noFade) return;
        a.addEventListener('click', (e)=>{ if(!(e.metaKey||e.ctrlKey||e.shiftKey||e.altKey)) root.classList.remove('page-ready'); });
      });
    })();

    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.alert-message').forEach(alert => {
        setTimeout(()=>{ alert.classList.add('opacity-0','transition-opacity','duration-500'); setTimeout(()=>alert.remove(),500); }, 2000);
      });
    });

    // Rebote like
    window.bounceLike = (el) => { if (!el) return; el.classList.remove('like-bounce'); void el.offsetWidth; el.classList.add('like-bounce'); };
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
